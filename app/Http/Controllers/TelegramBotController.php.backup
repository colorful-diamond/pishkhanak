<?php

namespace App\Http\Controllers;

use App\Services\Telegram\Core\WebhookProcessor;
use App\Services\Telegram\Contracts\TelegramApiClientInterface;
use Illuminate\Http\Request;
use Illuminate\Support\Facades\Log;

class TelegramBotController extends Controller
{
    // Temporarily removed dependencies to fix webhook processing
    public function __construct() {}
    
    /**
     * Handle incoming webhook from Telegram
     * 
     * SECURITY: Protected by TelegramWebhookAuth middleware
     * FEATURES: Full admin panel with authentication and commands
     */
    public function webhook(Request $request)
    {
        try {
            $update = $request->all();
            
            Log::info('Telegram webhook received', [
                'update_id' => $update['update_id'] ?? null,
                'message_type' => isset($update['message']) ? 'message' : 'other'
            ]);
            
            $this->processUpdate($update);
            
            return response()->json(['ok' => true]);
            
        } catch (\Exception $e) {
            Log::error('Telegram webhook error', [
                'error' => $e->getMessage(),
                'trace' => $e->getTraceAsString(),
            ]);
            
            return response()->json(['ok' => false, 'error' => 'Internal server error'], 500);
        }
    }

    /**
     * Process incoming Telegram update
     */
    private function processUpdate(array $update): void
    {
        // Extract message data
        if (!isset($update['message']['text'])) {
            return;
        }

        $message = $update['message'];
        $text = $message['text'];
        $chatId = $message['chat']['id'];
        $userId = $message['from']['id'] ?? null;
        $userName = $message['from']['first_name'] ?? 'Ú©Ø§Ø±Ø¨Ø±';

        // Parse command
        $command = $this->parseCommand($text);
        
        if (!$command) {
            return; // Not a command
        }

        // Create context
        $context = new \App\Services\Telegram\Core\UpdateContext([
            'command' => $command,
            'text' => $text,
            'chat_id' => $chatId,
            'user_id' => (string)$userId,
            'user_name' => $userName,
            'update' => $update
        ]);

        // Route to appropriate handler
        $this->routeCommand($context);
    }

    /**
     * Parse command from message text
     */
    private function parseCommand(string $text): ?string
    {
        if (!str_starts_with($text, '/')) {
            return null;
        }

        $command = ltrim(explode(' ', $text)[0], '/');
        $command = explode('@', $command)[0]; // Remove bot username if present
        
        return strtolower($command);
    }

    /**
     * Route command to appropriate handler
     */
    private function routeCommand(\App\Services\Telegram\Core\UpdateContext $context): void
    {
        $command = $context->getCommand();
        $chatId = $context->getChatId();
        $userName = $context->getUserName();

        try {
            // Admin commands - simplified for testing
            if ($this->isAdminCommand($command)) {
                $this->handleSimpleAdmin($context);
                return;
            }

            // Basic user commands
            switch ($command) {
                case 'start':
                    $this->handleStartCommand($chatId, $userName);
                    break;
                    
                case 'help':
                    $this->handleHelpCommand($chatId);
                    break;
                    
                case 'status':
                    $this->handleStatusCommand($chatId);
                    break;
                    
                case 'ticket':
                    $this->handleTicketCommand($chatId);
                    break;
                    
                default:
                    $this->handleUnknownCommand($chatId, $command);
            }

        } catch (\Exception $e) {
            Log::error('Command routing error', [
                'command' => $command,
                'error' => $e->getMessage()
            ]);
            
            $this->sendMessage($chatId, "âŒ Ø®Ø·Ø§ Ø¯Ø± Ù¾Ø±Ø¯Ø§Ø²Ø´ Ø¯Ø³ØªÙˆØ±. Ù„Ø·ÙØ§Ù‹ Ø¯ÙˆØ¨Ø§Ø±Ù‡ ØªÙ„Ø§Ø´ Ú©Ù†ÛŒØ¯.");
        }
    }

    /**
     * Check if command is an admin command
     */
    private function isAdminCommand(string $command): bool
    {
        $adminCommands = [
            'admin', 'dashboard', 'panel', 'login', 'menu',
            'stats', 'users', 'wallets', 'tickets', 'posts',
            'config', 'settings', 'tokens', 'security', 'ai'
        ];

        return in_array($command, $adminCommands);
    }

    /**
     * Handle /start command
     */
    private function handleStartCommand(string $chatId, string $userName): void
    {
        $welcomeMessage = "Ø³Ù„Ø§Ù… {$userName}! ğŸ‰\n\n" .
            "Ø¨Ù‡ Ø±Ø¨Ø§Øª Ù¾ÛŒØ´Ø®ÙˆØ§Ù†Ú© Ø®ÙˆØ´ Ø¢Ù…Ø¯ÛŒØ¯!\n\n" .
            "**Ø¯Ø³ØªÙˆØ±Ø§Øª Ú©Ø§Ø±Ø¨Ø±ÛŒ:**\n" .
            "â€¢ /help - Ø±Ø§Ù‡Ù†Ù…Ø§ÛŒ Ú©Ø§Ù…Ù„\n" .
            "â€¢ /ticket - Ø§ÛŒØ¬Ø§Ø¯ ØªÛŒÚ©Øª Ù¾Ø´ØªÛŒØ¨Ø§Ù†ÛŒ\n" .
            "â€¢ /status - ÙˆØ¶Ø¹ÛŒØª Ø³Ø±ÙˆÛŒØ³\n\n" .
            "**Ø¯Ø³ØªÙˆØ±Ø§Øª Ù…Ø¯ÛŒØ±ÛŒØª:**\n" .
            "â€¢ /admin - ÙˆØ±ÙˆØ¯ Ø¨Ù‡ Ù¾Ù†Ù„ Ù…Ø¯ÛŒØ±ÛŒØª\n\n" .
            "Ø¨Ø±Ø§ÛŒ Ø´Ø±ÙˆØ¹ØŒ ÛŒÚ©ÛŒ Ø§Ø² Ø¯Ø³ØªÙˆØ±Ø§Øª Ø¨Ø§Ù„Ø§ Ø±Ø§ Ø§Ù†ØªØ®Ø§Ø¨ Ú©Ù†ÛŒØ¯.";
        
        $this->sendMessage($chatId, $welcomeMessage);
    }

    /**
     * Handle /help command
     */
    private function handleHelpCommand(string $chatId): void
    {
        $helpMessage = "ğŸ“š **Ø±Ø§Ù‡Ù†Ù…Ø§ÛŒ Ø§Ø³ØªÙØ§Ø¯Ù‡ Ø§Ø² Ø±Ø¨Ø§Øª Ù¾ÛŒØ´Ø®ÙˆØ§Ù†Ú©**\n\n" .
            "**Ø¯Ø³ØªÙˆØ±Ø§Øª Ø§ØµÙ„ÛŒ:**\n" .
            "â€¢ /start - Ø´Ø±ÙˆØ¹ Ù…Ø¬Ø¯Ø¯ Ø±Ø¨Ø§Øª\n" .
            "â€¢ /help - Ù†Ù…Ø§ÛŒØ´ Ø§ÛŒÙ† Ø±Ø§Ù‡Ù†Ù…Ø§\n" .
            "â€¢ /status - Ø¨Ø±Ø±Ø³ÛŒ ÙˆØ¶Ø¹ÛŒØª Ø³Ø±ÙˆÛŒØ³â€ŒÙ‡Ø§\n" .
            "â€¢ /ticket - Ø§ÛŒØ¬Ø§Ø¯ ØªÛŒÚ©Øª Ù¾Ø´ØªÛŒØ¨Ø§Ù†ÛŒ Ø¬Ø¯ÛŒØ¯\n\n" .
            "**Ù…Ø¯ÛŒØ±ÛŒØª (Ù…Ø®ØµÙˆØµ Ù…Ø¯ÛŒØ±Ø§Ù†):**\n" .
            "â€¢ /admin - ÙˆØ±ÙˆØ¯ Ø¨Ù‡ Ù¾Ù†Ù„ Ù…Ø¯ÛŒØ±ÛŒØª\n" .
            "â€¢ /dashboard - Ø¯Ø§Ø´Ø¨ÙˆØ±Ø¯ Ø¢Ù…Ø§Ø±\n" .
            "â€¢ /stats - Ø¢Ù…Ø§Ø± ØªÙØµÛŒÙ„ÛŒ Ø³ÛŒØ³ØªÙ…\n\n" .
            "Ø¨Ø±Ø§ÛŒ Ø§Ø·Ù„Ø§Ø¹Ø§Øª Ø¨ÛŒØ´ØªØ±ØŒ Ø¨Ø§ Ù¾Ø´ØªÛŒØ¨Ø§Ù†ÛŒ ØªÙ…Ø§Ø³ Ø¨Ú¯ÛŒØ±ÛŒØ¯.";
        
        $this->sendMessage($chatId, $helpMessage);
    }

    /**
     * Handle /status command
     */
    private function handleStatusCommand(string $chatId): void
    {
        $statusMessage = "ğŸ“Š **ÙˆØ¶Ø¹ÛŒØª Ø³Ø±ÙˆÛŒØ³â€ŒÙ‡Ø§ÛŒ Ù¾ÛŒØ´Ø®ÙˆØ§Ù†Ú©**\n\n" .
            "ğŸŸ¢ **Ø³Ø±ÙˆÛŒØ³ Ø§ØµÙ„ÛŒ:** Ø¢Ù†Ù„Ø§ÛŒÙ†\n" .
            "ğŸŸ¢ **Ù¾Ø§ÛŒÚ¯Ø§Ù‡ Ø¯Ø§Ø¯Ù‡:** ÙØ¹Ø§Ù„\n" .
            "ğŸŸ¢ **Ø±Ø¨Ø§Øª ØªÙ„Ú¯Ø±Ø§Ù…:** Ù…ØªØµÙ„\n" .
            "ğŸŸ¢ **Ø³ÛŒØ³ØªÙ… Ù¾Ø±Ø¯Ø§Ø®Øª:** Ø¢Ù…Ø§Ø¯Ù‡\n\n" .
            "â° Ø¢Ø®Ø±ÛŒÙ† Ø¨Ø±ÙˆØ²Ø±Ø³Ø§Ù†ÛŒ: " . now()->format('Y/m/d H:i') . "\n\n" .
            "Ø¯Ø± ØµÙˆØ±Øª Ù…Ø´Ø§Ù‡Ø¯Ù‡ Ù…Ø´Ú©Ù„ØŒ ØªÛŒÚ©Øª Ù¾Ø´ØªÛŒØ¨Ø§Ù†ÛŒ Ø§Ø±Ø³Ø§Ù„ Ú©Ù†ÛŒØ¯.";
        
        $this->sendMessage($chatId, $statusMessage);
    }

    /**
     * Handle /ticket command
     */
    private function handleTicketCommand(string $chatId): void
    {
        $ticketMessage = "ğŸ« **Ø§ÛŒØ¬Ø§Ø¯ ØªÛŒÚ©Øª Ù¾Ø´ØªÛŒØ¨Ø§Ù†ÛŒ**\n\n" .
            "Ø¨Ø±Ø§ÛŒ Ø§ÛŒØ¬Ø§Ø¯ ØªÛŒÚ©Øª Ù¾Ø´ØªÛŒØ¨Ø§Ù†ÛŒØŒ Ù…ÙˆØ¶ÙˆØ¹ Ùˆ ØªÙˆØ¶ÛŒØ­Ø§Øª Ø®ÙˆØ¯ Ø±Ø§ Ø¨Ù‡ ØµÙˆØ±Øª Ø²ÛŒØ± Ø§Ø±Ø³Ø§Ù„ Ú©Ù†ÛŒØ¯:\n\n" .
            "**Ù…Ø«Ø§Ù„:**\n" .
            "Ù…ÙˆØ¶ÙˆØ¹: Ù…Ø´Ú©Ù„ Ø¯Ø± Ù¾Ø±Ø¯Ø§Ø®Øª\n" .
            "ØªÙˆØ¶ÛŒØ­Ø§Øª: Ø¯Ø± Ù‡Ù†Ú¯Ø§Ù… Ù¾Ø±Ø¯Ø§Ø®Øª Ø¨Ø§ Ø®Ø·Ø§ÛŒ 500 Ù…ÙˆØ§Ø¬Ù‡ Ù…ÛŒâ€ŒØ´ÙˆÙ…\n\n" .
            "ØªÛŒÙ… Ù¾Ø´ØªÛŒØ¨Ø§Ù†ÛŒ Ø¯Ø± Ø§Ø³Ø±Ø¹ ÙˆÙ‚Øª Ù¾Ø§Ø³Ø®Ú¯ÙˆÛŒ Ø´Ù…Ø§ Ø®ÙˆØ§Ù‡Ø¯ Ø¨ÙˆØ¯.";
        
        $this->sendMessage($chatId, $ticketMessage);
    }

    /**
     * Handle unknown commands
     */
    private function handleUnknownCommand(string $chatId, string $command): void
    {
        $unknownMessage = "â“ **Ø¯Ø³ØªÙˆØ± Ù†Ø§Ø´Ù†Ø§Ø®ØªÙ‡**\n\n" .
            "Ù…ØªØ£Ø³ÙØ§Ù†Ù‡ Ø¯Ø³ØªÙˆØ± `/{$command}` Ø´Ù†Ø§Ø®ØªÙ‡ Ø´Ø¯Ù‡ Ù†ÛŒØ³Øª.\n\n" .
            "Ø¨Ø±Ø§ÛŒ Ù…Ø´Ø§Ù‡Ø¯Ù‡ Ù„ÛŒØ³Øª Ø¯Ø³ØªÙˆØ±Ø§Øª Ù…ÙˆØ¬ÙˆØ¯:\n" .
            "/help";
        
        $this->sendMessage($chatId, $unknownMessage);
    }

    /**
     * Simplified admin handler for testing
     */
    private function handleSimpleAdmin(\App\Services\Telegram\Core\UpdateContext $context): void
    {
        $command = $context->getCommand();
        $chatId = $context->getChatId();
        $userId = $context->getUserId();
        $userName = $context->getUserName();

        // Check if user is in admin list
        $adminIds = env('TELEGRAM_ADMIN_CHAT_IDS', '');
        $adminChatIds = array_filter(array_map('trim', explode(',', $adminIds)));
        
        if (!in_array($userId, $adminChatIds)) {
            $message = "ğŸš« **Ø¯Ø³ØªØ±Ø³ÛŒ Ù…Ø¬Ø§Ø² Ù†ÛŒØ³Øª**\n\n" .
                      "Ø´Ù…Ø§ Ù…Ø¬Ø§Ø² Ø¨Ù‡ Ø§Ø³ØªÙØ§Ø¯Ù‡ Ø§Ø² Ù¾Ù†Ù„ Ù…Ø¯ÛŒØ±ÛŒØª Ù†ÛŒØ³ØªÛŒØ¯.\n\n" .
                      "Ø´Ù†Ø§Ø³Ù‡ Ø´Ù…Ø§: `{$userId}`";
            
            $this->sendMessage($chatId, $message);
            return;
        }

        // Handle admin commands
        switch ($command) {
            case 'admin':
            case 'login':
                $message = "ğŸ›ï¸ **Ù¾Ù†Ù„ Ù…Ø¯ÛŒØ±ÛŒØª Ù¾ÛŒØ´Ø®ÙˆØ§Ù†Ú©**\n\n" .
                    "Ø®ÙˆØ´ Ø¢Ù…Ø¯ÛŒØ¯ {$userName}!\n\n" .
                    "**Ø¯Ø³ØªÙˆØ±Ø§Øª Ù…ÙˆØ¬ÙˆØ¯:**\n" .
                    "ğŸ“Š /dashboard - Ø¯Ø§Ø´Ø¨ÙˆØ±Ø¯ Ù…Ø¯ÛŒØ±ÛŒØª\n" .
                    "ğŸ“ˆ /stats - Ø¢Ù…Ø§Ø± Ø³ÛŒØ³ØªÙ…\n" .
                    "ğŸ‘¥ /users - Ù…Ø¯ÛŒØ±ÛŒØª Ú©Ø§Ø±Ø¨Ø±Ø§Ù†\n" .
                    "ğŸ’° /wallets - Ù…Ø¯ÛŒØ±ÛŒØª Ú©ÛŒÙ Ù¾ÙˆÙ„â€ŒÙ‡Ø§\n" .
                    "ğŸ« /tickets - Ù…Ø¯ÛŒØ±ÛŒØª ØªÛŒÚ©Øªâ€ŒÙ‡Ø§\n" .
                    "ğŸ¤– /ai - Ù…Ø¯ÛŒØ±ÛŒØª Ù‡ÙˆØ´ Ù…ØµÙ†ÙˆØ¹ÛŒ\n" .
                    "ğŸ“ /posts - Ù…Ø¯ÛŒØ±ÛŒØª Ù¾Ø³Øªâ€ŒÙ‡Ø§\n\n" .
                    "**ÙˆØ¶Ø¹ÛŒØª Ø³ÛŒØ³ØªÙ…:**\n" .
                    "ğŸŸ¢ Ø±Ø¨Ø§Øª Ø¢Ù†Ù„Ø§ÛŒÙ† Ùˆ Ø¢Ù…Ø§Ø¯Ù‡\n" .
                    "ğŸ” Ø§Ø­Ø±Ø§Ø² Ù‡ÙˆÛŒØª Ù…ÙˆÙÙ‚";
                
                $this->sendMessage($chatId, $message);
                break;

            case 'dashboard':
            case 'panel':
                $message = "ğŸ“Š **Ø¯Ø§Ø´Ø¨ÙˆØ±Ø¯ Ù…Ø¯ÛŒØ±ÛŒØª**\n\n" .
                    "**Ø¢Ù…Ø§Ø± Ú©Ù„ÛŒ:**\n" .
                    "ğŸ‘¥ Ú©Ø§Ø±Ø¨Ø±Ø§Ù†: " . \DB::table('users')->count() . "\n" .
                    "ğŸ’° Ú©Ù„ Ù…ÙˆØ¬ÙˆØ¯ÛŒ: " . number_format(\DB::table('wallets')->sum('balance') ?? 0) . " ØªÙˆÙ…Ø§Ù†\n" .
                    "ğŸ« ØªÛŒÚ©Øªâ€ŒÙ‡Ø§: " . \DB::table('tickets')->count() . "\n\n" .
                    "**ÙˆØ¶Ø¹ÛŒØª Ø³Ø±ÙˆÛŒØ³â€ŒÙ‡Ø§:**\n" .
                    "ğŸŸ¢ Ù¾Ø§ÛŒÚ¯Ø§Ù‡ Ø¯Ø§Ø¯Ù‡: ÙØ¹Ø§Ù„\n" .
                    "ğŸŸ¢ Ø³ÛŒØ³ØªÙ… Ù¾Ø±Ø¯Ø§Ø®Øª: Ø¢Ù…Ø§Ø¯Ù‡\n" .
                    "ğŸŸ¢ Ø±Ø¨Ø§Øª ØªÙ„Ú¯Ø±Ø§Ù…: Ù…ØªØµÙ„\n\n" .
                    "Ø¢Ø®Ø±ÛŒÙ† Ø¨Ø±ÙˆØ²Ø±Ø³Ø§Ù†ÛŒ: " . now()->format('Y/m/d H:i');
                
                $this->sendMessage($chatId, $message);
                break;

            case 'stats':
                $userCount = \DB::table('users')->count();
                $activeUsers = \DB::table('users')->where('updated_at', '>=', now()->subDays(30))->count();
                $totalBalance = \DB::table('wallets')->sum('balance') ?? 0;
                $transactionsToday = \DB::table('transactions')->whereDate('created_at', today())->count();

                $message = "ğŸ“ˆ **Ø¢Ù…Ø§Ø± ØªÙØµÛŒÙ„ÛŒ Ø³ÛŒØ³ØªÙ…**\n\n" .
                    "**Ú©Ø§Ø±Ø¨Ø±Ø§Ù†:**\n" .
                    "ğŸ‘¥ Ú©Ù„: " . number_format($userCount) . "\n" .
                    "âœ… ÙØ¹Ø§Ù„ (30 Ø±ÙˆØ²): " . number_format($activeUsers) . "\n\n" .
                    "**Ù…Ø§Ù„ÛŒ:**\n" .
                    "ğŸ’° Ú©Ù„ Ù…ÙˆØ¬ÙˆØ¯ÛŒ: " . number_format($totalBalance) . " ØªÙˆÙ…Ø§Ù†\n" .
                    "ğŸ’¸ ØªØ±Ø§Ú©Ù†Ø´ Ø§Ù…Ø±ÙˆØ²: " . number_format($transactionsToday) . "\n\n" .
                    "**Ø¹Ù…Ù„Ú©Ø±Ø¯:**\n" .
                    "âš¡ Ù¾Ø§Ø³Ø®Ú¯ÙˆÛŒÛŒ: Ø¹Ø§Ù„ÛŒ\n" .
                    "ğŸ“Š Ø¨Ø§Ø±Ú¯Ø°Ø§Ø±ÛŒ Ø³ÛŒØ³ØªÙ…: Ù†Ø±Ù…Ø§Ù„\n";
                
                $this->sendMessage($chatId, $message);
                break;

            case 'users':
                $this->handleUserManagement($context);
                break;

            case 'wallets':
                $this->handleWalletManagement($context);
                break;

            case 'tickets':
                $this->handleTicketManagement($context);
                break;

            case 'ai':
                $this->handleAIContentManagement($context);
                break;

            case 'posts':
                $this->handlePostManagement($context);
                break;

            case 'security':
            case 'tokens':
                $this->handleSecurityManagement($context);
                break;

            case 'settings':
            case 'config':
                $this->handleWebsiteSettings($context);
                break;

            case 'reports':
            case 'audit':
                $this->handleAuditReporting($context);
                break;

            default:
                $message = "âš¡ **Ù¾Ù†Ù„ Ù…Ø¯ÛŒØ±ÛŒØª ÙØ¹Ø§Ù„**\n\n" .
                    "Ø¯Ø³ØªÙˆØ± `/{$command}` Ø¯Ø± Ø­Ø§Ù„ Ù¾ÛŒØ§Ø¯Ù‡â€ŒØ³Ø§Ø²ÛŒ Ø§Ø³Øª.\n\n" .
                    "Ø§Ø² /admin Ø¨Ø±Ø§ÛŒ Ø¯Ø³ØªØ±Ø³ÛŒ Ø¨Ù‡ Ù…Ù†ÙˆÛŒ Ø§ØµÙ„ÛŒ Ø§Ø³ØªÙØ§Ø¯Ù‡ Ú©Ù†ÛŒØ¯.";
                
                $this->sendMessage($chatId, $message);
        }
    }

    /**
     * Handle user management operations
     */
    private function handleUserManagement(\App\Services\Telegram\Core\UpdateContext $context): void
    {
        $chatId = $context->getChatId();
        $args = $context->getCommandArgs();

        if (empty($args)) {
            // Show user management dashboard
            $this->showUserManagementDashboard($chatId);
            return;
        }

        $action = strtolower($args[0]);

        switch ($action) {
            case 'search':
                $this->searchUsers($chatId, $args);
                break;
            
            case 'view':
                $this->viewUser($chatId, $args);
                break;
                
            case 'ban':
                $this->banUser($chatId, $args);
                break;
                
            case 'unban':
                $this->unbanUser($chatId, $args);
                break;
                
            case 'list':
                $this->listUsers($chatId, $args);
                break;
                
            case 'stats':
                $this->userStats($chatId);
                break;
                
            default:
                $this->sendMessage($chatId, "â“ Ø¯Ø³ØªÙˆØ± Ù†Ø§Ù…Ø¹ØªØ¨Ø±. Ø§Ø² /users Ø¨Ø±Ø§ÛŒ Ø±Ø§Ù‡Ù†Ù…Ø§ Ø§Ø³ØªÙØ§Ø¯Ù‡ Ú©Ù†ÛŒØ¯.");
        }
    }

    /**
     * Show user management dashboard
     */
    private function showUserManagementDashboard(string $chatId): void
    {
        $totalUsers = \DB::table('users')->count();
        $activeUsers = \DB::table('users')->where('updated_at', '>=', now()->subDays(7))->count();
        $bannedUsers = \DB::table('users')->where('is_banned', true)->count();
        $newUsersToday = \DB::table('users')->whereDate('created_at', today())->count();
        $recentUsers = \DB::table('users')
            ->orderBy('created_at', 'desc')
            ->limit(5)
            ->get(['id', 'name', 'email', 'created_at']);

        $message = "ğŸ‘¥ **Ù…Ø¯ÛŒØ±ÛŒØª Ú©Ø§Ø±Ø¨Ø±Ø§Ù†**\n\n";
        
        $message .= "**Ø¢Ù…Ø§Ø± Ú©Ù„ÛŒ:**\n";
        $message .= "ğŸ‘¥ Ú©Ù„ Ú©Ø§Ø±Ø¨Ø±Ø§Ù†: " . number_format($totalUsers) . "\n";
        $message .= "âœ… ÙØ¹Ø§Ù„ (7 Ø±ÙˆØ²): " . number_format($activeUsers) . "\n";
        $message .= "ğŸš« Ù…Ø³Ø¯ÙˆØ¯ Ø´Ø¯Ù‡: " . number_format($bannedUsers) . "\n";
        $message .= "ğŸ†• Ø¹Ø¶ÙˆÛŒØª Ø§Ù…Ø±ÙˆØ²: " . number_format($newUsersToday) . "\n\n";

        $message .= "**Ú©Ø§Ø±Ø¨Ø±Ø§Ù† Ø§Ø®ÛŒØ±:**\n";
        foreach ($recentUsers as $user) {
            $date = \Carbon\Carbon::parse($user->created_at)->format('m/d');
            $name = $user->name ?: 'Ø¨Ø¯ÙˆÙ† Ù†Ø§Ù…';
            $message .= "â€¢ {$name} (ID: {$user->id}) - {$date}\n";
        }

        $message .= "\n**Ø¯Ø³ØªÙˆØ±Ø§Øª Ù…ÙˆØ¬ÙˆØ¯:**\n";
        $message .= "â€¢ `/users search <Ù…ØªÙ†>` - Ø¬Ø³ØªØ¬ÙˆÛŒ Ú©Ø§Ø±Ø¨Ø±\n";
        $message .= "â€¢ `/users view <ID>` - Ù…Ø´Ø§Ù‡Ø¯Ù‡ Ø¬Ø²Ø¦ÛŒØ§Øª Ú©Ø§Ø±Ø¨Ø±\n";
        $message .= "â€¢ `/users list [page]` - ÙÙ‡Ø±Ø³Øª Ú©Ø§Ø±Ø¨Ø±Ø§Ù†\n";
        $message .= "â€¢ `/users ban <ID> <Ø¯Ù„ÛŒÙ„>` - Ù…Ø³Ø¯ÙˆØ¯ Ú©Ø±Ø¯Ù† Ú©Ø§Ø±Ø¨Ø±\n";
        $message .= "â€¢ `/users unban <ID>` - Ø±ÙØ¹ Ù…Ø³Ø¯ÙˆØ¯ÛŒØª Ú©Ø§Ø±Ø¨Ø±\n";
        $message .= "â€¢ `/users stats` - Ø¢Ù…Ø§Ø± ØªÙØµÛŒÙ„ÛŒ\n\n";

        $message .= "**Ù…Ø«Ø§Ù„:**\n";
        $message .= "`/users view 123` - Ù…Ø´Ø§Ù‡Ø¯Ù‡ Ú©Ø§Ø±Ø¨Ø± Ø¨Ø§ ID 123\n";
        $message .= "`/users search Ø§Ø­Ù…Ø¯` - Ø¬Ø³ØªØ¬ÙˆÛŒ Ú©Ø§Ø±Ø¨Ø±Ø§Ù† Ø¨Ø§ Ù†Ø§Ù… Ø§Ø­Ù…Ø¯";

        $this->sendMessage($chatId, $message);
    }

    /**
     * Search users by name, email, or ID
     */
    private function searchUsers(string $chatId, array $args): void
    {
        if (count($args) < 2) {
            $this->sendMessage($chatId, "âŒ Ù„Ø·ÙØ§Ù‹ Ù…ØªÙ† Ø¬Ø³ØªØ¬Ùˆ Ø±Ø§ ÙˆØ§Ø±Ø¯ Ú©Ù†ÛŒØ¯.\n\n**Ù…Ø«Ø§Ù„:** `/users search Ø§Ø­Ù…Ø¯`");
            return;
        }

        $query = implode(' ', array_slice($args, 1));
        
        $users = \DB::table('users')
            ->where(function($q) use ($query) {
                $q->where('name', 'ILIKE', "%{$query}%")
                  ->orWhere('email', 'ILIKE', "%{$query}%")
                  ->orWhere('mobile', 'LIKE', "%{$query}%");
                
                // If query is numeric, also search by ID
                if (is_numeric($query)) {
                    $q->orWhere('id', $query);
                }
            })
            ->orderBy('created_at', 'desc')
            ->limit(10)
            ->get(['id', 'name', 'email', 'mobile', 'created_at', 'is_banned']);

        if ($users->isEmpty()) {
            $this->sendMessage($chatId, "ğŸ” **Ù†ØªÛŒØ¬Ù‡ Ø¬Ø³ØªØ¬Ùˆ**\n\nÙ‡ÛŒÚ† Ú©Ø§Ø±Ø¨Ø±ÛŒ Ø¨Ø§ Ø¹Ø¨Ø§Ø±Øª `{$query}` ÛŒØ§ÙØª Ù†Ø´Ø¯.");
            return;
        }

        $message = "ğŸ” **Ù†ØªØ§ÛŒØ¬ Ø¬Ø³ØªØ¬Ùˆ Ø¨Ø±Ø§ÛŒ:** `{$query}`\n\n";
        
        foreach ($users as $user) {
            $status = $user->is_banned ? 'ğŸš« Ù…Ø³Ø¯ÙˆØ¯' : 'âœ… ÙØ¹Ø§Ù„';
            $name = $user->name ?: 'Ø¨Ø¯ÙˆÙ† Ù†Ø§Ù…';
            $email = $user->email ? " ({$user->email})" : '';
            $date = \Carbon\Carbon::parse($user->created_at)->format('Y/m/d');
            
            $message .= "**{$name}**{$email}\n";
            $message .= "ID: `{$user->id}` | {$status} | {$date}\n";
            if ($user->mobile) {
                $message .= "ğŸ“± {$user->mobile}\n";
            }
            $message .= "\n";
        }

        $message .= "**Ø¨Ø±Ø§ÛŒ Ø¬Ø²Ø¦ÛŒØ§Øª Ø¨ÛŒØ´ØªØ±:** `/users view <ID>`";

        $this->sendMessage($chatId, $message);
    }

    /**
     * View detailed user information
     */
    private function viewUser(string $chatId, array $args): void
    {
        if (count($args) < 2 || !is_numeric($args[1])) {
            $this->sendMessage($chatId, "âŒ Ù„Ø·ÙØ§Ù‹ ID Ú©Ø§Ø±Ø¨Ø± Ø±Ø§ ÙˆØ§Ø±Ø¯ Ú©Ù†ÛŒØ¯.\n\n**Ù…Ø«Ø§Ù„:** `/users view 123`");
            return;
        }

        $userId = (int)$args[1];
        
        $user = \DB::table('users')->where('id', $userId)->first();
        if (!$user) {
            $this->sendMessage($chatId, "âŒ Ú©Ø§Ø±Ø¨Ø±ÛŒ Ø¨Ø§ ID `{$userId}` ÛŒØ§ÙØª Ù†Ø´Ø¯.");
            return;
        }

        // Get wallet info
        $wallet = \DB::table('wallets')->where('holder_id', $userId)->where('holder_type', 'App\\Models\\User')->first();
        
        // Get recent transactions
        $transactionCount = \DB::table('transactions')
            ->where('payable_id', $userId)
            ->where('payable_type', 'App\\Models\\User')
            ->count();

        // Get tickets
        $ticketCount = \DB::table('tickets')->where('user_id', $userId)->count();

        $message = "ğŸ‘¤ **Ø¬Ø²Ø¦ÛŒØ§Øª Ú©Ø§Ø±Ø¨Ø±**\n\n";
        $message .= "**Ø§Ø·Ù„Ø§Ø¹Ø§Øª Ú©Ù„ÛŒ:**\n";
        $message .= "ğŸ†” ID: `{$user->id}`\n";
        $message .= "ğŸ“ Ù†Ø§Ù…: " . ($user->name ?: 'ØªØ¹Ø±ÛŒÙ Ù†Ø´Ø¯Ù‡') . "\n";
        $message .= "ğŸ“§ Ø§ÛŒÙ…ÛŒÙ„: " . ($user->email ?: 'ØªØ¹Ø±ÛŒÙ Ù†Ø´Ø¯Ù‡') . "\n";
        $message .= "ğŸ“± Ù…ÙˆØ¨Ø§ÛŒÙ„: " . ($user->mobile ?: 'ØªØ¹Ø±ÛŒÙ Ù†Ø´Ø¯Ù‡') . "\n";
        $message .= "ğŸ“… ØªØ§Ø±ÛŒØ® Ø¹Ø¶ÙˆÛŒØª: " . \Carbon\Carbon::parse($user->created_at)->format('Y/m/d H:i') . "\n";
        $message .= "ğŸ”„ Ø¢Ø®Ø±ÛŒÙ† ÙØ¹Ø§Ù„ÛŒØª: " . \Carbon\Carbon::parse($user->updated_at)->format('Y/m/d H:i') . "\n";
        
        $status = $user->is_banned ? 'ğŸš« Ù…Ø³Ø¯ÙˆØ¯' : 'âœ… ÙØ¹Ø§Ù„';
        $message .= "ğŸ“Š ÙˆØ¶Ø¹ÛŒØª: {$status}\n\n";

        if ($wallet) {
            $message .= "**Ú©ÛŒÙ Ù¾ÙˆÙ„:**\n";
            $message .= "ğŸ’° Ù…ÙˆØ¬ÙˆØ¯ÛŒ: " . number_format($wallet->balance) . " ØªÙˆÙ…Ø§Ù†\n";
            $message .= "ğŸ’³ ØªØ±Ø§Ú©Ù†Ø´â€ŒÙ‡Ø§: " . number_format($transactionCount) . "\n\n";
        }

        $message .= "**Ø¢Ù…Ø§Ø± ÙØ¹Ø§Ù„ÛŒØª:**\n";
        $message .= "ğŸ« ØªÛŒÚ©Øªâ€ŒÙ‡Ø§: " . number_format($ticketCount) . "\n\n";

        $message .= "**Ø¹Ù…Ù„ÛŒØ§Øª Ù…Ø¬Ø§Ø²:**\n";
        if ($user->is_banned) {
            $message .= "â€¢ `/users unban {$userId}` - Ø±ÙØ¹ Ù…Ø³Ø¯ÙˆØ¯ÛŒØª\n";
        } else {
            $message .= "â€¢ `/users ban {$userId} <Ø¯Ù„ÛŒÙ„>` - Ù…Ø³Ø¯ÙˆØ¯ Ú©Ø±Ø¯Ù†\n";
        }
        $message .= "â€¢ `/wallets view {$userId}` - Ù…Ø´Ø§Ù‡Ø¯Ù‡ Ú©ÛŒÙ Ù¾ÙˆÙ„\n";
        $message .= "â€¢ `/tickets user {$userId}` - Ù…Ø´Ø§Ù‡Ø¯Ù‡ ØªÛŒÚ©Øªâ€ŒÙ‡Ø§";

        $this->sendMessage($chatId, $message);
    }

    /**
     * Ban a user
     */
    private function banUser(string $chatId, array $args): void
    {
        if (count($args) < 3) {
            $this->sendMessage($chatId, "âŒ ÙØ±Ù…Øª Ù†Ø§Ù…Ø¹ØªØ¨Ø±.\n\n**Ø¯Ø±Ø³Øª:** `/users ban <ID> <Ø¯Ù„ÛŒÙ„>`\n**Ù…Ø«Ø§Ù„:** `/users ban 123 ØªØ®Ù„Ù Ø§Ø² Ù‚ÙˆØ§Ù†ÛŒÙ†`");
            return;
        }

        $userId = (int)$args[1];
        $reason = implode(' ', array_slice($args, 2));

        if (!is_numeric($userId) || $userId <= 0) {
            $this->sendMessage($chatId, "âŒ ID Ú©Ø§Ø±Ø¨Ø± Ù†Ø§Ù…Ø¹ØªØ¨Ø± Ø§Ø³Øª.");
            return;
        }

        $user = \DB::table('users')->where('id', $userId)->first();
        if (!$user) {
            $this->sendMessage($chatId, "âŒ Ú©Ø§Ø±Ø¨Ø±ÛŒ Ø¨Ø§ ID `{$userId}` ÛŒØ§ÙØª Ù†Ø´Ø¯.");
            return;
        }

        if ($user->is_banned) {
            $this->sendMessage($chatId, "âš ï¸ Ø§ÛŒÙ† Ú©Ø§Ø±Ø¨Ø± Ù‚Ø¨Ù„Ø§Ù‹ Ù…Ø³Ø¯ÙˆØ¯ Ø´Ø¯Ù‡ Ø§Ø³Øª.");
            return;
        }

        try {
            \DB::beginTransaction();
            
            // Ban user
            \DB::table('users')->where('id', $userId)->update([
                'is_banned' => true,
                'banned_at' => now(),
                'ban_reason' => $reason,
                'updated_at' => now()
            ]);

            // Log the action
            \DB::table('telegram_audit_logs')->insert([
                'admin_id' => null, // Will be updated when we have full auth system
                'action' => 'user_ban',
                'resource_type' => 'user',
                'resource_id' => (string)$userId,
                'new_values' => json_encode(['reason' => $reason]),
                'success' => true,
                'created_at' => now(),
                'updated_at' => now()
            ]);

            \DB::commit();
            
            $userName = $user->name ?: "Ú©Ø§Ø±Ø¨Ø± {$userId}";
            $message = "âœ… **Ú©Ø§Ø±Ø¨Ø± Ù…Ø³Ø¯ÙˆØ¯ Ø´Ø¯**\n\n";
            $message .= "ğŸ‘¤ Ú©Ø§Ø±Ø¨Ø±: {$userName} (ID: {$userId})\n";
            $message .= "ğŸ“ Ø¯Ù„ÛŒÙ„: {$reason}\n";
            $message .= "ğŸ“… ØªØ§Ø±ÛŒØ®: " . now()->format('Y/m/d H:i');
            
            $this->sendMessage($chatId, $message);
            
        } catch (\Exception $e) {
            \DB::rollback();
            $this->sendMessage($chatId, "âŒ Ø®Ø·Ø§ Ø¯Ø± Ù…Ø³Ø¯ÙˆØ¯ Ú©Ø±Ø¯Ù† Ú©Ø§Ø±Ø¨Ø±: " . $e->getMessage());
        }
    }

    /**
     * Unban a user
     */
    private function unbanUser(string $chatId, array $args): void
    {
        if (count($args) < 2 || !is_numeric($args[1])) {
            $this->sendMessage($chatId, "âŒ Ù„Ø·ÙØ§Ù‹ ID Ú©Ø§Ø±Ø¨Ø± Ø±Ø§ ÙˆØ§Ø±Ø¯ Ú©Ù†ÛŒØ¯.\n\n**Ù…Ø«Ø§Ù„:** `/users unban 123`");
            return;
        }

        $userId = (int)$args[1];
        
        $user = \DB::table('users')->where('id', $userId)->first();
        if (!$user) {
            $this->sendMessage($chatId, "âŒ Ú©Ø§Ø±Ø¨Ø±ÛŒ Ø¨Ø§ ID `{$userId}` ÛŒØ§ÙØª Ù†Ø´Ø¯.");
            return;
        }

        if (!$user->is_banned) {
            $this->sendMessage($chatId, "âš ï¸ Ø§ÛŒÙ† Ú©Ø§Ø±Ø¨Ø± Ù…Ø³Ø¯ÙˆØ¯ Ù†ÛŒØ³Øª.");
            return;
        }

        try {
            \DB::beginTransaction();
            
            // Unban user
            \DB::table('users')->where('id', $userId)->update([
                'is_banned' => false,
                'banned_at' => null,
                'ban_reason' => null,
                'updated_at' => now()
            ]);

            // Log the action
            \DB::table('telegram_audit_logs')->insert([
                'admin_id' => null,
                'action' => 'user_unban',
                'resource_type' => 'user',
                'resource_id' => (string)$userId,
                'success' => true,
                'created_at' => now(),
                'updated_at' => now()
            ]);

            \DB::commit();
            
            $userName = $user->name ?: "Ú©Ø§Ø±Ø¨Ø± {$userId}";
            $message = "âœ… **Ù…Ø³Ø¯ÙˆØ¯ÛŒØª Ú©Ø§Ø±Ø¨Ø± Ù„ØºÙˆ Ø´Ø¯**\n\n";
            $message .= "ğŸ‘¤ Ú©Ø§Ø±Ø¨Ø±: {$userName} (ID: {$userId})\n";
            $message .= "ğŸ“… ØªØ§Ø±ÛŒØ®: " . now()->format('Y/m/d H:i');
            
            $this->sendMessage($chatId, $message);
            
        } catch (\Exception $e) {
            \DB::rollback();
            $this->sendMessage($chatId, "âŒ Ø®Ø·Ø§ Ø¯Ø± Ù„ØºÙˆ Ù…Ø³Ø¯ÙˆØ¯ÛŒØª: " . $e->getMessage());
        }
    }

    /**
     * List users with pagination
     */
    private function listUsers(string $chatId, array $args): void
    {
        $page = isset($args[1]) && is_numeric($args[1]) ? (int)$args[1] : 1;
        $perPage = 10;
        $offset = ($page - 1) * $perPage;

        $users = \DB::table('users')
            ->orderBy('created_at', 'desc')
            ->offset($offset)
            ->limit($perPage)
            ->get(['id', 'name', 'email', 'created_at', 'is_banned']);

        $totalUsers = \DB::table('users')->count();
        $totalPages = ceil($totalUsers / $perPage);

        if ($users->isEmpty()) {
            $this->sendMessage($chatId, "ğŸ“ Ù‡ÛŒÚ† Ú©Ø§Ø±Ø¨Ø±ÛŒ ÛŒØ§ÙØª Ù†Ø´Ø¯.");
            return;
        }

        $message = "ğŸ“ **ÙÙ‡Ø±Ø³Øª Ú©Ø§Ø±Ø¨Ø±Ø§Ù†** (ØµÙØ­Ù‡ {$page} Ø§Ø² {$totalPages})\n\n";

        foreach ($users as $user) {
            $status = $user->is_banned ? 'ğŸš«' : 'âœ…';
            $name = $user->name ?: 'Ø¨Ø¯ÙˆÙ† Ù†Ø§Ù…';
            $date = \Carbon\Carbon::parse($user->created_at)->format('m/d');
            
            $message .= "{$status} **{$name}** (ID: {$user->id})\n";
            if ($user->email) {
                $message .= "   ğŸ“§ {$user->email}\n";
            }
            $message .= "   ğŸ“… {$date}\n\n";
        }

        // Pagination buttons
        if ($totalPages > 1) {
            $message .= "**ØµÙØ­Ù‡â€ŒØ¨Ù†Ø¯ÛŒ:**\n";
            if ($page > 1) {
                $prevPage = $page - 1;
                $message .= "â† `/users list {$prevPage}` (Ù‚Ø¨Ù„ÛŒ)";
            }
            if ($page < $totalPages) {
                $nextPage = $page + 1;
                if ($page > 1) $message .= " | ";
                $message .= "â†’ `/users list {$nextPage}` (Ø¨Ø¹Ø¯ÛŒ)";
            }
        }

        $this->sendMessage($chatId, $message);
    }

    /**
     * Show detailed user statistics
     */
    private function userStats(string $chatId): void
    {
        $totalUsers = \DB::table('users')->count();
        $activeUsers = \DB::table('users')->where('updated_at', '>=', now()->subDays(30))->count();
        $bannedUsers = \DB::table('users')->where('is_banned', true)->count();
        $newUsersThisWeek = \DB::table('users')->where('created_at', '>=', now()->subWeek())->count();
        $newUsersToday = \DB::table('users')->whereDate('created_at', today())->count();
        
        // Users with wallets
        $usersWithWallets = \DB::table('wallets')
            ->where('holder_type', 'App\\Models\\User')
            ->distinct('holder_id')
            ->count();
            
        // Active users by period
        $activeToday = \DB::table('users')->whereDate('updated_at', today())->count();
        $activeThisWeek = \DB::table('users')->where('updated_at', '>=', now()->subWeek())->count();

        $message = "ğŸ“Š **Ø¢Ù…Ø§Ø± ØªÙØµÛŒÙ„ÛŒ Ú©Ø§Ø±Ø¨Ø±Ø§Ù†**\n\n";
        $message .= "**Ú©Ù„ Ú©Ø§Ø±Ø¨Ø±Ø§Ù†:**\n";
        $message .= "ğŸ‘¥ Ù…Ø¬Ù…ÙˆØ¹: " . number_format($totalUsers) . "\n";
        $message .= "âœ… ÙØ¹Ø§Ù„ (30 Ø±ÙˆØ²): " . number_format($activeUsers) . "\n";
        $message .= "ğŸš« Ù…Ø³Ø¯ÙˆØ¯ Ø´Ø¯Ù‡: " . number_format($bannedUsers) . "\n";
        $message .= "ğŸ’° Ø¯Ø§Ø±Ø§ÛŒ Ú©ÛŒÙ Ù¾ÙˆÙ„: " . number_format($usersWithWallets) . "\n\n";
        
        $message .= "**Ú©Ø§Ø±Ø¨Ø±Ø§Ù† Ø¬Ø¯ÛŒØ¯:**\n";
        $message .= "ğŸ“… Ø§Ù…Ø±ÙˆØ²: " . number_format($newUsersToday) . "\n";
        $message .= "ğŸ“… Ø§ÛŒÙ† Ù‡ÙØªÙ‡: " . number_format($newUsersThisWeek) . "\n\n";
        
        $message .= "**ÙØ¹Ø§Ù„ÛŒØª Ú©Ø§Ø±Ø¨Ø±Ø§Ù†:**\n";
        $message .= "ğŸ”¥ ÙØ¹Ø§Ù„ Ø§Ù…Ø±ÙˆØ²: " . number_format($activeToday) . "\n";
        $message .= "ğŸ“ˆ ÙØ¹Ø§Ù„ Ø§ÛŒÙ† Ù‡ÙØªÙ‡: " . number_format($activeThisWeek) . "\n\n";
        
        // Calculate percentages
        $activePct = $totalUsers > 0 ? round(($activeUsers / $totalUsers) * 100, 1) : 0;
        $bannedPct = $totalUsers > 0 ? round(($bannedUsers / $totalUsers) * 100, 1) : 0;
        
        $message .= "**Ø¯Ø±ØµØ¯Ù‡Ø§:**\n";
        $message .= "âœ… Ú©Ø§Ø±Ø¨Ø±Ø§Ù† ÙØ¹Ø§Ù„: {$activePct}%\n";
        $message .= "ğŸš« Ú©Ø§Ø±Ø¨Ø±Ø§Ù† Ù…Ø³Ø¯ÙˆØ¯: {$bannedPct}%\n";

        $this->sendMessage($chatId, $message);
    }
    
    private function handleWalletManagement(\App\Services\Telegram\Core\UpdateContext $context): void
    {
        $chatId = $context->getChatId();
        $text = $context->getText();
        $args = explode(' ', $text);
        
        if (count($args) < 2) {
            $this->sendWalletHelp($chatId);
            return;
        }
        
        $action = strtolower($args[1]);
        
        switch ($action) {
            case 'dashboard':
            case 'Ø¢Ù…Ø§Ø±':
                $this->showWalletDashboard($chatId);
                break;
                
            case 'view':
            case 'Ù†Ù…Ø§ÛŒØ´':
                $this->viewUserWallet($chatId, $args);
                break;
                
            case 'adjust':
            case 'ØªÙ†Ø¸ÛŒÙ…':
                $this->adjustWalletBalance($chatId, $args);
                break;
                
            case 'freeze':
            case 'Ù…Ø³Ø¯ÙˆØ¯':
                $this->freezeWallet($chatId, $args);
                break;
                
            case 'unfreeze':
            case 'Ø¢Ø²Ø§Ø¯':
                $this->unfreezeWallet($chatId, $args);
                break;
                
            case 'transactions':
            case 'ØªØ±Ø§Ú©Ù†Ø´â€ŒÙ‡Ø§':
                $this->viewWalletTransactions($chatId, $args);
                break;
                
            case 'audit':
            case 'Ø­Ø³Ø§Ø¨Ø±Ø³ÛŒ':
                $this->generateWalletAudit($chatId, $args);
                break;
                
            case 'stats':
            case 'Ú¯Ø²Ø§Ø±Ø´':
                $this->showWalletStats($chatId);
                break;
                
            default:
                $this->sendWalletHelp($chatId);
        }
    }
    
    private function sendWalletHelp(string $chatId): void
    {
        $help = "ğŸ’° **Ø³ÛŒØ³ØªÙ… Ù…Ø¯ÛŒØ±ÛŒØª Ú©ÛŒÙ Ù¾ÙˆÙ„**\n\n";
        $help .= "ğŸ“Š **Ø¯Ø³ØªÙˆØ±Ø§Øª Ù…ÙˆØ¬ÙˆØ¯:**\n";
        $help .= "â€¢ `/wallets dashboard` - Ø¢Ù…Ø§Ø± Ú©Ù„ÛŒ Ú©ÛŒÙ Ù¾ÙˆÙ„â€ŒÙ‡Ø§\n";
        $help .= "â€¢ `/wallets view <ID>` - Ù†Ù…Ø§ÛŒØ´ Ú©ÛŒÙ Ù¾ÙˆÙ„ Ú©Ø§Ø±Ø¨Ø±\n";
        $help .= "â€¢ `/wallets adjust <ID> <amount> <reason>` - ØªÙ†Ø¸ÛŒÙ… Ù…ÙˆØ¬ÙˆØ¯ÛŒ\n";
        $help .= "â€¢ `/wallets freeze <ID> <reason>` - Ù…Ø³Ø¯ÙˆØ¯ Ú©Ø±Ø¯Ù† Ú©ÛŒÙ Ù¾ÙˆÙ„\n";
        $help .= "â€¢ `/wallets unfreeze <ID>` - Ø¢Ø²Ø§Ø¯Ø³Ø§Ø²ÛŒ Ú©ÛŒÙ Ù¾ÙˆÙ„\n";
        $help .= "â€¢ `/wallets transactions <ID> [page]` - ØªØ±Ø§Ú©Ù†Ø´â€ŒÙ‡Ø§ÛŒ Ú©Ø§Ø±Ø¨Ø±\n";
        $help .= "â€¢ `/wallets audit [days]` - Ú¯Ø²Ø§Ø±Ø´ Ø­Ø³Ø§Ø¨Ø±Ø³ÛŒ\n";
        $help .= "â€¢ `/wallets stats` - Ø¢Ù…Ø§Ø± ØªÙØµÛŒÙ„ÛŒ\n\n";
        $help .= "ğŸ’¡ **Ù†Ú©ØªÙ‡:** Ø¨Ø±Ø§ÛŒ Ù…Ø¨Ø§Ù„Øº Ù…Ù†ÙÛŒ Ø§Ø² Ø¹Ù„Ø§Ù…Øª Ù…Ù†ÙÛŒ Ø§Ø³ØªÙØ§Ø¯Ù‡ Ú©Ù†ÛŒØ¯";
        
        $this->sendMessage($chatId, $help);
    }
    
    private function showWalletDashboard(string $chatId): void
    {
        try {
            // Get wallet statistics
            $totalUsers = \DB::table('users')->count();
            $activeWallets = \DB::table('users')->where('wallet_balance', '>', 0)->count();
            $frozenWallets = \DB::table('users')->where('wallet_is_frozen', true)->count();
            $totalBalance = \DB::table('users')->sum('wallet_balance');
            
            // Recent transactions
            $recentTransactions = \DB::table('wallet_audit_logs')
                ->join('users', 'wallet_audit_logs.user_id', '=', 'users.id')
                ->select('wallet_audit_logs.*', 'users.first_name', 'users.last_name')
                ->orderBy('wallet_audit_logs.created_at', 'desc')
                ->limit(5)
                ->get();
                
            $response = "ğŸ’° **Ø¯Ø§Ø´Ø¨ÙˆØ±Ø¯ Ù…Ø¯ÛŒØ±ÛŒØª Ú©ÛŒÙ Ù¾ÙˆÙ„**\n\n";
            $response .= "ğŸ“Š **Ø¢Ù…Ø§Ø± Ú©Ù„ÛŒ:**\n";
            $response .= "ğŸ‘¥ Ú©Ù„ Ú©Ø§Ø±Ø¨Ø±Ø§Ù†: " . number_format($totalUsers) . "\n";
            $response .= "ğŸ’µ Ú©ÛŒÙ Ù¾ÙˆÙ„â€ŒÙ‡Ø§ÛŒ ÙØ¹Ø§Ù„: " . number_format($activeWallets) . "\n";
            $response .= "ğŸ”’ Ú©ÛŒÙ Ù¾ÙˆÙ„â€ŒÙ‡Ø§ÛŒ Ù…Ø³Ø¯ÙˆØ¯: " . number_format($frozenWallets) . "\n";
            $response .= "ğŸ’° Ú©Ù„ Ù…ÙˆØ¬ÙˆØ¯ÛŒ: " . number_format($totalBalance) . " ØªÙˆÙ…Ø§Ù†\n\n";
            
            if ($recentTransactions->count() > 0) {
                $response .= "ğŸ“ **Ø¢Ø®Ø±ÛŒÙ† ØªØ±Ø§Ú©Ù†Ø´â€ŒÙ‡Ø§:**\n";
                foreach ($recentTransactions as $transaction) {
                    $userName = $transaction->first_name . ($transaction->last_name ? ' ' . $transaction->last_name : '');
                    $amount = ($transaction->amount >= 0 ? '+' : '') . number_format($transaction->amount);
                    $type = match($transaction->transaction_type) {
                        'deposit' => 'ğŸ’³ ÙˆØ§Ø±ÛŒØ²',
                        'withdraw' => 'ğŸ’¸ Ø¨Ø±Ø¯Ø§Ø´Øª',
                        'adjustment' => 'âš–ï¸ ØªÙ†Ø¸ÛŒÙ…',
                        'freeze' => 'ğŸ”’ Ù…Ø³Ø¯ÙˆØ¯',
                        'unfreeze' => 'ğŸ”“ Ø¢Ø²Ø§Ø¯',
                        default => 'ğŸ“ Ø¹Ù…Ù„ÛŒØ§Øª'
                    };
                    $response .= "â€¢ $type | $userName | $amount ØªÙˆÙ…Ø§Ù†\n";
                }
            } else {
                $response .= "ğŸ“ **Ù‡ÛŒÚ† ØªØ±Ø§Ú©Ù†Ø´ÛŒ Ø«Ø¨Øª Ù†Ø´Ø¯Ù‡ Ø§Ø³Øª**\n";
            }
            
            $response .= "\nğŸ’¡ Ø§Ø² `/wallets help` Ø¨Ø±Ø§ÛŒ Ø±Ø§Ù‡Ù†Ù…Ø§ Ø§Ø³ØªÙØ§Ø¯Ù‡ Ú©Ù†ÛŒØ¯";
            
            $this->sendMessage($chatId, $response);
            
        } catch (\Exception $e) {
            Log::error('Wallet dashboard error: ' . $e->getMessage());
            $this->sendMessage($chatId, "âŒ Ø®Ø·Ø§ Ø¯Ø± Ø¨Ø§Ø±Ú¯Ø°Ø§Ø±ÛŒ Ø¯Ø§Ø´Ø¨ÙˆØ±Ø¯ Ú©ÛŒÙ Ù¾ÙˆÙ„");
        }
    }
    
    private function viewUserWallet(string $chatId, array $args): void
    {
        if (count($args) < 3) {
            $this->sendMessage($chatId, "âŒ Ù„Ø·ÙØ§Ù‹ Ø´Ù†Ø§Ø³Ù‡ Ú©Ø§Ø±Ø¨Ø± Ø±Ø§ ÙˆØ§Ø±Ø¯ Ú©Ù†ÛŒØ¯\nğŸ’¡ Ù…Ø«Ø§Ù„: `/wallets view 123`");
            return;
        }
        
        $userId = $args[2];
        
        try {
            $user = \DB::table('users')->where('id', $userId)->first();
            
            if (!$user) {
                $this->sendMessage($chatId, "âŒ Ú©Ø§Ø±Ø¨Ø± Ø¨Ø§ Ø´Ù†Ø§Ø³Ù‡ $userId ÛŒØ§ÙØª Ù†Ø´Ø¯");
                return;
            }
            
            // Get wallet transactions
            $transactions = \DB::table('wallet_audit_logs')
                ->where('user_id', $userId)
                ->orderBy('created_at', 'desc')
                ->limit(10)
                ->get();
                
            $response = "ğŸ’° **Ú©ÛŒÙ Ù¾ÙˆÙ„ Ú©Ø§Ø±Ø¨Ø±**\n\n";
            $response .= "ğŸ‘¤ **Ø§Ø·Ù„Ø§Ø¹Ø§Øª Ú©Ø§Ø±Ø¨Ø±:**\n";
            $response .= "ğŸ†” Ø´Ù†Ø§Ø³Ù‡: $user->id\n";
            $response .= "ğŸ“ Ù†Ø§Ù…: " . ($user->first_name . ($user->last_name ? ' ' . $user->last_name : '')) . "\n";
            $response .= "ğŸ“ Ù…ÙˆØ¨Ø§ÛŒÙ„: " . ($user->mobile ?: 'ÙˆØ§Ø±Ø¯ Ù†Ø´Ø¯Ù‡') . "\n";
            $response .= "ğŸ“§ Ø§ÛŒÙ…ÛŒÙ„: " . ($user->email ?: 'ÙˆØ§Ø±Ø¯ Ù†Ø´Ø¯Ù‡') . "\n\n";
            
            $response .= "ğŸ’µ **ÙˆØ¶Ø¹ÛŒØª Ú©ÛŒÙ Ù¾ÙˆÙ„:**\n";
            $response .= "ğŸ’° Ù…ÙˆØ¬ÙˆØ¯ÛŒ: " . number_format($user->wallet_balance) . " ØªÙˆÙ…Ø§Ù†\n";
            $response .= "ğŸ”’ ÙˆØ¶Ø¹ÛŒØª: " . ($user->wallet_is_frozen ? 'ğŸ”´ Ù…Ø³Ø¯ÙˆØ¯' : 'ğŸŸ¢ ÙØ¹Ø§Ù„') . "\n";
            
            if ($user->wallet_frozen_reason) {
                $response .= "ğŸ“‹ Ø¯Ù„ÛŒÙ„ Ù…Ø³Ø¯ÙˆØ¯ÛŒ: $user->wallet_frozen_reason\n";
            }
            
            $response .= "\nğŸ“Š **Ø¢Ø®Ø±ÛŒÙ† ØªØ±Ø§Ú©Ù†Ø´â€ŒÙ‡Ø§:**\n";
            
            if ($transactions->count() > 0) {
                foreach ($transactions as $transaction) {
                    $amount = ($transaction->amount >= 0 ? '+' : '') . number_format($transaction->amount);
                    $type = match($transaction->transaction_type) {
                        'deposit' => 'ğŸ’³',
                        'withdraw' => 'ğŸ’¸',
                        'adjustment' => 'âš–ï¸',
                        'freeze' => 'ğŸ”’',
                        'unfreeze' => 'ğŸ”“',
                        default => 'ğŸ“'
                    };
                    $date = \Carbon\Carbon::parse($transaction->created_at)->format('Y/m/d H:i');
                    $response .= "$type $amount ØªÙˆÙ…Ø§Ù† | $date\n";
                    if ($transaction->notes) {
                        $response .= "   ğŸ’¬ $transaction->notes\n";
                    }
                }
            } else {
                $response .= "Ù‡ÛŒÚ† ØªØ±Ø§Ú©Ù†Ø´ÛŒ Ø«Ø¨Øª Ù†Ø´Ø¯Ù‡ Ø§Ø³Øª\n";
            }
            
            $this->sendMessage($chatId, $response);
            
        } catch (\Exception $e) {
            Log::error('View wallet error: ' . $e->getMessage());
            $this->sendMessage($chatId, "âŒ Ø®Ø·Ø§ Ø¯Ø± Ø¨Ø§Ø±Ú¯Ø°Ø§Ø±ÛŒ Ø§Ø·Ù„Ø§Ø¹Ø§Øª Ú©ÛŒÙ Ù¾ÙˆÙ„");
        }
    }
    
    private function adjustWalletBalance(string $chatId, array $args): void
    {
        if (count($args) < 5) {
            $this->sendMessage($chatId, "âŒ ÙØ±Ù…Øª Ù†Ø§Ø¯Ø±Ø³Øª\nğŸ’¡ Ù…Ø«Ø§Ù„: `/wallets adjust 123 50000 Ù¾Ø§Ø¯Ø§Ø´ Ø¹Ø¶ÙˆÛŒØª`");
            return;
        }
        
        $userId = $args[2];
        $amount = intval($args[3]);
        $reason = implode(' ', array_slice($args, 4));
        
        if ($amount == 0) {
            $this->sendMessage($chatId, "âŒ Ù…Ø¨Ù„Øº Ù†Ù…ÛŒâ€ŒØªÙˆØ§Ù†Ø¯ ØµÙØ± Ø¨Ø§Ø´Ø¯");
            return;
        }
        
        try {
            \DB::beginTransaction();
            
            $user = \DB::table('users')->where('id', $userId)->first();
            
            if (!$user) {
                $this->sendMessage($chatId, "âŒ Ú©Ø§Ø±Ø¨Ø± Ø¨Ø§ Ø´Ù†Ø§Ø³Ù‡ $userId ÛŒØ§ÙØª Ù†Ø´Ø¯");
                \DB::rollBack();
                return;
            }
            
            // Calculate new balance
            $oldBalance = $user->wallet_balance;
            $newBalance = $oldBalance + $amount;
            
            if ($newBalance < 0) {
                $this->sendMessage($chatId, "âŒ Ù…ÙˆØ¬ÙˆØ¯ÛŒ Ú©ÛŒÙ Ù¾ÙˆÙ„ Ù†Ù…ÛŒâ€ŒØªÙˆØ§Ù†Ø¯ Ù…Ù†ÙÛŒ Ø¨Ø§Ø´Ø¯\nÙ…ÙˆØ¬ÙˆØ¯ÛŒ ÙØ¹Ù„ÛŒ: " . number_format($oldBalance) . " ØªÙˆÙ…Ø§Ù†");
                \DB::rollBack();
                return;
            }
            
            // Update user wallet
            \DB::table('users')
                ->where('id', $userId)
                ->update([
                    'wallet_balance' => $newBalance,
                    'updated_at' => now()
                ]);
                
            // Log the transaction
            \DB::table('wallet_audit_logs')->insert([
                'user_id' => $userId,
                'transaction_type' => 'adjustment',
                'amount' => $amount,
                'balance_before' => $oldBalance,
                'balance_after' => $newBalance,
                'notes' => $reason,
                'admin_telegram_user_id' => $chatId,
                'created_at' => now(),
                'updated_at' => now()
            ]);
            
            \DB::commit();
            
            $userName = $user->first_name . ($user->last_name ? ' ' . $user->last_name : '');
            $amountText = ($amount >= 0 ? '+' : '') . number_format($amount);
            
            $response = "âœ… **ØªÙ†Ø¸ÛŒÙ… Ù…ÙˆØ¬ÙˆØ¯ÛŒ Ø§Ù†Ø¬Ø§Ù… Ø´Ø¯**\n\n";
            $response .= "ğŸ‘¤ Ú©Ø§Ø±Ø¨Ø±: $userName\n";
            $response .= "ğŸ†” Ø´Ù†Ø§Ø³Ù‡: $userId\n";
            $response .= "ğŸ’° Ù…Ø¨Ù„Øº ØªÙ†Ø¸ÛŒÙ…: $amountText ØªÙˆÙ…Ø§Ù†\n";
            $response .= "ğŸ“Š Ù…ÙˆØ¬ÙˆØ¯ÛŒ Ù‚Ø¨Ù„ÛŒ: " . number_format($oldBalance) . " ØªÙˆÙ…Ø§Ù†\n";
            $response .= "ğŸ“Š Ù…ÙˆØ¬ÙˆØ¯ÛŒ Ø¬Ø¯ÛŒØ¯: " . number_format($newBalance) . " ØªÙˆÙ…Ø§Ù†\n";
            $response .= "ğŸ“ Ø¯Ù„ÛŒÙ„: $reason\n";
            
            $this->sendMessage($chatId, $response);
            
        } catch (\Exception $e) {
            \DB::rollBack();
            Log::error('Wallet adjustment error: ' . $e->getMessage());
            $this->sendMessage($chatId, "âŒ Ø®Ø·Ø§ Ø¯Ø± ØªÙ†Ø¸ÛŒÙ… Ù…ÙˆØ¬ÙˆØ¯ÛŒ Ú©ÛŒÙ Ù¾ÙˆÙ„");
        }
    }
    
    private function freezeWallet(string $chatId, array $args): void
    {
        if (count($args) < 4) {
            $this->sendMessage($chatId, "âŒ ÙØ±Ù…Øª Ù†Ø§Ø¯Ø±Ø³Øª\nğŸ’¡ Ù…Ø«Ø§Ù„: `/wallets freeze 123 ØªØ®Ù„Ù Ø¯Ø± Ø§Ø³ØªÙØ§Ø¯Ù‡`");
            return;
        }
        
        $userId = $args[2];
        $reason = implode(' ', array_slice($args, 3));
        
        try {
            \DB::beginTransaction();
            
            $user = \DB::table('users')->where('id', $userId)->first();
            
            if (!$user) {
                $this->sendMessage($chatId, "âŒ Ú©Ø§Ø±Ø¨Ø± Ø¨Ø§ Ø´Ù†Ø§Ø³Ù‡ $userId ÛŒØ§ÙØª Ù†Ø´Ø¯");
                \DB::rollBack();
                return;
            }
            
            if ($user->wallet_is_frozen) {
                $this->sendMessage($chatId, "âš ï¸ Ú©ÛŒÙ Ù¾ÙˆÙ„ Ø§ÛŒÙ† Ú©Ø§Ø±Ø¨Ø± Ø§Ø² Ù‚Ø¨Ù„ Ù…Ø³Ø¯ÙˆØ¯ Ø§Ø³Øª");
                \DB::rollBack();
                return;
            }
            
            // Freeze wallet
            \DB::table('users')
                ->where('id', $userId)
                ->update([
                    'wallet_is_frozen' => true,
                    'wallet_frozen_reason' => $reason,
                    'wallet_frozen_at' => now(),
                    'updated_at' => now()
                ]);
                
            // Log the action
            \DB::table('wallet_audit_logs')->insert([
                'user_id' => $userId,
                'transaction_type' => 'freeze',
                'amount' => 0,
                'balance_before' => $user->wallet_balance,
                'balance_after' => $user->wallet_balance,
                'notes' => $reason,
                'admin_telegram_user_id' => $chatId,
                'created_at' => now(),
                'updated_at' => now()
            ]);
            
            \DB::commit();
            
            $userName = $user->first_name . ($user->last_name ? ' ' . $user->last_name : '');
            
            $response = "ğŸ”’ **Ú©ÛŒÙ Ù¾ÙˆÙ„ Ù…Ø³Ø¯ÙˆØ¯ Ø´Ø¯**\n\n";
            $response .= "ğŸ‘¤ Ú©Ø§Ø±Ø¨Ø±: $userName\n";
            $response .= "ğŸ†” Ø´Ù†Ø§Ø³Ù‡: $userId\n";
            $response .= "ğŸ’° Ù…ÙˆØ¬ÙˆØ¯ÛŒ: " . number_format($user->wallet_balance) . " ØªÙˆÙ…Ø§Ù†\n";
            $response .= "ğŸ“ Ø¯Ù„ÛŒÙ„ Ù…Ø³Ø¯ÙˆØ¯ÛŒ: $reason\n";
            
            $this->sendMessage($chatId, $response);
            
        } catch (\Exception $e) {
            \DB::rollBack();
            Log::error('Wallet freeze error: ' . $e->getMessage());
            $this->sendMessage($chatId, "âŒ Ø®Ø·Ø§ Ø¯Ø± Ù…Ø³Ø¯ÙˆØ¯ Ú©Ø±Ø¯Ù† Ú©ÛŒÙ Ù¾ÙˆÙ„");
        }
    }
    
    private function unfreezeWallet(string $chatId, array $args): void
    {
        if (count($args) < 3) {
            $this->sendMessage($chatId, "âŒ Ù„Ø·ÙØ§Ù‹ Ø´Ù†Ø§Ø³Ù‡ Ú©Ø§Ø±Ø¨Ø± Ø±Ø§ ÙˆØ§Ø±Ø¯ Ú©Ù†ÛŒØ¯\nğŸ’¡ Ù…Ø«Ø§Ù„: `/wallets unfreeze 123`");
            return;
        }
        
        $userId = $args[2];
        
        try {
            \DB::beginTransaction();
            
            $user = \DB::table('users')->where('id', $userId)->first();
            
            if (!$user) {
                $this->sendMessage($chatId, "âŒ Ú©Ø§Ø±Ø¨Ø± Ø¨Ø§ Ø´Ù†Ø§Ø³Ù‡ $userId ÛŒØ§ÙØª Ù†Ø´Ø¯");
                \DB::rollBack();
                return;
            }
            
            if (!$user->wallet_is_frozen) {
                $this->sendMessage($chatId, "âš ï¸ Ú©ÛŒÙ Ù¾ÙˆÙ„ Ø§ÛŒÙ† Ú©Ø§Ø±Ø¨Ø± Ù…Ø³Ø¯ÙˆØ¯ Ù†ÛŒØ³Øª");
                \DB::rollBack();
                return;
            }
            
            // Unfreeze wallet
            \DB::table('users')
                ->where('id', $userId)
                ->update([
                    'wallet_is_frozen' => false,
                    'wallet_frozen_reason' => null,
                    'wallet_frozen_at' => null,
                    'updated_at' => now()
                ]);
                
            // Log the action
            \DB::table('wallet_audit_logs')->insert([
                'user_id' => $userId,
                'transaction_type' => 'unfreeze',
                'amount' => 0,
                'balance_before' => $user->wallet_balance,
                'balance_after' => $user->wallet_balance,
                'notes' => 'Ø¢Ø²Ø§Ø¯Ø³Ø§Ø²ÛŒ Ú©ÛŒÙ Ù¾ÙˆÙ„ ØªÙˆØ³Ø· Ù…Ø¯ÛŒØ±',
                'admin_telegram_user_id' => $chatId,
                'created_at' => now(),
                'updated_at' => now()
            ]);
            
            \DB::commit();
            
            $userName = $user->first_name . ($user->last_name ? ' ' . $user->last_name : '');
            
            $response = "ğŸ”“ **Ú©ÛŒÙ Ù¾ÙˆÙ„ Ø¢Ø²Ø§Ø¯ Ø´Ø¯**\n\n";
            $response .= "ğŸ‘¤ Ú©Ø§Ø±Ø¨Ø±: $userName\n";
            $response .= "ğŸ†” Ø´Ù†Ø§Ø³Ù‡: $userId\n";
            $response .= "ğŸ’° Ù…ÙˆØ¬ÙˆØ¯ÛŒ: " . number_format($user->wallet_balance) . " ØªÙˆÙ…Ø§Ù†\n";
            $response .= "âœ… ÙˆØ¶Ø¹ÛŒØª: ÙØ¹Ø§Ù„\n";
            
            $this->sendMessage($chatId, $response);
            
        } catch (\Exception $e) {
            \DB::rollBack();
            Log::error('Wallet unfreeze error: ' . $e->getMessage());
            $this->sendMessage($chatId, "âŒ Ø®Ø·Ø§ Ø¯Ø± Ø¢Ø²Ø§Ø¯Ø³Ø§Ø²ÛŒ Ú©ÛŒÙ Ù¾ÙˆÙ„");
        }
    }
    
    private function viewWalletTransactions(string $chatId, array $args): void
    {
        if (count($args) < 3) {
            $this->sendMessage($chatId, "âŒ Ù„Ø·ÙØ§Ù‹ Ø´Ù†Ø§Ø³Ù‡ Ú©Ø§Ø±Ø¨Ø± Ø±Ø§ ÙˆØ§Ø±Ø¯ Ú©Ù†ÛŒØ¯\nğŸ’¡ Ù…Ø«Ø§Ù„: `/wallets transactions 123`");
            return;
        }
        
        $userId = $args[2];
        $page = isset($args[3]) ? max(1, intval($args[3])) : 1;
        $perPage = 10;
        $offset = ($page - 1) * $perPage;
        
        try {
            $user = \DB::table('users')->where('id', $userId)->first();
            
            if (!$user) {
                $this->sendMessage($chatId, "âŒ Ú©Ø§Ø±Ø¨Ø± Ø¨Ø§ Ø´Ù†Ø§Ø³Ù‡ $userId ÛŒØ§ÙØª Ù†Ø´Ø¯");
                return;
            }
            
            $transactions = \DB::table('wallet_audit_logs')
                ->where('user_id', $userId)
                ->orderBy('created_at', 'desc')
                ->offset($offset)
                ->limit($perPage)
                ->get();
                
            $totalTransactions = \DB::table('wallet_audit_logs')
                ->where('user_id', $userId)
                ->count();
                
            $totalPages = ceil($totalTransactions / $perPage);
            
            $userName = $user->first_name . ($user->last_name ? ' ' . $user->last_name : '');
            
            $response = "ğŸ“Š **ØªØ±Ø§Ú©Ù†Ø´â€ŒÙ‡Ø§ÛŒ Ú©ÛŒÙ Ù¾ÙˆÙ„**\n\n";
            $response .= "ğŸ‘¤ Ú©Ø§Ø±Ø¨Ø±: $userName (Ø´Ù†Ø§Ø³Ù‡: $userId)\n";
            $response .= "ğŸ“„ ØµÙØ­Ù‡ $page Ø§Ø² $totalPages\n";
            $response .= "ğŸ“Š Ú©Ù„ ØªØ±Ø§Ú©Ù†Ø´â€ŒÙ‡Ø§: " . number_format($totalTransactions) . "\n\n";
            
            if ($transactions->count() > 0) {
                foreach ($transactions as $transaction) {
                    $amount = ($transaction->amount >= 0 ? '+' : '') . number_format($transaction->amount);
                    $type = match($transaction->transaction_type) {
                        'deposit' => 'ğŸ’³ ÙˆØ§Ø±ÛŒØ²',
                        'withdraw' => 'ğŸ’¸ Ø¨Ø±Ø¯Ø§Ø´Øª',
                        'adjustment' => 'âš–ï¸ ØªÙ†Ø¸ÛŒÙ…',
                        'freeze' => 'ğŸ”’ Ù…Ø³Ø¯ÙˆØ¯',
                        'unfreeze' => 'ğŸ”“ Ø¢Ø²Ø§Ø¯',
                        default => 'ğŸ“ Ø¹Ù…Ù„ÛŒØ§Øª'
                    };
                    $date = \Carbon\Carbon::parse($transaction->created_at)->format('Y/m/d H:i');
                    
                    $response .= "ğŸ”¹ **$type**\n";
                    if ($transaction->amount != 0) {
                        $response .= "   ğŸ’° Ù…Ø¨Ù„Øº: $amount ØªÙˆÙ…Ø§Ù†\n";
                        $response .= "   ğŸ“Š Ù…ÙˆØ¬ÙˆØ¯ÛŒ Ø¨Ø¹Ø¯: " . number_format($transaction->balance_after) . " ØªÙˆÙ…Ø§Ù†\n";
                    }
                    if ($transaction->notes) {
                        $response .= "   ğŸ’¬ ØªÙˆØ¶ÛŒØ­Ø§Øª: $transaction->notes\n";
                    }
                    $response .= "   ğŸ• Ø²Ù…Ø§Ù†: $date\n\n";
                }
                
                if ($totalPages > 1) {
                    $response .= "ğŸ“„ **Ù†Ø§ÙˆØ¨Ø±ÛŒ:**\n";
                    if ($page > 1) {
                        $response .= "â¬…ï¸ `/wallets transactions $userId " . ($page - 1) . "` - ØµÙØ­Ù‡ Ù‚Ø¨Ù„\n";
                    }
                    if ($page < $totalPages) {
                        $response .= "â¡ï¸ `/wallets transactions $userId " . ($page + 1) . "` - ØµÙØ­Ù‡ Ø¨Ø¹Ø¯\n";
                    }
                }
            } else {
                $response .= "ğŸ“ Ù‡ÛŒÚ† ØªØ±Ø§Ú©Ù†Ø´ÛŒ Ø¨Ø±Ø§ÛŒ Ø§ÛŒÙ† Ú©Ø§Ø±Ø¨Ø± Ø«Ø¨Øª Ù†Ø´Ø¯Ù‡ Ø§Ø³Øª";
            }
            
            $this->sendMessage($chatId, $response);
            
        } catch (\Exception $e) {
            Log::error('Wallet transactions error: ' . $e->getMessage());
            $this->sendMessage($chatId, "âŒ Ø®Ø·Ø§ Ø¯Ø± Ø¨Ø§Ø±Ú¯Ø°Ø§Ø±ÛŒ ØªØ±Ø§Ú©Ù†Ø´â€ŒÙ‡Ø§");
        }
    }
    
    private function generateWalletAudit(string $chatId, array $args): void
    {
        $days = isset($args[2]) ? max(1, intval($args[2])) : 7;
        
        try {
            $startDate = now()->subDays($days)->startOfDay();
            $endDate = now()->endOfDay();
            
            // Get audit statistics
            $totalTransactions = \DB::table('wallet_audit_logs')
                ->whereBetween('created_at', [$startDate, $endDate])
                ->count();
                
            $transactionsByType = \DB::table('wallet_audit_logs')
                ->whereBetween('created_at', [$startDate, $endDate])
                ->groupBy('transaction_type')
                ->selectRaw('transaction_type, COUNT(*) as count, SUM(amount) as total')
                ->get();
                
            $totalAmount = \DB::table('wallet_audit_logs')
                ->whereBetween('created_at', [$startDate, $endDate])
                ->sum('amount');
                
            // Recent high-value transactions
            $highValueTransactions = \DB::table('wallet_audit_logs')
                ->join('users', 'wallet_audit_logs.user_id', '=', 'users.id')
                ->select('wallet_audit_logs.*', 'users.first_name', 'users.last_name')
                ->whereBetween('wallet_audit_logs.created_at', [$startDate, $endDate])
                ->where(function($query) {
                    $query->where('amount', '>', 1000000) // > 1M Toman
                          ->orWhere('amount', '<', -500000); // < -500K Toman
                })
                ->orderByDesc('amount')
                ->limit(10)
                ->get();
                
            $response = "ğŸ” **Ú¯Ø²Ø§Ø±Ø´ Ø­Ø³Ø§Ø¨Ø±Ø³ÛŒ Ú©ÛŒÙ Ù¾ÙˆÙ„**\n\n";
            $response .= "ğŸ“… Ø¯ÙˆØ±Ù‡: $days Ø±ÙˆØ² Ú¯Ø°Ø´ØªÙ‡\n";
            $response .= "ğŸ• Ø§Ø²: " . $startDate->format('Y/m/d') . "\n";
            $response .= "ğŸ• ØªØ§: " . $endDate->format('Y/m/d') . "\n\n";
            
            $response .= "ğŸ“Š **Ø¢Ù…Ø§Ø± Ú©Ù„ÛŒ:**\n";
            $response .= "ğŸ”¢ Ú©Ù„ ØªØ±Ø§Ú©Ù†Ø´â€ŒÙ‡Ø§: " . number_format($totalTransactions) . "\n";
            $response .= "ğŸ’° Ù…Ø¬Ù…ÙˆØ¹ Ù…Ø¨Ø§Ù„Øº: " . number_format($totalAmount) . " ØªÙˆÙ…Ø§Ù†\n\n";
            
            if ($transactionsByType->count() > 0) {
                $response .= "ğŸ“ˆ **ØªÙÚ©ÛŒÚ© Ø¨Ø± Ø§Ø³Ø§Ø³ Ù†ÙˆØ¹:**\n";
                foreach ($transactionsByType as $type) {
                    $typeName = match($type->transaction_type) {
                        'deposit' => 'ğŸ’³ ÙˆØ§Ø±ÛŒØ²',
                        'withdraw' => 'ğŸ’¸ Ø¨Ø±Ø¯Ø§Ø´Øª',
                        'adjustment' => 'âš–ï¸ ØªÙ†Ø¸ÛŒÙ…',
                        'freeze' => 'ğŸ”’ Ù…Ø³Ø¯ÙˆØ¯',
                        'unfreeze' => 'ğŸ”“ Ø¢Ø²Ø§Ø¯',
                        default => 'ğŸ“ Ø³Ø§ÛŒØ±'
                    };
                    $response .= "â€¢ $typeName: " . number_format($type->count) . " ØªØ±Ø§Ú©Ù†Ø´";
                    if ($type->total != 0) {
                        $response .= " (" . number_format($type->total) . " ØªÙˆÙ…Ø§Ù†)";
                    }
                    $response .= "\n";
                }
                $response .= "\n";
            }
            
            if ($highValueTransactions->count() > 0) {
                $response .= "âš ï¸ **ØªØ±Ø§Ú©Ù†Ø´â€ŒÙ‡Ø§ÛŒ Ù¾Ø±Ù…Ø¨Ù„Øº:**\n";
                foreach ($highValueTransactions as $transaction) {
                    $userName = $transaction->first_name . ($transaction->last_name ? ' ' . $transaction->last_name : '');
                    $amount = ($transaction->amount >= 0 ? '+' : '') . number_format($transaction->amount);
                    $date = \Carbon\Carbon::parse($transaction->created_at)->format('m/d H:i');
                    $response .= "â€¢ $userName | $amount ØªÙˆÙ…Ø§Ù† | $date\n";
                }
                $response .= "\n";
            }
            
            $response .= "ğŸ›¡ï¸ **ÙˆØ¶Ø¹ÛŒØª Ø§Ù…Ù†ÛŒØªÛŒ:** Ø³Ø¨Ø² âœ…\n";
            $response .= "ğŸ“‹ Ú¯Ø²Ø§Ø±Ø´ ØªÙˆÙ„ÛŒØ¯ Ø´Ø¯Ù‡ Ø¯Ø±: " . now()->format('Y/m/d H:i');
            
            $this->sendMessage($chatId, $response);
            
        } catch (\Exception $e) {
            Log::error('Wallet audit error: ' . $e->getMessage());
            $this->sendMessage($chatId, "âŒ Ø®Ø·Ø§ Ø¯Ø± ØªÙˆÙ„ÛŒØ¯ Ú¯Ø²Ø§Ø±Ø´ Ø­Ø³Ø§Ø¨Ø±Ø³ÛŒ");
        }
    }
    
    private function showWalletStats(string $chatId): void
    {
        try {
            $stats = \DB::table('users')
                ->selectRaw('
                    COUNT(*) as total_users,
                    COUNT(CASE WHEN wallet_balance > 0 THEN 1 END) as users_with_balance,
                    COUNT(CASE WHEN wallet_is_frozen = true THEN 1 END) as frozen_wallets,
                    SUM(wallet_balance) as total_balance,
                    AVG(wallet_balance) as avg_balance,
                    MAX(wallet_balance) as max_balance,
                    MIN(wallet_balance) as min_balance
                ')
                ->first();
                
            // Balance distribution
            $balanceRanges = \DB::table('users')
                ->selectRaw('
                    COUNT(CASE WHEN wallet_balance = 0 THEN 1 END) as zero_balance,
                    COUNT(CASE WHEN wallet_balance > 0 AND wallet_balance <= 100000 THEN 1 END) as low_balance,
                    COUNT(CASE WHEN wallet_balance > 100000 AND wallet_balance <= 1000000 THEN 1 END) as medium_balance,
                    COUNT(CASE WHEN wallet_balance > 1000000 THEN 1 END) as high_balance
                ')
                ->first();
                
            // Recent activity
            $recentActivity = \DB::table('wallet_audit_logs')
                ->where('created_at', '>=', now()->subDays(30))
                ->selectRaw('
                    COUNT(*) as transactions_30d,
                    SUM(CASE WHEN amount > 0 THEN amount END) as deposits_30d,
                    SUM(CASE WHEN amount < 0 THEN ABS(amount) END) as withdrawals_30d
                ')
                ->first();
                
            $response = "ğŸ“Š **Ø¢Ù…Ø§Ø± ØªÙØµÛŒÙ„ÛŒ Ú©ÛŒÙ Ù¾ÙˆÙ„**\n\n";
            
            $response .= "ğŸ‘¥ **Ø¢Ù…Ø§Ø± Ú©Ø§Ø±Ø¨Ø±Ø§Ù†:**\n";
            $response .= "â€¢ Ú©Ù„ Ú©Ø§Ø±Ø¨Ø±Ø§Ù†: " . number_format($stats->total_users) . "\n";
            $response .= "â€¢ Ø¯Ø§Ø±Ø§ÛŒ Ù…ÙˆØ¬ÙˆØ¯ÛŒ: " . number_format($stats->users_with_balance) . " (" . 
                         round(($stats->users_with_balance / $stats->total_users) * 100, 1) . "%)\n";
            $response .= "â€¢ Ú©ÛŒÙ Ù¾ÙˆÙ„â€ŒÙ‡Ø§ÛŒ Ù…Ø³Ø¯ÙˆØ¯: " . number_format($stats->frozen_wallets) . " (" . 
                         round(($stats->frozen_wallets / $stats->total_users) * 100, 1) . "%)\n\n";
            
            $response .= "ğŸ’° **Ø¢Ù…Ø§Ø± Ù…Ø§Ù„ÛŒ:**\n";
            $response .= "â€¢ Ú©Ù„ Ù…ÙˆØ¬ÙˆØ¯ÛŒ: " . number_format($stats->total_balance) . " ØªÙˆÙ…Ø§Ù†\n";
            $response .= "â€¢ Ù…ØªÙˆØ³Ø· Ù…ÙˆØ¬ÙˆØ¯ÛŒ: " . number_format($stats->avg_balance) . " ØªÙˆÙ…Ø§Ù†\n";
            $response .= "â€¢ Ø¨ÛŒØ´ØªØ±ÛŒÙ† Ù…ÙˆØ¬ÙˆØ¯ÛŒ: " . number_format($stats->max_balance) . " ØªÙˆÙ…Ø§Ù†\n";
            $response .= "â€¢ Ú©Ù…ØªØ±ÛŒÙ† Ù…ÙˆØ¬ÙˆØ¯ÛŒ: " . number_format($stats->min_balance) . " ØªÙˆÙ…Ø§Ù†\n\n";
            
            $response .= "ğŸ“ˆ **ØªÙˆØ²ÛŒØ¹ Ù…ÙˆØ¬ÙˆØ¯ÛŒ:**\n";
            $response .= "â€¢ ØµÙØ± ØªÙˆÙ…Ø§Ù†: " . number_format($balanceRanges->zero_balance) . " Ú©Ø§Ø±Ø¨Ø±\n";
            $response .= "â€¢ 1 ØªØ§ 100 Ù‡Ø²Ø§Ø±: " . number_format($balanceRanges->low_balance) . " Ú©Ø§Ø±Ø¨Ø±\n";
            $response .= "â€¢ 100 Ù‡Ø²Ø§Ø± ØªØ§ 1 Ù…ÛŒÙ„ÛŒÙˆÙ†: " . number_format($balanceRanges->medium_balance) . " Ú©Ø§Ø±Ø¨Ø±\n";
            $response .= "â€¢ Ø¨Ø§Ù„Ø§ÛŒ 1 Ù…ÛŒÙ„ÛŒÙˆÙ†: " . number_format($balanceRanges->high_balance) . " Ú©Ø§Ø±Ø¨Ø±\n\n";
            
            $response .= "ğŸ”„ **ÙØ¹Ø§Ù„ÛŒØª 30 Ø±ÙˆØ² Ø§Ø®ÛŒØ±:**\n";
            $response .= "â€¢ ØªØ¹Ø¯Ø§Ø¯ ØªØ±Ø§Ú©Ù†Ø´: " . number_format($recentActivity->transactions_30d) . "\n";
            $response .= "â€¢ Ú©Ù„ ÙˆØ§Ø±ÛŒØ²Ù‡Ø§: " . number_format($recentActivity->deposits_30d ?: 0) . " ØªÙˆÙ…Ø§Ù†\n";
            $response .= "â€¢ Ú©Ù„ Ø¨Ø±Ø¯Ø§Ø´Øªâ€ŒÙ‡Ø§: " . number_format($recentActivity->withdrawals_30d ?: 0) . " ØªÙˆÙ…Ø§Ù†\n";
            
            $this->sendMessage($chatId, $response);
            
        } catch (\Exception $e) {
            Log::error('Wallet stats error: ' . $e->getMessage());
            $this->sendMessage($chatId, "âŒ Ø®Ø·Ø§ Ø¯Ø± Ø¨Ø§Ø±Ú¯Ø°Ø§Ø±ÛŒ Ø¢Ù…Ø§Ø± Ú©ÛŒÙ Ù¾ÙˆÙ„");
        }
    }
    
    private function handleTicketManagement(\App\Services\Telegram\Core\UpdateContext $context): void
    {
        $chatId = $context->getChatId();
        $text = $context->getText();
        $args = explode(' ', $text);
        
        if (count($args) < 2) {
            $this->sendTicketHelp($chatId);
            return;
        }
        
        $action = strtolower($args[1]);
        
        switch ($action) {
            case 'dashboard':
            case 'Ø¢Ù…Ø§Ø±':
                $this->showTicketDashboard($chatId);
                break;
                
            case 'list':
            case 'Ù„ÛŒØ³Øª':
                $this->listTickets($chatId, $args);
                break;
                
            case 'view':
            case 'Ù†Ù…Ø§ÛŒØ´':
                $this->viewTicket($chatId, $args);
                break;
                
            case 'assign':
            case 'ÙˆØ§Ú¯Ø°Ø§Ø±ÛŒ':
                $this->assignTicket($chatId, $args);
                break;
                
            case 'status':
            case 'ÙˆØ¶Ø¹ÛŒØª':
                $this->updateTicketStatus($chatId, $args);
                break;
                
            case 'reply':
            case 'Ù¾Ø§Ø³Ø®':
                $this->replyToTicket($chatId, $args);
                break;
                
            case 'close':
            case 'Ø¨Ø³ØªÙ†':
                $this->closeTicket($chatId, $args);
                break;
                
            case 'reopen':
            case 'Ø¨Ø§Ø²Ú¯Ø´Ø§ÛŒÛŒ':
                $this->reopenTicket($chatId, $args);
                break;
                
            case 'search':
            case 'Ø¬Ø³ØªØ¬Ùˆ':
                $this->searchTickets($chatId, $args);
                break;
                
            case 'stats':
            case 'Ú¯Ø²Ø§Ø±Ø´':
                $this->showTicketStats($chatId);
                break;
                
            case 'priority':
            case 'Ø§ÙˆÙ„ÙˆÛŒØª':
                $this->updateTicketPriority($chatId, $args);
                break;
                
            default:
                $this->sendTicketHelp($chatId);
        }
    }
    
    private function sendTicketHelp(string $chatId): void
    {
        $help = "ğŸ« **Ø³ÛŒØ³ØªÙ… Ù…Ø¯ÛŒØ±ÛŒØª ØªÛŒÚ©Øªâ€ŒÙ‡Ø§**\n\n";
        $help .= "ğŸ“Š **Ø¯Ø³ØªÙˆØ±Ø§Øª Ù…ÙˆØ¬ÙˆØ¯:**\n";
        $help .= "â€¢ `/tickets dashboard` - Ø¢Ù…Ø§Ø± Ú©Ù„ÛŒ ØªÛŒÚ©Øªâ€ŒÙ‡Ø§\n";
        $help .= "â€¢ `/tickets list [status] [page]` - Ù„ÛŒØ³Øª ØªÛŒÚ©Øªâ€ŒÙ‡Ø§\n";
        $help .= "â€¢ `/tickets view <ID>` - Ù†Ù…Ø§ÛŒØ´ ØªÛŒÚ©Øª\n";
        $help .= "â€¢ `/tickets assign <ID> <admin_id>` - ÙˆØ§Ú¯Ø°Ø§Ø±ÛŒ ØªÛŒÚ©Øª\n";
        $help .= "â€¢ `/tickets status <ID> <status>` - ØªØºÛŒÛŒØ± ÙˆØ¶Ø¹ÛŒØª\n";
        $help .= "â€¢ `/tickets reply <ID> <message>` - Ù¾Ø§Ø³Ø® Ø¨Ù‡ ØªÛŒÚ©Øª\n";
        $help .= "â€¢ `/tickets close <ID>` - Ø¨Ø³ØªÙ† ØªÛŒÚ©Øª\n";
        $help .= "â€¢ `/tickets reopen <ID>` - Ø¨Ø§Ø²Ú¯Ø´Ø§ÛŒÛŒ ØªÛŒÚ©Øª\n";
        $help .= "â€¢ `/tickets search <query>` - Ø¬Ø³ØªØ¬Ùˆ Ø¯Ø± ØªÛŒÚ©Øªâ€ŒÙ‡Ø§\n";
        $help .= "â€¢ `/tickets priority <ID> <priority>` - ØªÙ†Ø¸ÛŒÙ… Ø§ÙˆÙ„ÙˆÛŒØª\n";
        $help .= "â€¢ `/tickets stats` - Ø¢Ù…Ø§Ø± ØªÙØµÛŒÙ„ÛŒ\n\n";
        $help .= "ğŸ’¡ **ÙˆØ¶Ø¹ÛŒØªâ€ŒÙ‡Ø§:** open, in_progress, pending, closed\n";
        $help .= "ğŸ’¡ **Ø§ÙˆÙ„ÙˆÛŒØªâ€ŒÙ‡Ø§:** low, normal, high, urgent";
        
        $this->sendMessage($chatId, $help);
    }
    
    private function showTicketDashboard(string $chatId): void
    {
        try {
            // Get ticket statistics
            $totalTickets = \DB::table('telegram_tickets')->count();
            $openTickets = \DB::table('telegram_tickets')->where('status', 'open')->count();
            $inProgressTickets = \DB::table('telegram_tickets')->where('status', 'in_progress')->count();
            $closedTickets = \DB::table('telegram_tickets')->where('status', 'closed')->count();
            $pendingTickets = \DB::table('telegram_tickets')->where('status', 'pending')->count();
            
            // Priority breakdown
            $urgentTickets = \DB::table('telegram_tickets')->where('priority', 'urgent')->where('status', '!=', 'closed')->count();
            $highPriorityTickets = \DB::table('telegram_tickets')->where('priority', 'high')->where('status', '!=', 'closed')->count();
            
            // Recent tickets
            $recentTickets = \DB::table('telegram_tickets')
                ->join('users', 'telegram_tickets.user_id', '=', 'users.id')
                ->select('telegram_tickets.*', 'users.first_name', 'users.last_name')
                ->orderBy('telegram_tickets.created_at', 'desc')
                ->limit(5)
                ->get();
                
            $response = "ğŸ« **Ø¯Ø§Ø´Ø¨ÙˆØ±Ø¯ Ù…Ø¯ÛŒØ±ÛŒØª ØªÛŒÚ©Øªâ€ŒÙ‡Ø§**\n\n";
            $response .= "ğŸ“Š **Ø¢Ù…Ø§Ø± Ú©Ù„ÛŒ:**\n";
            $response .= "ğŸ“‹ Ú©Ù„ ØªÛŒÚ©Øªâ€ŒÙ‡Ø§: " . number_format($totalTickets) . "\n";
            $response .= "ğŸŸ¢ Ø¨Ø§Ø²: " . number_format($openTickets) . "\n";
            $response .= "ğŸŸ¡ Ø¯Ø± Ø­Ø§Ù„ Ø§Ù†Ø¬Ø§Ù…: " . number_format($inProgressTickets) . "\n";
            $response .= "ğŸŸ  Ø¯Ø± Ø§Ù†ØªØ¸Ø§Ø±: " . number_format($pendingTickets) . "\n";
            $response .= "ğŸ”´ Ø¨Ø³ØªÙ‡: " . number_format($closedTickets) . "\n\n";
            
            $response .= "âš ï¸ **Ø§ÙˆÙ„ÙˆÛŒØªâ€ŒÙ‡Ø§ÛŒ Ø¨Ø§Ù„Ø§:**\n";
            $response .= "ğŸš¨ ÙÙˆØ±ÛŒ: " . number_format($urgentTickets) . "\n";
            $response .= "ğŸ”¥ Ø¨Ø§Ù„Ø§: " . number_format($highPriorityTickets) . "\n\n";
            
            if ($recentTickets->count() > 0) {
                $response .= "ğŸ“ **Ø¢Ø®Ø±ÛŒÙ† ØªÛŒÚ©Øªâ€ŒÙ‡Ø§:**\n";
                foreach ($recentTickets as $ticket) {
                    $userName = $ticket->first_name . ($ticket->last_name ? ' ' . $ticket->last_name : '');
                    $statusIcon = match($ticket->status) {
                        'open' => 'ğŸŸ¢',
                        'in_progress' => 'ğŸŸ¡',
                        'pending' => 'ğŸŸ ',
                        'closed' => 'ğŸ”´',
                        default => 'ğŸ“'
                    };
                    $priorityIcon = match($ticket->priority) {
                        'urgent' => 'ğŸš¨',
                        'high' => 'ğŸ”¥',
                        'normal' => 'ğŸ“„',
                        'low' => 'â¬‡ï¸',
                        default => 'ğŸ“„'
                    };
                    $response .= "â€¢ $statusIcon $priorityIcon ØªÛŒÚ©Øª #{$ticket->id} | $userName\n";
                    $response .= "  " . mb_substr($ticket->subject, 0, 40) . "...\n";
                }
            } else {
                $response .= "ğŸ“ **Ù‡ÛŒÚ† ØªÛŒÚ©ØªÛŒ Ø«Ø¨Øª Ù†Ø´Ø¯Ù‡ Ø§Ø³Øª**\n";
            }
            
            $response .= "\nğŸ’¡ Ø§Ø² `/tickets help` Ø¨Ø±Ø§ÛŒ Ø±Ø§Ù‡Ù†Ù…Ø§ Ø§Ø³ØªÙØ§Ø¯Ù‡ Ú©Ù†ÛŒØ¯";
            
            $this->sendMessage($chatId, $response);
            
        } catch (\Exception $e) {
            Log::error('Ticket dashboard error: ' . $e->getMessage());
            $this->sendMessage($chatId, "âŒ Ø®Ø·Ø§ Ø¯Ø± Ø¨Ø§Ø±Ú¯Ø°Ø§Ø±ÛŒ Ø¯Ø§Ø´Ø¨ÙˆØ±Ø¯ ØªÛŒÚ©Øªâ€ŒÙ‡Ø§");
        }
    }
    
    private function listTickets(string $chatId, array $args): void
    {
        $status = isset($args[2]) && in_array($args[2], ['open', 'in_progress', 'pending', 'closed', 'Ø¨Ø§Ø²', 'Ø¯Ø±_Ø­Ø§Ù„_Ø§Ù†Ø¬Ø§Ù…', 'Ø¯Ø±_Ø§Ù†ØªØ¸Ø§Ø±', 'Ø¨Ø³ØªÙ‡']) 
                 ? $args[2] : null;
        $page = isset($args[3]) ? max(1, intval($args[3])) : (isset($args[2]) && is_numeric($args[2]) ? max(1, intval($args[2])) : 1);
        $perPage = 8;
        $offset = ($page - 1) * $perPage;
        
        // Map Persian status to English
        $statusMap = [
            'Ø¨Ø§Ø²' => 'open',
            'Ø¯Ø±_Ø­Ø§Ù„_Ø§Ù†Ø¬Ø§Ù…' => 'in_progress',
            'Ø¯Ø±_Ø§Ù†ØªØ¸Ø§Ø±' => 'pending',
            'Ø¨Ø³ØªÙ‡' => 'closed'
        ];
        
        if ($status && isset($statusMap[$status])) {
            $status = $statusMap[$status];
        }
        
        try {
            $query = \DB::table('telegram_tickets')
                ->join('users', 'telegram_tickets.user_id', '=', 'users.id')
                ->select('telegram_tickets.*', 'users.first_name', 'users.last_name')
                ->orderBy('telegram_tickets.created_at', 'desc');
                
            if ($status) {
                $query->where('telegram_tickets.status', $status);
            }
            
            $tickets = $query->offset($offset)->limit($perPage)->get();
            
            $totalTickets = $query->offset(0)->limit(null)->count();
            $totalPages = ceil($totalTickets / $perPage);
            
            $statusText = $status ? " (ÙˆØ¶Ø¹ÛŒØª: $status)" : "";
            $response = "ğŸ« **Ù„ÛŒØ³Øª ØªÛŒÚ©Øªâ€ŒÙ‡Ø§$statusText**\n\n";
            $response .= "ğŸ“„ ØµÙØ­Ù‡ $page Ø§Ø² $totalPages\n";
            $response .= "ğŸ“Š Ú©Ù„ ØªÛŒÚ©Øªâ€ŒÙ‡Ø§: " . number_format($totalTickets) . "\n\n";
            
            if ($tickets->count() > 0) {
                foreach ($tickets as $ticket) {
                    $userName = $ticket->first_name . ($ticket->last_name ? ' ' . $ticket->last_name : '');
                    $statusIcon = match($ticket->status) {
                        'open' => 'ğŸŸ¢',
                        'in_progress' => 'ğŸŸ¡',
                        'pending' => 'ğŸŸ ',
                        'closed' => 'ğŸ”´',
                        default => 'ğŸ“'
                    };
                    $priorityIcon = match($ticket->priority) {
                        'urgent' => 'ğŸš¨',
                        'high' => 'ğŸ”¥',
                        'normal' => 'ğŸ“„',
                        'low' => 'â¬‡ï¸',
                        default => 'ğŸ“„'
                    };
                    $date = \Carbon\Carbon::parse($ticket->created_at)->format('m/d H:i');
                    
                    $response .= "ğŸ”¹ **ØªÛŒÚ©Øª #{$ticket->id}** $statusIcon $priorityIcon\n";
                    $response .= "   ğŸ‘¤ $userName | ğŸ• $date\n";
                    $response .= "   ğŸ“ " . mb_substr($ticket->subject, 0, 50) . "...\n";
                    $response .= "   ğŸ’¬ Ù¾Ø§Ø³Ø®â€ŒÙ‡Ø§: " . ($ticket->replies_count ?? 0) . "\n\n";
                }
                
                if ($totalPages > 1) {
                    $response .= "ğŸ“„ **Ù†Ø§ÙˆØ¨Ø±ÛŒ:**\n";
                    if ($page > 1) {
                        $prevCmd = $status ? "list $status " . ($page - 1) : "list " . ($page - 1);
                        $response .= "â¬…ï¸ `/tickets $prevCmd` - ØµÙØ­Ù‡ Ù‚Ø¨Ù„\n";
                    }
                    if ($page < $totalPages) {
                        $nextCmd = $status ? "list $status " . ($page + 1) : "list " . ($page + 1);
                        $response .= "â¡ï¸ `/tickets $nextCmd` - ØµÙØ­Ù‡ Ø¨Ø¹Ø¯\n";
                    }
                }
            } else {
                $response .= "ğŸ“ ØªÛŒÚ©ØªÛŒ Ø¨Ø§ Ø§ÛŒÙ† Ù…Ø¹ÛŒØ§Ø±Ù‡Ø§ Ù¾ÛŒØ¯Ø§ Ù†Ø´Ø¯";
            }
            
            $this->sendMessage($chatId, $response);
            
        } catch (\Exception $e) {
            Log::error('List tickets error: ' . $e->getMessage());
            $this->sendMessage($chatId, "âŒ Ø®Ø·Ø§ Ø¯Ø± Ø¨Ø§Ø±Ú¯Ø°Ø§Ø±ÛŒ Ù„ÛŒØ³Øª ØªÛŒÚ©Øªâ€ŒÙ‡Ø§");
        }
    }
    
    private function viewTicket(string $chatId, array $args): void
    {
        if (count($args) < 3) {
            $this->sendMessage($chatId, "âŒ Ù„Ø·ÙØ§Ù‹ Ø´Ù†Ø§Ø³Ù‡ ØªÛŒÚ©Øª Ø±Ø§ ÙˆØ§Ø±Ø¯ Ú©Ù†ÛŒØ¯\nğŸ’¡ Ù…Ø«Ø§Ù„: `/tickets view 123`");
            return;
        }
        
        $ticketId = $args[2];
        
        try {
            $ticket = \DB::table('telegram_tickets')
                ->join('users', 'telegram_tickets.user_id', '=', 'users.id')
                ->leftJoin('telegram_admins as assignee', 'telegram_tickets.assigned_to', '=', 'assignee.id')
                ->select('telegram_tickets.*', 
                        'users.first_name', 'users.last_name', 'users.mobile', 'users.email',
                        'assignee.first_name as assignee_first_name', 'assignee.last_name as assignee_last_name')
                ->where('telegram_tickets.id', $ticketId)
                ->first();
            
            if (!$ticket) {
                $this->sendMessage($chatId, "âŒ ØªÛŒÚ©Øª Ø¨Ø§ Ø´Ù†Ø§Ø³Ù‡ $ticketId ÛŒØ§ÙØª Ù†Ø´Ø¯");
                return;
            }
            
            $userName = $ticket->first_name . ($ticket->last_name ? ' ' . $ticket->last_name : '');
            $assigneeName = $ticket->assignee_first_name ? 
                           ($ticket->assignee_first_name . ($ticket->assignee_last_name ? ' ' . $ticket->assignee_last_name : '')) : 
                           'ÙˆØ§Ú¯Ø°Ø§Ø± Ù†Ø´Ø¯Ù‡';
            
            $statusIcon = match($ticket->status) {
                'open' => 'ğŸŸ¢ Ø¨Ø§Ø²',
                'in_progress' => 'ğŸŸ¡ Ø¯Ø± Ø­Ø§Ù„ Ø§Ù†Ø¬Ø§Ù…',
                'pending' => 'ğŸŸ  Ø¯Ø± Ø§Ù†ØªØ¸Ø§Ø±',
                'closed' => 'ğŸ”´ Ø¨Ø³ØªÙ‡',
                default => 'ğŸ“ Ù†Ø§Ù…Ø´Ø®Øµ'
            };
            
            $priorityIcon = match($ticket->priority) {
                'urgent' => 'ğŸš¨ ÙÙˆØ±ÛŒ',
                'high' => 'ğŸ”¥ Ø¨Ø§Ù„Ø§',
                'normal' => 'ğŸ“„ Ø¹Ø§Ø¯ÛŒ',
                'low' => 'â¬‡ï¸ Ù¾Ø§ÛŒÛŒÙ†',
                default => 'ğŸ“„ Ø¹Ø§Ø¯ÛŒ'
            };
            
            $response = "ğŸ« **Ø¬Ø²Ø¦ÛŒØ§Øª ØªÛŒÚ©Øª #{$ticket->id}**\n\n";
            $response .= "ğŸ“‹ **Ø§Ø·Ù„Ø§Ø¹Ø§Øª Ú©Ù„ÛŒ:**\n";
            $response .= "ğŸ“ Ù…ÙˆØ¶ÙˆØ¹: {$ticket->subject}\n";
            $response .= "ğŸ“Š ÙˆØ¶Ø¹ÛŒØª: $statusIcon\n";
            $response .= "âš ï¸ Ø§ÙˆÙ„ÙˆÛŒØª: $priorityIcon\n";
            $response .= "ğŸ‘¤ Ú©Ø§Ø±Ø¨Ø±: $userName\n";
            $response .= "ğŸ‘” Ù…Ø³Ø¦ÙˆÙ„: $assigneeName\n";
            $response .= "ğŸ• Ø§ÛŒØ¬Ø§Ø¯: " . \Carbon\Carbon::parse($ticket->created_at)->format('Y/m/d H:i') . "\n";
            $response .= "ğŸ”„ Ø¢Ø®Ø±ÛŒÙ† Ø¨Ø±ÙˆØ²Ø±Ø³Ø§Ù†ÛŒ: " . \Carbon\Carbon::parse($ticket->updated_at)->format('Y/m/d H:i') . "\n\n";
            
            $response .= "ğŸ“ **ØªÙ…Ø§Ø³ Ú©Ø§Ø±Ø¨Ø±:**\n";
            $response .= "ğŸ“§ Ø§ÛŒÙ…ÛŒÙ„: " . ($ticket->email ?: 'ÙˆØ§Ø±Ø¯ Ù†Ø´Ø¯Ù‡') . "\n";
            $response .= "ğŸ“± Ù…ÙˆØ¨Ø§ÛŒÙ„: " . ($ticket->mobile ?: 'ÙˆØ§Ø±Ø¯ Ù†Ø´Ø¯Ù‡') . "\n\n";
            
            $response .= "ğŸ’¬ **Ù…Ø­ØªÙˆØ§ÛŒ ØªÛŒÚ©Øª:**\n";
            $response .= $ticket->message . "\n\n";
            
            // Get replies
            $replies = \DB::table('telegram_ticket_replies')
                ->join('telegram_admins', 'telegram_ticket_replies.admin_id', '=', 'telegram_admins.id')
                ->select('telegram_ticket_replies.*', 'telegram_admins.first_name as admin_first_name', 
                        'telegram_admins.last_name as admin_last_name')
                ->where('ticket_id', $ticketId)
                ->orderBy('created_at', 'asc')
                ->get();
                
            if ($replies->count() > 0) {
                $response .= "ğŸ’¬ **Ù¾Ø§Ø³Ø®â€ŒÙ‡Ø§ (" . $replies->count() . "):**\n";
                foreach ($replies as $reply) {
                    $adminName = $reply->admin_first_name . ($reply->admin_last_name ? ' ' . $reply->admin_last_name : '');
                    $replyDate = \Carbon\Carbon::parse($reply->created_at)->format('m/d H:i');
                    $response .= "\nğŸ”¸ **$adminName** ($replyDate):\n";
                    $response .= $reply->message . "\n";
                }
            } else {
                $response .= "ğŸ’¬ **Ù‡ÛŒÚ† Ù¾Ø§Ø³Ø®ÛŒ Ø«Ø¨Øª Ù†Ø´Ø¯Ù‡ Ø§Ø³Øª**\n";
            }
            
            $response .= "\nâš™ï¸ **Ø¹Ù…Ù„ÛŒØ§Øª:**\n";
            $response .= "â€¢ `/tickets reply {$ticket->id} <Ù¾ÛŒØ§Ù…>` - Ù¾Ø§Ø³Ø®\n";
            $response .= "â€¢ `/tickets status {$ticket->id} <ÙˆØ¶Ø¹ÛŒØª>` - ØªØºÛŒÛŒØ± ÙˆØ¶Ø¹ÛŒØª\n";
            $response .= "â€¢ `/tickets priority {$ticket->id} <Ø§ÙˆÙ„ÙˆÛŒØª>` - ØªÙ†Ø¸ÛŒÙ… Ø§ÙˆÙ„ÙˆÛŒØª\n";
            if ($ticket->status !== 'closed') {
                $response .= "â€¢ `/tickets close {$ticket->id}` - Ø¨Ø³ØªÙ† ØªÛŒÚ©Øª\n";
            } else {
                $response .= "â€¢ `/tickets reopen {$ticket->id}` - Ø¨Ø§Ø²Ú¯Ø´Ø§ÛŒÛŒ ØªÛŒÚ©Øª\n";
            }
            
            $this->sendMessage($chatId, $response);
            
        } catch (\Exception $e) {
            Log::error('View ticket error: ' . $e->getMessage());
            $this->sendMessage($chatId, "âŒ Ø®Ø·Ø§ Ø¯Ø± Ø¨Ø§Ø±Ú¯Ø°Ø§Ø±ÛŒ Ø¬Ø²Ø¦ÛŒØ§Øª ØªÛŒÚ©Øª");
        }
    }
    
    private function assignTicket(string $chatId, array $args): void
    {
        if (count($args) < 4) {
            $this->sendMessage($chatId, "âŒ ÙØ±Ù…Øª Ù†Ø§Ø¯Ø±Ø³Øª\nğŸ’¡ Ù…Ø«Ø§Ù„: `/tickets assign 123 456`");
            return;
        }
        
        $ticketId = $args[2];
        $adminId = $args[3];
        
        try {
            \DB::beginTransaction();
            
            $ticket = \DB::table('telegram_tickets')->where('id', $ticketId)->first();
            if (!$ticket) {
                $this->sendMessage($chatId, "âŒ ØªÛŒÚ©Øª Ø¨Ø§ Ø´Ù†Ø§Ø³Ù‡ $ticketId ÛŒØ§ÙØª Ù†Ø´Ø¯");
                \DB::rollBack();
                return;
            }
            
            $admin = \DB::table('telegram_admins')->where('id', $adminId)->first();
            if (!$admin) {
                $this->sendMessage($chatId, "âŒ Ù…Ø¯ÛŒØ± Ø¨Ø§ Ø´Ù†Ø§Ø³Ù‡ $adminId ÛŒØ§ÙØª Ù†Ø´Ø¯");
                \DB::rollBack();
                return;
            }
            
            \DB::table('telegram_tickets')
                ->where('id', $ticketId)
                ->update([
                    'assigned_to' => $adminId,
                    'status' => $ticket->status === 'open' ? 'in_progress' : $ticket->status,
                    'updated_at' => now()
                ]);
            
            \DB::commit();
            
            $adminName = $admin->first_name . ($admin->last_name ? ' ' . $admin->last_name : '');
            
            $response = "âœ… **ØªÛŒÚ©Øª ÙˆØ§Ú¯Ø°Ø§Ø± Ø´Ø¯**\n\n";
            $response .= "ğŸ« ØªÛŒÚ©Øª: #{$ticketId}\n";
            $response .= "ğŸ‘” Ù…Ø³Ø¦ÙˆÙ„ Ø¬Ø¯ÛŒØ¯: $adminName\n";
            $response .= "ğŸ“Š ÙˆØ¶Ø¹ÛŒØª: " . ($ticket->status === 'open' ? 'Ø¯Ø± Ø­Ø§Ù„ Ø§Ù†Ø¬Ø§Ù…' : $ticket->status) . "\n";
            
            $this->sendMessage($chatId, $response);
            
        } catch (\Exception $e) {
            \DB::rollBack();
            Log::error('Assign ticket error: ' . $e->getMessage());
            $this->sendMessage($chatId, "âŒ Ø®Ø·Ø§ Ø¯Ø± ÙˆØ§Ú¯Ø°Ø§Ø±ÛŒ ØªÛŒÚ©Øª");
        }
    }
    
    private function updateTicketStatus(string $chatId, array $args): void
    {
        if (count($args) < 4) {
            $this->sendMessage($chatId, "âŒ ÙØ±Ù…Øª Ù†Ø§Ø¯Ø±Ø³Øª\nğŸ’¡ Ù…Ø«Ø§Ù„: `/tickets status 123 in_progress`");
            return;
        }
        
        $ticketId = $args[2];
        $newStatus = strtolower($args[3]);
        
        // Map Persian status to English
        $statusMap = [
            'Ø¨Ø§Ø²' => 'open',
            'Ø¯Ø±_Ø­Ø§Ù„_Ø§Ù†Ø¬Ø§Ù…' => 'in_progress',
            'Ø¯Ø±_Ø§Ù†ØªØ¸Ø§Ø±' => 'pending',
            'Ø¨Ø³ØªÙ‡' => 'closed'
        ];
        
        if (isset($statusMap[$newStatus])) {
            $newStatus = $statusMap[$newStatus];
        }
        
        if (!in_array($newStatus, ['open', 'in_progress', 'pending', 'closed'])) {
            $this->sendMessage($chatId, "âŒ ÙˆØ¶Ø¹ÛŒØª Ù†Ø§Ù…Ø¹ØªØ¨Ø±\nğŸ’¡ ÙˆØ¶Ø¹ÛŒØªâ€ŒÙ‡Ø§ÛŒ Ù…Ø¹ØªØ¨Ø±: open, in_progress, pending, closed");
            return;
        }
        
        try {
            \DB::beginTransaction();
            
            $ticket = \DB::table('telegram_tickets')->where('id', $ticketId)->first();
            if (!$ticket) {
                $this->sendMessage($chatId, "âŒ ØªÛŒÚ©Øª Ø¨Ø§ Ø´Ù†Ø§Ø³Ù‡ $ticketId ÛŒØ§ÙØª Ù†Ø´Ø¯");
                \DB::rollBack();
                return;
            }
            
            $oldStatus = $ticket->status;
            
            \DB::table('telegram_tickets')
                ->where('id', $ticketId)
                ->update([
                    'status' => $newStatus,
                    'closed_at' => $newStatus === 'closed' ? now() : null,
                    'updated_at' => now()
                ]);
            
            \DB::commit();
            
            $statusText = match($newStatus) {
                'open' => 'ğŸŸ¢ Ø¨Ø§Ø²',
                'in_progress' => 'ğŸŸ¡ Ø¯Ø± Ø­Ø§Ù„ Ø§Ù†Ø¬Ø§Ù…',
                'pending' => 'ğŸŸ  Ø¯Ø± Ø§Ù†ØªØ¸Ø§Ø±',
                'closed' => 'ğŸ”´ Ø¨Ø³ØªÙ‡',
                default => $newStatus
            };
            
            $response = "âœ… **ÙˆØ¶Ø¹ÛŒØª ØªÛŒÚ©Øª ØªØºÛŒÛŒØ± Ú©Ø±Ø¯**\n\n";
            $response .= "ğŸ« ØªÛŒÚ©Øª: #{$ticketId}\n";
            $response .= "ğŸ“Š ÙˆØ¶Ø¹ÛŒØª Ù‚Ø¨Ù„ÛŒ: $oldStatus\n";
            $response .= "ğŸ“Š ÙˆØ¶Ø¹ÛŒØª Ø¬Ø¯ÛŒØ¯: $statusText\n";
            
            $this->sendMessage($chatId, $response);
            
        } catch (\Exception $e) {
            \DB::rollBack();
            Log::error('Update ticket status error: ' . $e->getMessage());
            $this->sendMessage($chatId, "âŒ Ø®Ø·Ø§ Ø¯Ø± ØªØºÛŒÛŒØ± ÙˆØ¶Ø¹ÛŒØª ØªÛŒÚ©Øª");
        }
    }
    
    private function replyToTicket(string $chatId, array $args): void
    {
        if (count($args) < 4) {
            $this->sendMessage($chatId, "âŒ ÙØ±Ù…Øª Ù†Ø§Ø¯Ø±Ø³Øª\nğŸ’¡ Ù…Ø«Ø§Ù„: `/tickets reply 123 Ù¾ÛŒØ§Ù… Ø´Ù…Ø§`");
            return;
        }
        
        $ticketId = $args[2];
        $message = implode(' ', array_slice($args, 3));
        
        if (empty(trim($message))) {
            $this->sendMessage($chatId, "âŒ Ù¾ÛŒØ§Ù… Ù†Ù…ÛŒâ€ŒØªÙˆØ§Ù†Ø¯ Ø®Ø§Ù„ÛŒ Ø¨Ø§Ø´Ø¯");
            return;
        }
        
        try {
            \DB::beginTransaction();
            
            $ticket = \DB::table('telegram_tickets')->where('id', $ticketId)->first();
            if (!$ticket) {
                $this->sendMessage($chatId, "âŒ ØªÛŒÚ©Øª Ø¨Ø§ Ø´Ù†Ø§Ø³Ù‡ $ticketId ÛŒØ§ÙØª Ù†Ø´Ø¯");
                \DB::rollBack();
                return;
            }
            
            // Get admin info
            $admin = \DB::table('telegram_admins')->where('telegram_user_id', $chatId)->first();
            if (!$admin) {
                $this->sendMessage($chatId, "âŒ Ø§Ø·Ù„Ø§Ø¹Ø§Øª Ù…Ø¯ÛŒØ± ÛŒØ§ÙØª Ù†Ø´Ø¯");
                \DB::rollBack();
                return;
            }
            
            // Add reply
            \DB::table('telegram_ticket_replies')->insert([
                'ticket_id' => $ticketId,
                'admin_id' => $admin->id,
                'message' => $message,
                'created_at' => now(),
                'updated_at' => now()
            ]);
            
            // Update ticket status if closed
            if ($ticket->status === 'closed') {
                \DB::table('telegram_tickets')
                    ->where('id', $ticketId)
                    ->update([
                        'status' => 'in_progress',
                        'updated_at' => now()
                    ]);
            } else {
                \DB::table('telegram_tickets')
                    ->where('id', $ticketId)
                    ->update(['updated_at' => now()]);
            }
            
            \DB::commit();
            
            $adminName = $admin->first_name . ($admin->last_name ? ' ' . $admin->last_name : '');
            
            $response = "âœ… **Ù¾Ø§Ø³Ø® Ø«Ø¨Øª Ø´Ø¯**\n\n";
            $response .= "ğŸ« ØªÛŒÚ©Øª: #{$ticketId}\n";
            $response .= "ğŸ‘” Ù¾Ø§Ø³Ø®â€ŒØ¯Ù‡Ù†Ø¯Ù‡: $adminName\n";
            $response .= "ğŸ’¬ Ù¾ÛŒØ§Ù…: " . mb_substr($message, 0, 100) . (mb_strlen($message) > 100 ? '...' : '') . "\n";
            if ($ticket->status === 'closed') {
                $response .= "ğŸ“Š ÙˆØ¶Ø¹ÛŒØª ØªÛŒÚ©Øª Ø¨Ù‡ 'Ø¯Ø± Ø­Ø§Ù„ Ø§Ù†Ø¬Ø§Ù…' ØªØºÛŒÛŒØ± Ú©Ø±Ø¯\n";
            }
            
            $this->sendMessage($chatId, $response);
            
        } catch (\Exception $e) {
            \DB::rollBack();
            Log::error('Reply to ticket error: ' . $e->getMessage());
            $this->sendMessage($chatId, "âŒ Ø®Ø·Ø§ Ø¯Ø± Ø«Ø¨Øª Ù¾Ø§Ø³Ø®");
        }
    }
    
    private function closeTicket(string $chatId, array $args): void
    {
        if (count($args) < 3) {
            $this->sendMessage($chatId, "âŒ Ù„Ø·ÙØ§Ù‹ Ø´Ù†Ø§Ø³Ù‡ ØªÛŒÚ©Øª Ø±Ø§ ÙˆØ§Ø±Ø¯ Ú©Ù†ÛŒØ¯\nğŸ’¡ Ù…Ø«Ø§Ù„: `/tickets close 123`");
            return;
        }
        
        $ticketId = $args[2];
        
        try {
            \DB::beginTransaction();
            
            $ticket = \DB::table('telegram_tickets')->where('id', $ticketId)->first();
            if (!$ticket) {
                $this->sendMessage($chatId, "âŒ ØªÛŒÚ©Øª Ø¨Ø§ Ø´Ù†Ø§Ø³Ù‡ $ticketId ÛŒØ§ÙØª Ù†Ø´Ø¯");
                \DB::rollBack();
                return;
            }
            
            if ($ticket->status === 'closed') {
                $this->sendMessage($chatId, "âš ï¸ Ø§ÛŒÙ† ØªÛŒÚ©Øª Ø§Ø² Ù‚Ø¨Ù„ Ø¨Ø³ØªÙ‡ Ø§Ø³Øª");
                \DB::rollBack();
                return;
            }
            
            \DB::table('telegram_tickets')
                ->where('id', $ticketId)
                ->update([
                    'status' => 'closed',
                    'closed_at' => now(),
                    'updated_at' => now()
                ]);
            
            \DB::commit();
            
            $response = "âœ… **ØªÛŒÚ©Øª Ø¨Ø³ØªÙ‡ Ø´Ø¯**\n\n";
            $response .= "ğŸ« ØªÛŒÚ©Øª: #{$ticketId}\n";
            $response .= "ğŸ“Š ÙˆØ¶Ø¹ÛŒØª: ğŸ”´ Ø¨Ø³ØªÙ‡\n";
            $response .= "ğŸ• Ø²Ù…Ø§Ù† Ø¨Ø³ØªÙ†: " . now()->format('Y/m/d H:i') . "\n";
            
            $this->sendMessage($chatId, $response);
            
        } catch (\Exception $e) {
            \DB::rollBack();
            Log::error('Close ticket error: ' . $e->getMessage());
            $this->sendMessage($chatId, "âŒ Ø®Ø·Ø§ Ø¯Ø± Ø¨Ø³ØªÙ† ØªÛŒÚ©Øª");
        }
    }
    
    private function reopenTicket(string $chatId, array $args): void
    {
        if (count($args) < 3) {
            $this->sendMessage($chatId, "âŒ Ù„Ø·ÙØ§Ù‹ Ø´Ù†Ø§Ø³Ù‡ ØªÛŒÚ©Øª Ø±Ø§ ÙˆØ§Ø±Ø¯ Ú©Ù†ÛŒØ¯\nğŸ’¡ Ù…Ø«Ø§Ù„: `/tickets reopen 123`");
            return;
        }
        
        $ticketId = $args[2];
        
        try {
            \DB::beginTransaction();
            
            $ticket = \DB::table('telegram_tickets')->where('id', $ticketId)->first();
            if (!$ticket) {
                $this->sendMessage($chatId, "âŒ ØªÛŒÚ©Øª Ø¨Ø§ Ø´Ù†Ø§Ø³Ù‡ $ticketId ÛŒØ§ÙØª Ù†Ø´Ø¯");
                \DB::rollBack();
                return;
            }
            
            if ($ticket->status !== 'closed') {
                $this->sendMessage($chatId, "âš ï¸ Ø§ÛŒÙ† ØªÛŒÚ©Øª Ø¨Ø³ØªÙ‡ Ù†ÛŒØ³Øª");
                \DB::rollBack();
                return;
            }
            
            \DB::table('telegram_tickets')
                ->where('id', $ticketId)
                ->update([
                    'status' => 'in_progress',
                    'closed_at' => null,
                    'updated_at' => now()
                ]);
            
            \DB::commit();
            
            $response = "âœ… **ØªÛŒÚ©Øª Ø¨Ø§Ø²Ú¯Ø´Ø§ÛŒÛŒ Ø´Ø¯**\n\n";
            $response .= "ğŸ« ØªÛŒÚ©Øª: #{$ticketId}\n";
            $response .= "ğŸ“Š ÙˆØ¶Ø¹ÛŒØª: ğŸŸ¡ Ø¯Ø± Ø­Ø§Ù„ Ø§Ù†Ø¬Ø§Ù…\n";
            $response .= "ğŸ• Ø²Ù…Ø§Ù† Ø¨Ø§Ø²Ú¯Ø´Ø§ÛŒÛŒ: " . now()->format('Y/m/d H:i') . "\n";
            
            $this->sendMessage($chatId, $response);
            
        } catch (\Exception $e) {
            \DB::rollBack();
            Log::error('Reopen ticket error: ' . $e->getMessage());
            $this->sendMessage($chatId, "âŒ Ø®Ø·Ø§ Ø¯Ø± Ø¨Ø§Ø²Ú¯Ø´Ø§ÛŒÛŒ ØªÛŒÚ©Øª");
        }
    }
    
    private function searchTickets(string $chatId, array $args): void
    {
        if (count($args) < 3) {
            $this->sendMessage($chatId, "âŒ Ù„Ø·ÙØ§Ù‹ Ú©Ù„Ù…Ù‡ Ø¬Ø³ØªØ¬Ùˆ Ø±Ø§ ÙˆØ§Ø±Ø¯ Ú©Ù†ÛŒØ¯\nğŸ’¡ Ù…Ø«Ø§Ù„: `/tickets search Ù¾Ø±Ø¯Ø§Ø®Øª`");
            return;
        }
        
        $query = implode(' ', array_slice($args, 2));
        
        try {
            $tickets = \DB::table('telegram_tickets')
                ->join('users', 'telegram_tickets.user_id', '=', 'users.id')
                ->select('telegram_tickets.*', 'users.first_name', 'users.last_name')
                ->where(function($q) use ($query) {
                    $q->where('telegram_tickets.subject', 'LIKE', "%$query%")
                      ->orWhere('telegram_tickets.message', 'LIKE', "%$query%")
                      ->orWhere('users.first_name', 'LIKE', "%$query%")
                      ->orWhere('users.last_name', 'LIKE', "%$query%");
                })
                ->orderBy('telegram_tickets.created_at', 'desc')
                ->limit(10)
                ->get();
                
            $response = "ğŸ” **Ù†ØªØ§ÛŒØ¬ Ø¬Ø³ØªØ¬Ùˆ Ø¨Ø±Ø§ÛŒ: \"$query\"**\n\n";
            $response .= "ğŸ“Š ØªØ¹Ø¯Ø§Ø¯ Ù†ØªØ§ÛŒØ¬: " . $tickets->count() . "\n\n";
            
            if ($tickets->count() > 0) {
                foreach ($tickets as $ticket) {
                    $userName = $ticket->first_name . ($ticket->last_name ? ' ' . $ticket->last_name : '');
                    $statusIcon = match($ticket->status) {
                        'open' => 'ğŸŸ¢',
                        'in_progress' => 'ğŸŸ¡',
                        'pending' => 'ğŸŸ ',
                        'closed' => 'ğŸ”´',
                        default => 'ğŸ“'
                    };
                    $priorityIcon = match($ticket->priority) {
                        'urgent' => 'ğŸš¨',
                        'high' => 'ğŸ”¥',
                        'normal' => 'ğŸ“„',
                        'low' => 'â¬‡ï¸',
                        default => 'ğŸ“„'
                    };
                    $date = \Carbon\Carbon::parse($ticket->created_at)->format('m/d H:i');
                    
                    $response .= "ğŸ”¹ **ØªÛŒÚ©Øª #{$ticket->id}** $statusIcon $priorityIcon\n";
                    $response .= "   ğŸ‘¤ $userName | ğŸ• $date\n";
                    $response .= "   ğŸ“ " . mb_substr($ticket->subject, 0, 50) . "...\n\n";
                }
                
                $response .= "ğŸ’¡ Ø¨Ø±Ø§ÛŒ Ù…Ø´Ø§Ù‡Ø¯Ù‡ Ø¬Ø²Ø¦ÛŒØ§Øª: `/tickets view <ID>`";
            } else {
                $response .= "ğŸ“ Ù‡ÛŒÚ† ØªÛŒÚ©ØªÛŒ Ø¨Ø§ Ø§ÛŒÙ† Ú©Ù„Ù…Ù‡ Ú©Ù„ÛŒØ¯ÛŒ Ù¾ÛŒØ¯Ø§ Ù†Ø´Ø¯";
            }
            
            $this->sendMessage($chatId, $response);
            
        } catch (\Exception $e) {
            Log::error('Search tickets error: ' . $e->getMessage());
            $this->sendMessage($chatId, "âŒ Ø®Ø·Ø§ Ø¯Ø± Ø¬Ø³ØªØ¬ÙˆÛŒ ØªÛŒÚ©Øªâ€ŒÙ‡Ø§");
        }
    }
    
    private function updateTicketPriority(string $chatId, array $args): void
    {
        if (count($args) < 4) {
            $this->sendMessage($chatId, "âŒ ÙØ±Ù…Øª Ù†Ø§Ø¯Ø±Ø³Øª\nğŸ’¡ Ù…Ø«Ø§Ù„: `/tickets priority 123 high`");
            return;
        }
        
        $ticketId = $args[2];
        $newPriority = strtolower($args[3]);
        
        // Map Persian priority to English
        $priorityMap = [
            'ÙÙˆØ±ÛŒ' => 'urgent',
            'Ø¨Ø§Ù„Ø§' => 'high',
            'Ø¹Ø§Ø¯ÛŒ' => 'normal',
            'Ù¾Ø§ÛŒÛŒÙ†' => 'low'
        ];
        
        if (isset($priorityMap[$newPriority])) {
            $newPriority = $priorityMap[$newPriority];
        }
        
        if (!in_array($newPriority, ['low', 'normal', 'high', 'urgent'])) {
            $this->sendMessage($chatId, "âŒ Ø§ÙˆÙ„ÙˆÛŒØª Ù†Ø§Ù…Ø¹ØªØ¨Ø±\nğŸ’¡ Ø§ÙˆÙ„ÙˆÛŒØªâ€ŒÙ‡Ø§ÛŒ Ù…Ø¹ØªØ¨Ø±: low, normal, high, urgent");
            return;
        }
        
        try {
            \DB::beginTransaction();
            
            $ticket = \DB::table('telegram_tickets')->where('id', $ticketId)->first();
            if (!$ticket) {
                $this->sendMessage($chatId, "âŒ ØªÛŒÚ©Øª Ø¨Ø§ Ø´Ù†Ø§Ø³Ù‡ $ticketId ÛŒØ§ÙØª Ù†Ø´Ø¯");
                \DB::rollBack();
                return;
            }
            
            $oldPriority = $ticket->priority;
            
            \DB::table('telegram_tickets')
                ->where('id', $ticketId)
                ->update([
                    'priority' => $newPriority,
                    'updated_at' => now()
                ]);
            
            \DB::commit();
            
            $priorityText = match($newPriority) {
                'urgent' => 'ğŸš¨ ÙÙˆØ±ÛŒ',
                'high' => 'ğŸ”¥ Ø¨Ø§Ù„Ø§',
                'normal' => 'ğŸ“„ Ø¹Ø§Ø¯ÛŒ',
                'low' => 'â¬‡ï¸ Ù¾Ø§ÛŒÛŒÙ†',
                default => $newPriority
            };
            
            $response = "âœ… **Ø§ÙˆÙ„ÙˆÛŒØª ØªÛŒÚ©Øª ØªØºÛŒÛŒØ± Ú©Ø±Ø¯**\n\n";
            $response .= "ğŸ« ØªÛŒÚ©Øª: #{$ticketId}\n";
            $response .= "âš ï¸ Ø§ÙˆÙ„ÙˆÛŒØª Ù‚Ø¨Ù„ÛŒ: $oldPriority\n";
            $response .= "âš ï¸ Ø§ÙˆÙ„ÙˆÛŒØª Ø¬Ø¯ÛŒØ¯: $priorityText\n";
            
            $this->sendMessage($chatId, $response);
            
        } catch (\Exception $e) {
            \DB::rollBack();
            Log::error('Update ticket priority error: ' . $e->getMessage());
            $this->sendMessage($chatId, "âŒ Ø®Ø·Ø§ Ø¯Ø± ØªØºÛŒÛŒØ± Ø§ÙˆÙ„ÙˆÛŒØª ØªÛŒÚ©Øª");
        }
    }
    
    private function showTicketStats(string $chatId): void
    {
        try {
            $stats = \DB::table('telegram_tickets')
                ->selectRaw('
                    COUNT(*) as total_tickets,
                    COUNT(CASE WHEN status = "open" THEN 1 END) as open_tickets,
                    COUNT(CASE WHEN status = "in_progress" THEN 1 END) as in_progress_tickets,
                    COUNT(CASE WHEN status = "pending" THEN 1 END) as pending_tickets,
                    COUNT(CASE WHEN status = "closed" THEN 1 END) as closed_tickets,
                    COUNT(CASE WHEN priority = "urgent" AND status != "closed" THEN 1 END) as urgent_open,
                    COUNT(CASE WHEN priority = "high" AND status != "closed" THEN 1 END) as high_open,
                    COUNT(CASE WHEN created_at >= ? THEN 1 END) as today_tickets,
                    COUNT(CASE WHEN created_at >= ? THEN 1 END) as week_tickets,
                    AVG(CASE WHEN closed_at IS NOT NULL THEN TIMESTAMPDIFF(HOUR, created_at, closed_at) END) as avg_resolution_hours
                ', [now()->startOfDay(), now()->subWeek()])
                ->first();
                
            // Response times
            $responseStats = \DB::table('telegram_tickets')
                ->join('telegram_ticket_replies', 'telegram_tickets.id', '=', 'telegram_ticket_replies.ticket_id')
                ->selectRaw('
                    COUNT(DISTINCT telegram_tickets.id) as tickets_with_replies,
                    AVG(TIMESTAMPDIFF(HOUR, telegram_tickets.created_at, telegram_ticket_replies.created_at)) as avg_first_response_hours
                ')
                ->whereRaw('telegram_ticket_replies.created_at = (
                    SELECT MIN(created_at) 
                    FROM telegram_ticket_replies r2 
                    WHERE r2.ticket_id = telegram_tickets.id
                )')
                ->first();
                
            // Top assignees
            $topAssignees = \DB::table('telegram_tickets')
                ->join('telegram_admins', 'telegram_tickets.assigned_to', '=', 'telegram_admins.id')
                ->selectRaw('
                    telegram_admins.first_name,
                    telegram_admins.last_name,
                    COUNT(*) as assigned_count,
                    COUNT(CASE WHEN telegram_tickets.status = "closed" THEN 1 END) as resolved_count
                ')
                ->groupBy('telegram_admins.id', 'telegram_admins.first_name', 'telegram_admins.last_name')
                ->orderByDesc('assigned_count')
                ->limit(5)
                ->get();
                
            $response = "ğŸ“Š **Ø¢Ù…Ø§Ø± ØªÙØµÛŒÙ„ÛŒ ØªÛŒÚ©Øªâ€ŒÙ‡Ø§**\n\n";
            
            $response .= "ğŸ“‹ **Ø¢Ù…Ø§Ø± Ú©Ù„ÛŒ:**\n";
            $response .= "â€¢ Ú©Ù„ ØªÛŒÚ©Øªâ€ŒÙ‡Ø§: " . number_format($stats->total_tickets) . "\n";
            $response .= "â€¢ Ø¨Ø§Ø²: " . number_format($stats->open_tickets) . " (" . 
                         round(($stats->open_tickets / max($stats->total_tickets, 1)) * 100, 1) . "%)\n";
            $response .= "â€¢ Ø¯Ø± Ø­Ø§Ù„ Ø§Ù†Ø¬Ø§Ù…: " . number_format($stats->in_progress_tickets) . " (" . 
                         round(($stats->in_progress_tickets / max($stats->total_tickets, 1)) * 100, 1) . "%)\n";
            $response .= "â€¢ Ø¯Ø± Ø§Ù†ØªØ¸Ø§Ø±: " . number_format($stats->pending_tickets) . " (" . 
                         round(($stats->pending_tickets / max($stats->total_tickets, 1)) * 100, 1) . "%)\n";
            $response .= "â€¢ Ø¨Ø³ØªÙ‡: " . number_format($stats->closed_tickets) . " (" . 
                         round(($stats->closed_tickets / max($stats->total_tickets, 1)) * 100, 1) . "%)\n\n";
            
            $response .= "âš ï¸ **Ø§ÙˆÙ„ÙˆÛŒØªâ€ŒÙ‡Ø§ÛŒ Ø¨Ø­Ø±Ø§Ù†ÛŒ:**\n";
            $response .= "â€¢ ğŸš¨ ÙÙˆØ±ÛŒ (Ø¨Ø§Ø²): " . number_format($stats->urgent_open) . "\n";
            $response .= "â€¢ ğŸ”¥ Ø¨Ø§Ù„Ø§ (Ø¨Ø§Ø²): " . number_format($stats->high_open) . "\n\n";
            
            $response .= "ğŸ“ˆ **ÙØ¹Ø§Ù„ÛŒØª Ø§Ø®ÛŒØ±:**\n";
            $response .= "â€¢ Ø§Ù…Ø±ÙˆØ²: " . number_format($stats->today_tickets) . " ØªÛŒÚ©Øª\n";
            $response .= "â€¢ Ø§ÛŒÙ† Ù‡ÙØªÙ‡: " . number_format($stats->week_tickets) . " ØªÛŒÚ©Øª\n\n";
            
            $response .= "â±ï¸ **Ø²Ù…Ø§Ù† Ù¾Ø±Ø¯Ø§Ø²Ø´:**\n";
            if ($stats->avg_resolution_hours) {
                $response .= "â€¢ Ù…ÛŒØ§Ù†Ú¯ÛŒÙ† Ø­Ù„ Ù…Ø³Ø¦Ù„Ù‡: " . round($stats->avg_resolution_hours, 1) . " Ø³Ø§Ø¹Øª\n";
            } else {
                $response .= "â€¢ Ù…ÛŒØ§Ù†Ú¯ÛŒÙ† Ø­Ù„ Ù…Ø³Ø¦Ù„Ù‡: Ù…Ø­Ø§Ø³Ø¨Ù‡ Ù†Ø´Ø¯Ù‡\n";
            }
            
            if ($responseStats->avg_first_response_hours) {
                $response .= "â€¢ Ù…ÛŒØ§Ù†Ú¯ÛŒÙ† Ø§ÙˆÙ„ÛŒÙ† Ù¾Ø§Ø³Ø®: " . round($responseStats->avg_first_response_hours, 1) . " Ø³Ø§Ø¹Øª\n";
            } else {
                $response .= "â€¢ Ù…ÛŒØ§Ù†Ú¯ÛŒÙ† Ø§ÙˆÙ„ÛŒÙ† Ù¾Ø§Ø³Ø®: Ù…Ø­Ø§Ø³Ø¨Ù‡ Ù†Ø´Ø¯Ù‡\n";
            }
            $response .= "â€¢ ØªÛŒÚ©Øªâ€ŒÙ‡Ø§ÛŒ Ù¾Ø§Ø³Ø®â€ŒØ¯Ø§Ø±: " . number_format($responseStats->tickets_with_replies) . "\n\n";
            
            if ($topAssignees->count() > 0) {
                $response .= "ğŸ‘” **Ø¨Ø±ØªØ±ÛŒÙ† Ù¾Ø´ØªÛŒØ¨Ø§Ù†â€ŒÙ‡Ø§:**\n";
                foreach ($topAssignees as $assignee) {
                    $name = $assignee->first_name . ($assignee->last_name ? ' ' . $assignee->last_name : '');
                    $resolvedRate = $assignee->assigned_count > 0 ? 
                                   round(($assignee->resolved_count / $assignee->assigned_count) * 100, 1) : 0;
                    $response .= "â€¢ $name: " . $assignee->assigned_count . " ÙˆØ§Ú¯Ø°Ø§Ø±ÛŒ | " . 
                                $assignee->resolved_count . " Ø­Ù„â€ŒØ´Ø¯Ù‡ ({$resolvedRate}%)\n";
                }
            } else {
                $response .= "ğŸ‘” **Ù‡ÛŒÚ† ÙˆØ§Ú¯Ø°Ø§Ø±ÛŒ Ø«Ø¨Øª Ù†Ø´Ø¯Ù‡ Ø§Ø³Øª**\n";
            }
            
            $this->sendMessage($chatId, $response);
            
        } catch (\Exception $e) {
            Log::error('Ticket stats error: ' . $e->getMessage());
            $this->sendMessage($chatId, "âŒ Ø®Ø·Ø§ Ø¯Ø± Ø¨Ø§Ø±Ú¯Ø°Ø§Ø±ÛŒ Ø¢Ù…Ø§Ø± ØªÛŒÚ©Øªâ€ŒÙ‡Ø§");
        }
    }

    /**
     * Handle AI content management
     */
    private function handleAIContentManagement(\App\Services\Telegram\Core\UpdateContext $context): void
    {
        $chatId = $context->getChatId();
        $messageText = $context->getText();
        $command = $context->getCommand();
        $args = $context->getArgs();

        try {
            switch ($command) {
                case 'ai':
                case 'dashboard':
                    $this->showAIDashboard($chatId);
                    break;

                case 'templates':
                    $this->manageAITemplates($chatId, $args);
                    break;

                case 'generate':
                    $this->generateAIContent($chatId, $args);
                    break;

                case 'history':
                    $this->showAIContentHistory($chatId, $args);
                    break;

                case 'settings':
                    $this->manageAISettings($chatId, $args);
                    break;

                case 'stats':
                    $this->showAIStats($chatId);
                    break;

                default:
                    $this->showAIHelp($chatId);
                    break;
            }

        } catch (\Exception $e) {
            Log::error('AI content management error: ' . $e->getMessage());
            $this->sendMessage($chatId, "âŒ Ø®Ø·Ø§ Ø¯Ø± Ø³ÛŒØ³ØªÙ… Ù‡ÙˆØ´ Ù…ØµÙ†ÙˆØ¹ÛŒ");
        }
    }

    /**
     * Show AI dashboard
     */
    private function showAIDashboard($chatId): void
    {
        try {
            // Get AI usage statistics
            $todayGenerated = DB::table('ai_content_templates')
                ->whereDate('created_at', today())
                ->count();

            $totalTemplates = DB::table('ai_content_templates')->count();

            $activeTemplates = DB::table('ai_content_templates')
                ->where('is_active', true)
                ->count();

            $totalTokensUsed = 0; // Will track this in future versions

            $message = "ğŸ¤– <b>Ø¯Ø§Ø´Ø¨ÙˆØ±Ø¯ Ù‡ÙˆØ´ Ù…ØµÙ†ÙˆØ¹ÛŒ</b>\n\n";
            $message .= "ğŸ“Š <b>Ø¢Ù…Ø§Ø± Ø§Ù…Ø±ÙˆØ²:</b>\n";
            $message .= "â”” Ù…Ø­ØªÙˆØ§ÛŒ ØªÙˆÙ„ÛŒØ¯ Ø´Ø¯Ù‡: {$todayGenerated}\n\n";
            
            $message .= "ğŸ“‹ <b>Ù‚Ø§Ù„Ø¨â€ŒÙ‡Ø§ÛŒ Ù…Ø­ØªÙˆØ§:</b>\n";
            $message .= "â”” Ú©Ù„ Ù‚Ø§Ù„Ø¨â€ŒÙ‡Ø§: {$totalTemplates}\n";
            $message .= "â”” Ù‚Ø§Ù„Ø¨â€ŒÙ‡Ø§ÛŒ ÙØ¹Ø§Ù„: {$activeTemplates}\n\n";
            
            $message .= "ğŸ”¥ <b>Ù…ØµØ±Ù ØªÙˆÚ©Ù†:</b>\n";
            $message .= "â”” Ú©Ù„ ØªÙˆÚ©Ù†â€ŒÙ‡Ø§ÛŒ Ù…ØµØ±ÙÛŒ: " . number_format($totalTokensUsed) . "\n\n";

            $message .= "ğŸ¯ <b>Ø¯Ø³ØªÙˆØ±Ø§Øª Ù…ÙˆØ¬ÙˆØ¯:</b>\n";
            $message .= "â€¢ /ai templates - Ù…Ø¯ÛŒØ±ÛŒØª Ù‚Ø§Ù„Ø¨â€ŒÙ‡Ø§\n";
            $message .= "â€¢ /ai generate - ØªÙˆÙ„ÛŒØ¯ Ù…Ø­ØªÙˆØ§\n";
            $message .= "â€¢ /ai history - ØªØ§Ø±ÛŒØ®Ú†Ù‡ Ù…Ø­ØªÙˆØ§\n";
            $message .= "â€¢ /ai settings - ØªÙ†Ø¸ÛŒÙ…Ø§Øª Ø³ÛŒØ³ØªÙ…\n";
            $message .= "â€¢ /ai stats - Ø¢Ù…Ø§Ø± ØªÙØµÛŒÙ„ÛŒ\n";

            $this->sendMessage($chatId, $message);

        } catch (\Exception $e) {
            Log::error('AI dashboard error: ' . $e->getMessage());
            $this->sendMessage($chatId, "âŒ Ø®Ø·Ø§ Ø¯Ø± Ø¨Ø§Ø±Ú¯Ø°Ø§Ø±ÛŒ Ø¯Ø§Ø´Ø¨ÙˆØ±Ø¯ Ù‡ÙˆØ´ Ù…ØµÙ†ÙˆØ¹ÛŒ");
        }
    }

    /**
     * Manage AI templates
     */
    private function manageAITemplates($chatId, array $args): void
    {
        try {
            $action = $args[0] ?? 'list';

            switch ($action) {
                case 'list':
                    $page = (int)($args[1] ?? 1);
                    $this->listAITemplates($chatId, $page);
                    break;

                case 'create':
                    $this->createAITemplateDialog($chatId);
                    break;

                case 'view':
                    $templateId = $args[1] ?? null;
                    if ($templateId) {
                        $this->viewAITemplate($chatId, $templateId);
                    } else {
                        $this->sendMessage($chatId, "âŒ Ø´Ù†Ø§Ø³Ù‡ Ù‚Ø§Ù„Ø¨ Ø±Ø§ ÙˆØ§Ø±Ø¯ Ú©Ù†ÛŒØ¯\n\nÙ…Ø«Ø§Ù„: /ai templates view 1");
                    }
                    break;

                case 'edit':
                    $templateId = $args[1] ?? null;
                    if ($templateId) {
                        $this->editAITemplateDialog($chatId, $templateId);
                    } else {
                        $this->sendMessage($chatId, "âŒ Ø´Ù†Ø§Ø³Ù‡ Ù‚Ø§Ù„Ø¨ Ø±Ø§ ÙˆØ§Ø±Ø¯ Ú©Ù†ÛŒØ¯\n\nÙ…Ø«Ø§Ù„: /ai templates edit 1");
                    }
                    break;

                case 'toggle':
                    $templateId = $args[1] ?? null;
                    if ($templateId) {
                        $this->toggleAITemplate($chatId, $templateId);
                    } else {
                        $this->sendMessage($chatId, "âŒ Ø´Ù†Ø§Ø³Ù‡ Ù‚Ø§Ù„Ø¨ Ø±Ø§ ÙˆØ§Ø±Ø¯ Ú©Ù†ÛŒØ¯\n\nÙ…Ø«Ø§Ù„: /ai templates toggle 1");
                    }
                    break;

                case 'delete':
                    $templateId = $args[1] ?? null;
                    if ($templateId) {
                        $this->deleteAITemplate($chatId, $templateId);
                    } else {
                        $this->sendMessage($chatId, "âŒ Ø´Ù†Ø§Ø³Ù‡ Ù‚Ø§Ù„Ø¨ Ø±Ø§ ÙˆØ§Ø±Ø¯ Ú©Ù†ÛŒØ¯\n\nÙ…Ø«Ø§Ù„: /ai templates delete 1");
                    }
                    break;

                default:
                    $this->sendMessage($chatId, "âŒ Ø¯Ø³ØªÙˆØ± Ù†Ø§Ù…Ø¹ØªØ¨Ø±\n\nØ¯Ø³ØªÙˆØ±Ø§Øª Ù…ÙˆØ¬ÙˆØ¯:\nâ€¢ list, create, view, edit, toggle, delete");
                    break;
            }

        } catch (\Exception $e) {
            Log::error('AI templates management error: ' . $e->getMessage());
            $this->sendMessage($chatId, "âŒ Ø®Ø·Ø§ Ø¯Ø± Ù…Ø¯ÛŒØ±ÛŒØª Ù‚Ø§Ù„Ø¨â€ŒÙ‡Ø§");
        }
    }

    /**
     * List AI templates
     */
    private function listAITemplates($chatId, int $page = 1): void
    {
        try {
            $perPage = 10;
            $offset = ($page - 1) * $perPage;

            $templates = DB::table('ai_content_templates')
                ->select('id', 'name', 'category', 'is_active', 'usage_count', 'created_at')
                ->orderBy('created_at', 'desc')
                ->limit($perPage)
                ->offset($offset)
                ->get();

            $totalTemplates = DB::table('ai_content_templates')->count();
            $totalPages = ceil($totalTemplates / $perPage);

            if ($templates->isEmpty()) {
                $this->sendMessage($chatId, "ğŸ“‹ Ù‡ÛŒÚ† Ù‚Ø§Ù„Ø¨ÛŒ ÛŒØ§ÙØª Ù†Ø´Ø¯\n\nØ¨Ø±Ø§ÛŒ Ø§ÛŒØ¬Ø§Ø¯ Ù‚Ø§Ù„Ø¨ Ø¬Ø¯ÛŒØ¯ Ø§Ø² Ø¯Ø³ØªÙˆØ± Ø²ÛŒØ± Ø§Ø³ØªÙØ§Ø¯Ù‡ Ú©Ù†ÛŒØ¯:\n/ai templates create");
                return;
            }

            $message = "ğŸ“‹ <b>Ù„ÛŒØ³Øª Ù‚Ø§Ù„Ø¨â€ŒÙ‡Ø§ÛŒ Ù‡ÙˆØ´ Ù…ØµÙ†ÙˆØ¹ÛŒ</b>\n";
            $message .= "ØµÙØ­Ù‡ {$page} Ø§Ø² {$totalPages} (Ú©Ù„: {$totalTemplates})\n\n";

            foreach ($templates as $template) {
                $statusIcon = $template->is_active ? 'âœ…' : 'âŒ';
                $typeText = $this->getTemplateTypeText($template->category);
                $createdAt = \Carbon\Carbon::parse($template->created_at)->format('Y/m/d');
                
                $message .= "{$statusIcon} <b>{$template->name}</b> (ID: {$template->id})\n";
                $message .= "â”” Ù†ÙˆØ¹: {$typeText}\n";
                $message .= "â”” Ø§Ø³ØªÙØ§Ø¯Ù‡: {$template->usage_count} Ø¨Ø§Ø±\n";
                $message .= "â”” ØªØ§Ø±ÛŒØ®: {$createdAt}\n\n";
            }

            $message .= "ğŸ”§ <b>Ø¯Ø³ØªÙˆØ±Ø§Øª:</b>\n";
            $message .= "â€¢ /ai templates view &lt;ID&gt; - Ù†Ù…Ø§ÛŒØ´ Ø¬Ø²Ø¦ÛŒØ§Øª\n";
            $message .= "â€¢ /ai templates edit &lt;ID&gt; - ÙˆÛŒØ±Ø§ÛŒØ´ Ù‚Ø§Ù„Ø¨\n";
            $message .= "â€¢ /ai templates toggle &lt;ID&gt; - ÙØ¹Ø§Ù„/ØºÛŒØ±ÙØ¹Ø§Ù„\n";
            $message .= "â€¢ /ai templates delete &lt;ID&gt; - Ø­Ø°Ù Ù‚Ø§Ù„Ø¨\n";

            if ($totalPages > 1) {
                $message .= "\nğŸ“„ ØµÙØ­Ù‡â€ŒØ¨Ù†Ø¯ÛŒ:\n";
                if ($page > 1) {
                    $message .= "â€¢ /ai templates list " . ($page - 1) . " - ØµÙØ­Ù‡ Ù‚Ø¨Ù„\n";
                }
                if ($page < $totalPages) {
                    $message .= "â€¢ /ai templates list " . ($page + 1) . " - ØµÙØ­Ù‡ Ø¨Ø¹Ø¯\n";
                }
            }

            $this->sendMessage($chatId, $message);

        } catch (\Exception $e) {
            Log::error('List AI templates error: ' . $e->getMessage());
            $this->sendMessage($chatId, "âŒ Ø®Ø·Ø§ Ø¯Ø± Ø¨Ø§Ø±Ú¯Ø°Ø§Ø±ÛŒ Ù„ÛŒØ³Øª Ù‚Ø§Ù„Ø¨â€ŒÙ‡Ø§");
        }
    }

    /**
     * Generate AI content
     */
    private function generateAIContent($chatId, array $args): void
    {
        try {
            $templateId = $args[0] ?? null;
            $prompt = implode(' ', array_slice($args, 1));

            if (!$templateId) {
                $this->sendMessage($chatId, "âŒ Ø´Ù†Ø§Ø³Ù‡ Ù‚Ø§Ù„Ø¨ Ø±Ø§ ÙˆØ§Ø±Ø¯ Ú©Ù†ÛŒØ¯\n\nÙ…Ø«Ø§Ù„: /ai generate 1 Ù…ØªÙ† ØªØ¨Ù„ÛŒØºØ§ØªÛŒ Ø¨Ø±Ø§ÛŒ Ù…Ø­ØµÙˆÙ„ Ø¬Ø¯ÛŒØ¯");
                return;
            }

            // Get template
            $template = DB::table('ai_content_templates')
                ->where('id', $templateId)
                ->where('is_active', true)
                ->first();

            if (!$template) {
                $this->sendMessage($chatId, "âŒ Ù‚Ø§Ù„Ø¨ ÛŒØ§ÙØª Ù†Ø´Ø¯ ÛŒØ§ ØºÛŒØ±ÙØ¹Ø§Ù„ Ø§Ø³Øª");
                return;
            }

            $this->sendMessage($chatId, "ğŸ¤– Ø¯Ø± Ø­Ø§Ù„ ØªÙˆÙ„ÛŒØ¯ Ù…Ø­ØªÙˆØ§ Ø¨Ø§ Ù‡ÙˆØ´ Ù…ØµÙ†ÙˆØ¹ÛŒ...\nÙ„Ø·ÙØ§Ù‹ ØµØ¨Ø± Ú©Ù†ÛŒØ¯...");

            // Generate content using AI service
            $aiContent = $this->callAIService($template, $prompt);

            if (!$aiContent) {
                $this->sendMessage($chatId, "âŒ Ø®Ø·Ø§ Ø¯Ø± ØªÙˆÙ„ÛŒØ¯ Ù…Ø­ØªÙˆØ§. Ù„Ø·ÙØ§Ù‹ Ù…Ø¬Ø¯Ø¯Ø§Ù‹ ØªÙ„Ø§Ø´ Ú©Ù†ÛŒØ¯.");
                return;
            }

            // Update template usage
            DB::table('ai_content_templates')
                ->where('id', $templateId)
                ->increment('usage_count');

            // Log AI content generation
            $this->logAudit('ai_content_generated', [
                'admin_id' => $this->getAdminIdFromChatId($chatId),
                'template_id' => $templateId,
                'prompt' => $prompt,
                'content_length' => strlen($aiContent['content']),
                'tokens_used' => $aiContent['tokens_used'] ?? 0
            ]);

            $message = "âœ¨ <b>Ù…Ø­ØªÙˆØ§ÛŒ ØªÙˆÙ„ÛŒØ¯ Ø´Ø¯Ù‡:</b>\n\n";
            $message .= $aiContent['content'] . "\n\n";
            $message .= "ğŸ“Š <b>Ø§Ø·Ù„Ø§Ø¹Ø§Øª ØªÚ©Ù…ÛŒÙ„ÛŒ:</b>\n";
            $message .= "â”” Ù‚Ø§Ù„Ø¨: {$template->name}\n";
            $message .= "â”” ØªÙˆÚ©Ù†â€ŒÙ‡Ø§ÛŒ Ù…ØµØ±ÙÛŒ: " . ($aiContent['tokens_used'] ?? 0) . "\n";
            $message .= "â”” Ø²Ù…Ø§Ù† ØªÙˆÙ„ÛŒØ¯: " . now()->format('Y/m/d H:i:s');

            $this->sendMessage($chatId, $message);

        } catch (\Exception $e) {
            Log::error('AI content generation error: ' . $e->getMessage());
            $this->sendMessage($chatId, "âŒ Ø®Ø·Ø§ Ø¯Ø± ØªÙˆÙ„ÛŒØ¯ Ù…Ø­ØªÙˆØ§");
        }
    }

    /**
     * Call AI service for content generation
     */
    private function callAIService($template, $prompt): ?array
    {
        try {
            $apiKey = env('OPENAI_API_KEY');
            if (!$apiKey) {
                Log::error('OpenAI API key not configured');
                return null;
            }

            $parameters = json_decode($template->parameters, true) ?? [];
            $systemPrompt = $parameters['system_prompt'] ?? 'Ø´Ù…Ø§ ÛŒÚ© Ø¯Ø³ØªÛŒØ§Ø± Ù‡ÙˆØ´Ù…Ù†Ø¯ Ù‡Ø³ØªÛŒØ¯ Ú©Ù‡ Ù…Ø­ØªÙˆØ§ÛŒ Ø¨Ø§Ú©ÛŒÙÛŒØª Ø¨Ù‡ Ø²Ø¨Ø§Ù† ÙØ§Ø±Ø³ÛŒ ØªÙˆÙ„ÛŒØ¯ Ù…ÛŒâ€ŒÚ©Ù†ÛŒØ¯.';
            $userPrompt = $template->prompt_template ?? '{input}';
            $finalPrompt = str_replace('{input}', $prompt, $userPrompt);

            $data = [
                'model' => 'gpt-3.5-turbo',
                'messages' => [
                    [
                        'role' => 'system',
                        'content' => $systemPrompt
                    ],
                    [
                        'role' => 'user',
                        'content' => $finalPrompt
                    ]
                ],
                'max_tokens' => 1000,
                'temperature' => 0.7
            ];

            $context = stream_context_create([
                'http' => [
                    'method' => 'POST',
                    'header' => [
                        'Content-Type: application/json',
                        'Authorization: Bearer ' . $apiKey
                    ],
                    'content' => json_encode($data),
                    'proxy' => 'tcp://127.0.0.1:1090'
                ]
            ]);

            $response = file_get_contents('https://api.openai.com/v1/chat/completions', false, $context);
            
            if ($response === false) {
                Log::error('Failed to call OpenAI API');
                return null;
            }

            $result = json_decode($response, true);
            
            if (!isset($result['choices'][0]['message']['content'])) {
                Log::error('Invalid OpenAI response', ['response' => $result]);
                return null;
            }

            return [
                'content' => $result['choices'][0]['message']['content'],
                'tokens_used' => $result['usage']['total_tokens'] ?? 0
            ];

        } catch (\Exception $e) {
            Log::error('AI service call error: ' . $e->getMessage());
            return null;
        }
    }

    /**
     * Show AI content generation statistics
     */
    private function showAIStats($chatId): void
    {
        try {
            // Today's stats
            $todayCount = DB::table('ai_content_templates')
                ->whereDate('created_at', today())
                ->count();

            $todayTokens = 0; // Will implement token tracking later

            // This week's stats
            $weekCount = DB::table('ai_content_templates')
                ->whereBetween('created_at', [now()->startOfWeek(), now()->endOfWeek()])
                ->count();

            $weekTokens = 0; // Will implement token tracking later

            // Most used templates
            $topTemplates = DB::table('ai_content_templates')
                ->select('name', 'usage_count', 'category')
                ->orderBy('usage_count', 'desc')
                ->limit(5)
                ->get();

            // Template type distribution
            $typeStats = DB::table('ai_content_templates')
                ->select('category', DB::raw('COUNT(*) as count'))
                ->groupBy('category')
                ->orderBy('count', 'desc')
                ->get();

            $message = "ğŸ“Š <b>Ø¢Ù…Ø§Ø± Ù‡ÙˆØ´ Ù…ØµÙ†ÙˆØ¹ÛŒ</b>\n\n";
            
            $message .= "ğŸ“… <b>Ø§Ù…Ø±ÙˆØ²:</b>\n";
            $message .= "â”” Ù…Ø­ØªÙˆØ§ÛŒ ØªÙˆÙ„ÛŒØ¯ Ø´Ø¯Ù‡: {$todayCount}\n";
            $message .= "â”” ØªÙˆÚ©Ù† Ù…ØµØ±ÙÛŒ: " . number_format($todayTokens) . "\n\n";
            
            $message .= "ğŸ“ˆ <b>Ø§ÛŒÙ† Ù‡ÙØªÙ‡:</b>\n";
            $message .= "â”” Ù…Ø­ØªÙˆØ§ÛŒ ØªÙˆÙ„ÛŒØ¯ Ø´Ø¯Ù‡: {$weekCount}\n";
            $message .= "â”” ØªÙˆÚ©Ù† Ù…ØµØ±ÙÛŒ: " . number_format($weekTokens) . "\n\n";

            if ($topTemplates->isNotEmpty()) {
                $message .= "ğŸ† <b>Ù¾Ø±Ø¨Ø§Ø²Ø¯ÛŒØ¯ØªØ±ÛŒÙ† Ù‚Ø§Ù„Ø¨â€ŒÙ‡Ø§:</b>\n";
                foreach ($topTemplates as $template) {
                    $typeText = $this->getTemplateTypeText($template->category);
                    $message .= "â”” {$template->name} ({$typeText}): {$template->usage_count} Ø¨Ø§Ø±\n";
                }
                $message .= "\n";
            }

            if ($typeStats->isNotEmpty()) {
                $message .= "ğŸ“‹ <b>ØªÙˆØ²ÛŒØ¹ Ø§Ù†ÙˆØ§Ø¹ Ù‚Ø§Ù„Ø¨:</b>\n";
                foreach ($typeStats as $stat) {
                    $typeText = $this->getTemplateTypeText($stat->category);
                    $message .= "â”” {$typeText}: {$stat->count} Ù‚Ø§Ù„Ø¨\n";
                }
            }

            $this->sendMessage($chatId, $message);

        } catch (\Exception $e) {
            Log::error('AI stats error: ' . $e->getMessage());
            $this->sendMessage($chatId, "âŒ Ø®Ø·Ø§ Ø¯Ø± Ø¨Ø§Ø±Ú¯Ø°Ø§Ø±ÛŒ Ø¢Ù…Ø§Ø± Ù‡ÙˆØ´ Ù…ØµÙ†ÙˆØ¹ÛŒ");
        }
    }

    /**
     * Get template type text in Persian
     */
    private function getTemplateTypeText($type): string
    {
        $types = [
            'marketing' => 'Ø¨Ø§Ø²Ø§Ø±ÛŒØ§Ø¨ÛŒ',
            'social_media' => 'Ø´Ø¨Ú©Ù‡â€ŒÙ‡Ø§ÛŒ Ø§Ø¬ØªÙ…Ø§Ø¹ÛŒ',
            'blog_post' => 'Ù…Ù‚Ø§Ù„Ù‡ ÙˆØ¨Ù„Ø§Ú¯',
            'email' => 'Ø§ÛŒÙ…ÛŒÙ„',
            'product_description' => 'ØªÙˆØ¶ÛŒØ­ Ù…Ø­ØµÙˆÙ„',
            'seo_content' => 'Ù…Ø­ØªÙˆØ§ÛŒ Ø³Ø¦Ùˆ',
            'creative_writing' => 'Ù†ÙˆØ´ØªØ§Ø± Ø®Ù„Ø§Ù‚Ø§Ù†Ù‡',
            'technical' => 'ÙÙ†ÛŒ',
            'educational' => 'Ø¢Ù…ÙˆØ²Ø´ÛŒ',
            'other' => 'Ø³Ø§ÛŒØ±'
        ];

        return $types[$type] ?? $type;
    }

    /**
     * Show AI help
     */
    private function showAIHelp($chatId): void
    {
        $message = "ğŸ¤– <b>Ø±Ø§Ù‡Ù†Ù…Ø§ÛŒ Ø³ÛŒØ³ØªÙ… Ù‡ÙˆØ´ Ù…ØµÙ†ÙˆØ¹ÛŒ</b>\n\n";
        
        $message .= "ğŸ“‹ <b>Ù…Ø¯ÛŒØ±ÛŒØª Ù‚Ø§Ù„Ø¨â€ŒÙ‡Ø§:</b>\n";
        $message .= "â€¢ /ai templates list - Ù„ÛŒØ³Øª Ù‚Ø§Ù„Ø¨â€ŒÙ‡Ø§\n";
        $message .= "â€¢ /ai templates create - Ø§ÛŒØ¬Ø§Ø¯ Ù‚Ø§Ù„Ø¨ Ø¬Ø¯ÛŒØ¯\n";
        $message .= "â€¢ /ai templates view &lt;ID&gt; - Ù†Ù…Ø§ÛŒØ´ Ù‚Ø§Ù„Ø¨\n";
        $message .= "â€¢ /ai templates edit &lt;ID&gt; - ÙˆÛŒØ±Ø§ÛŒØ´ Ù‚Ø§Ù„Ø¨\n";
        $message .= "â€¢ /ai templates toggle &lt;ID&gt; - ÙØ¹Ø§Ù„/ØºÛŒØ±ÙØ¹Ø§Ù„\n\n";
        
        $message .= "âœ¨ <b>ØªÙˆÙ„ÛŒØ¯ Ù…Ø­ØªÙˆØ§:</b>\n";
        $message .= "â€¢ /ai generate &lt;ID&gt; [Ø¯Ø±Ø®ÙˆØ§Ø³Øª] - ØªÙˆÙ„ÛŒØ¯ Ù…Ø­ØªÙˆØ§\n";
        $message .= "Ù…Ø«Ø§Ù„: /ai generate 1 Ù…Ø­ØªÙˆØ§ÛŒ ØªØ¨Ù„ÛŒØºØ§ØªÛŒ Ø¨Ø±Ø§ÛŒ ÙØ±ÙˆØ´ Ú©ÙØ´\n\n";
        
        $message .= "ğŸ“Š <b>Ø¢Ù…Ø§Ø± Ùˆ Ú¯Ø²Ø§Ø±Ø´:</b>\n";
        $message .= "â€¢ /ai history - ØªØ§Ø±ÛŒØ®Ú†Ù‡ Ù…Ø­ØªÙˆØ§\n";
        $message .= "â€¢ /ai stats - Ø¢Ù…Ø§Ø± ØªÙØµÛŒÙ„ÛŒ\n";
        $message .= "â€¢ /ai settings - ØªÙ†Ø¸ÛŒÙ…Ø§Øª Ø³ÛŒØ³ØªÙ…\n\n";
        
        $message .= "â„¹ï¸ Ø¨Ø±Ø§ÛŒ Ø¯Ø±ÛŒØ§ÙØª Ø¯Ø§Ø´Ø¨ÙˆØ±Ø¯ Ú©Ø§Ù…Ù„ Ø§Ø² /ai Ø§Ø³ØªÙØ§Ø¯Ù‡ Ú©Ù†ÛŒØ¯";

        $this->sendMessage($chatId, $message);
    }

    /**
     * View AI template details
     */
    private function viewAITemplate($chatId, $templateId): void
    {
        try {
            $template = DB::table('ai_content_templates')
                ->where('id', $templateId)
                ->first();

            if (!$template) {
                $this->sendMessage($chatId, "âŒ Ù‚Ø§Ù„Ø¨ ÛŒØ§ÙØª Ù†Ø´Ø¯");
                return;
            }

            $statusIcon = $template->is_active ? 'âœ… ÙØ¹Ø§Ù„' : 'âŒ ØºÛŒØ±ÙØ¹Ø§Ù„';
            $typeText = $this->getTemplateTypeText($template->category);
            $createdAt = \Carbon\Carbon::parse($template->created_at)->format('Y/m/d H:i');
            $parameters = json_decode($template->parameters, true) ?? [];

            $message = "ğŸ“‹ <b>Ø¬Ø²Ø¦ÛŒØ§Øª Ù‚Ø§Ù„Ø¨ Ù‡ÙˆØ´ Ù…ØµÙ†ÙˆØ¹ÛŒ</b>\n\n";
            $message .= "ğŸ·ï¸ <b>Ù†Ø§Ù…:</b> {$template->name}\n";
            $message .= "ğŸ†” <b>Ø´Ù†Ø§Ø³Ù‡:</b> {$template->id}\n";
            $message .= "ğŸ“ <b>Ù†ÙˆØ¹:</b> {$typeText}\n";
            $message .= "ğŸ“Š <b>ÙˆØ¶Ø¹ÛŒØª:</b> {$statusIcon}\n";
            $message .= "ğŸ”¢ <b>ØªØ¹Ø¯Ø§Ø¯ Ø§Ø³ØªÙØ§Ø¯Ù‡:</b> {$template->usage_count} Ø¨Ø§Ø±\n";
            $message .= "ğŸ•’ <b>ØªØ§Ø±ÛŒØ® Ø§ÛŒØ¬Ø§Ø¯:</b> {$createdAt}\n\n";
            
            if (isset($parameters['system_prompt'])) {
                $systemPrompt = strlen($parameters['system_prompt']) > 100 
                    ? substr($parameters['system_prompt'], 0, 100) . '...' 
                    : $parameters['system_prompt'];
                $message .= "ğŸ¯ <b>Ø¯Ø³ØªÙˆØ±Ø§Ù„Ø¹Ù…Ù„ Ø³ÛŒØ³ØªÙ…:</b>\n{$systemPrompt}\n\n";
            }

            if ($template->prompt_template) {
                $userPrompt = strlen($template->prompt_template) > 100 
                    ? substr($template->prompt_template, 0, 100) . '...' 
                    : $template->prompt_template;
                $message .= "ğŸ’¬ <b>Ù‚Ø§Ù„Ø¨ Ø¯Ø±Ø®ÙˆØ§Ø³Øª:</b>\n{$userPrompt}\n\n";
            }

            $message .= "âš¡ <b>Ø¯Ø³ØªÙˆØ±Ø§Øª:</b>\n";
            $message .= "â€¢ /ai templates edit {$templateId} - ÙˆÛŒØ±Ø§ÛŒØ´\n";
            $message .= "â€¢ /ai templates toggle {$templateId} - ØªØºÛŒÛŒØ± ÙˆØ¶Ø¹ÛŒØª\n";
            $message .= "â€¢ /ai generate {$templateId} [Ù…ØªÙ†] - ØªÙˆÙ„ÛŒØ¯ Ù…Ø­ØªÙˆØ§\n";

            $this->sendMessage($chatId, $message);

        } catch (\Exception $e) {
            Log::error('View AI template error: ' . $e->getMessage());
            $this->sendMessage($chatId, "âŒ Ø®Ø·Ø§ Ø¯Ø± Ù†Ù…Ø§ÛŒØ´ Ù‚Ø§Ù„Ø¨");
        }
    }

    /**
     * Create AI template dialog
     */
    private function createAITemplateDialog($chatId): void
    {
        $message = "ğŸ“ <b>Ø§ÛŒØ¬Ø§Ø¯ Ù‚Ø§Ù„Ø¨ Ø¬Ø¯ÛŒØ¯ Ù‡ÙˆØ´ Ù…ØµÙ†ÙˆØ¹ÛŒ</b>\n\n";
        $message .= "Ø¨Ø±Ø§ÛŒ Ø§ÛŒØ¬Ø§Ø¯ Ù‚Ø§Ù„Ø¨ Ø¬Ø¯ÛŒØ¯ØŒ Ø§Ø·Ù„Ø§Ø¹Ø§Øª Ø²ÛŒØ± Ø±Ø§ Ø§Ø±Ø³Ø§Ù„ Ú©Ù†ÛŒØ¯:\n\n";
        $message .= "ğŸ“‹ <b>ÙØ±Ù…Øª:</b>\n";
        $message .= "Ù†Ø§Ù…: Ù†Ø§Ù… Ù‚Ø§Ù„Ø¨\n";
        $message .= "Ù†ÙˆØ¹: marketing|social_media|blog_post|email|product_description|seo_content|creative_writing|technical|educational|other\n";
        $message .= "ØªÙˆØ¶ÛŒØ­Ø§Øª: ØªÙˆØ¶ÛŒØ­ Ù…Ø®ØªØµØ±\n";
        $message .= "Ø¯Ø³ØªÙˆØ±Ø§Ù„Ø¹Ù…Ù„: Ø¯Ø³ØªÙˆØ±Ø§Ù„Ø¹Ù…Ù„ Ø³ÛŒØ³ØªÙ…\n";
        $message .= "Ù‚Ø§Ù„Ø¨: Ù‚Ø§Ù„Ø¨ Ø¯Ø±Ø®ÙˆØ§Ø³Øª Ú©Ø§Ø±Ø¨Ø±\n\n";
        $message .= "ğŸ’¡ <b>Ù…Ø«Ø§Ù„:</b>\n";
        $message .= "Ù†Ø§Ù…: ØªÙˆÙ„ÛŒØ¯ Ù…Ø­ØªÙˆØ§ÛŒ Ø¨Ø§Ø²Ø§Ø±ÛŒØ§Ø¨ÛŒ\n";
        $message .= "Ù†ÙˆØ¹: marketing\n";
        $message .= "ØªÙˆØ¶ÛŒØ­Ø§Øª: Ù‚Ø§Ù„Ø¨ ØªÙˆÙ„ÛŒØ¯ Ù…ØªÙ† ØªØ¨Ù„ÛŒØºØ§ØªÛŒ\n";
        $message .= "Ø¯Ø³ØªÙˆØ±Ø§Ù„Ø¹Ù…Ù„: Ø´Ù…Ø§ ÛŒÚ© Ù…ØªØ®ØµØµ Ø¨Ø§Ø²Ø§Ø±ÛŒØ§Ø¨ÛŒ Ù‡Ø³ØªÛŒØ¯\n";
        $message .= "Ù‚Ø§Ù„Ø¨: Ù…Ø­ØªÙˆØ§ÛŒ ØªØ¨Ù„ÛŒØºØ§ØªÛŒ Ø¨Ø±Ø§ÛŒ {prompt} ØªÙˆÙ„ÛŒØ¯ Ú©Ù†\n\n";
        $message .= "â„¹ï¸ Ø¨Ø±Ø§ÛŒ Ù„ØºÙˆ Ø¹Ù…Ù„ÛŒØ§Øª /ai templates list Ø±Ø§ Ø§Ø±Ø³Ø§Ù„ Ú©Ù†ÛŒØ¯";

        $this->sendMessage($chatId, $message);
    }

    /**
     * Toggle AI template status
     */
    private function toggleAITemplate($chatId, $templateId): void
    {
        try {
            $template = DB::table('ai_content_templates')
                ->where('id', $templateId)
                ->first();

            if (!$template) {
                $this->sendMessage($chatId, "âŒ Ù‚Ø§Ù„Ø¨ ÛŒØ§ÙØª Ù†Ø´Ø¯");
                return;
            }

            $newStatus = !$template->is_active;
            $statusText = $newStatus ? 'ÙØ¹Ø§Ù„' : 'ØºÛŒØ±ÙØ¹Ø§Ù„';

            DB::table('ai_content_templates')
                ->where('id', $templateId)
                ->update(['is_active' => $newStatus]);

            // Log the action
            $this->logAudit('ai_template_toggled', [
                'admin_id' => $this->getAdminIdFromChatId($chatId),
                'template_id' => $templateId,
                'old_status' => $template->is_active,
                'new_status' => $newStatus
            ]);

            $message = "âœ… ÙˆØ¶Ø¹ÛŒØª Ù‚Ø§Ù„Ø¨ Ø¨Ø§ Ù…ÙˆÙÙ‚ÛŒØª ØªØºÛŒÛŒØ± Ú©Ø±Ø¯\n\n";
            $message .= "ğŸ“‹ <b>Ù‚Ø§Ù„Ø¨:</b> {$template->name}\n";
            $message .= "ğŸ“Š <b>ÙˆØ¶Ø¹ÛŒØª Ø¬Ø¯ÛŒØ¯:</b> {$statusText}";

            $this->sendMessage($chatId, $message);

        } catch (\Exception $e) {
            Log::error('Toggle AI template error: ' . $e->getMessage());
            $this->sendMessage($chatId, "âŒ Ø®Ø·Ø§ Ø¯Ø± ØªØºÛŒÛŒØ± ÙˆØ¶Ø¹ÛŒØª Ù‚Ø§Ù„Ø¨");
        }
    }

    /**
     * Delete AI template
     */
    private function deleteAITemplate($chatId, $templateId): void
    {
        try {
            $template = DB::table('ai_content_templates')
                ->where('id', $templateId)
                ->first();

            if (!$template) {
                $this->sendMessage($chatId, "âŒ Ù‚Ø§Ù„Ø¨ ÛŒØ§ÙØª Ù†Ø´Ø¯");
                return;
            }

            DB::table('ai_content_templates')
                ->where('id', $templateId)
                ->delete();

            // Log the action
            $this->logAudit('ai_template_deleted', [
                'admin_id' => $this->getAdminIdFromChatId($chatId),
                'template_id' => $templateId,
                'template_name' => $template->name
            ]);

            $message = "âœ… Ù‚Ø§Ù„Ø¨ Ø¨Ø§ Ù…ÙˆÙÙ‚ÛŒØª Ø­Ø°Ù Ø´Ø¯\n\n";
            $message .= "ğŸ“‹ <b>Ù‚Ø§Ù„Ø¨ Ø­Ø°Ù Ø´Ø¯Ù‡:</b> {$template->name}\n";
            $message .= "ğŸ—‘ï¸ <b>Ø¹Ù…Ù„ÛŒØ§Øª:</b> Ø­Ø°Ù Ú©Ø§Ù…Ù„ Ø§Ø² Ø³ÛŒØ³ØªÙ…";

            $this->sendMessage($chatId, $message);

        } catch (\Exception $e) {
            Log::error('Delete AI template error: ' . $e->getMessage());
            $this->sendMessage($chatId, "âŒ Ø®Ø·Ø§ Ø¯Ø± Ø­Ø°Ù Ù‚Ø§Ù„Ø¨");
        }
    }

    /**
     * Edit AI template dialog
     */
    private function editAITemplateDialog($chatId, $templateId): void
    {
        try {
            $template = DB::table('ai_content_templates')
                ->where('id', $templateId)
                ->first();

            if (!$template) {
                $this->sendMessage($chatId, "âŒ Ù‚Ø§Ù„Ø¨ ÛŒØ§ÙØª Ù†Ø´Ø¯");
                return;
            }

            $message = "âœï¸ <b>ÙˆÛŒØ±Ø§ÛŒØ´ Ù‚Ø§Ù„Ø¨ Ù‡ÙˆØ´ Ù…ØµÙ†ÙˆØ¹ÛŒ</b>\n\n";
            $message .= "ğŸ·ï¸ <b>Ù‚Ø§Ù„Ø¨ ÙØ¹Ù„ÛŒ:</b> {$template->name}\n\n";
            $message .= "Ø¨Ø±Ø§ÛŒ ÙˆÛŒØ±Ø§ÛŒØ´ØŒ Ø§Ø·Ù„Ø§Ø¹Ø§Øª Ø¬Ø¯ÛŒØ¯ Ø±Ø§ Ø¨Ù‡ ÙØ±Ù…Øª Ø²ÛŒØ± Ø§Ø±Ø³Ø§Ù„ Ú©Ù†ÛŒØ¯:\n\n";
            $message .= "ğŸ“‹ <b>ÙØ±Ù…Øª ÙˆÛŒØ±Ø§ÛŒØ´:</b>\n";
            $message .= "Ù†Ø§Ù…: Ù†Ø§Ù… Ø¬Ø¯ÛŒØ¯ (Ø§Ø®ØªÛŒØ§Ø±ÛŒ)\n";
            $message .= "Ù†ÙˆØ¹: Ù†ÙˆØ¹ Ø¬Ø¯ÛŒØ¯ (Ø§Ø®ØªÛŒØ§Ø±ÛŒ)\n";
            $message .= "ØªÙˆØ¶ÛŒØ­Ø§Øª: ØªÙˆØ¶ÛŒØ­Ø§Øª Ø¬Ø¯ÛŒØ¯ (Ø§Ø®ØªÛŒØ§Ø±ÛŒ)\n";
            $message .= "Ø¯Ø³ØªÙˆØ±Ø§Ù„Ø¹Ù…Ù„: Ø¯Ø³ØªÙˆØ±Ø§Ù„Ø¹Ù…Ù„ Ø¬Ø¯ÛŒØ¯ (Ø§Ø®ØªÛŒØ§Ø±ÛŒ)\n";
            $message .= "Ù‚Ø§Ù„Ø¨: Ù‚Ø§Ù„Ø¨ Ø¬Ø¯ÛŒØ¯ (Ø§Ø®ØªÛŒØ§Ø±ÛŒ)\n\n";
            $message .= "ğŸ’¡ ÙÙ‚Ø· ÙÛŒÙ„Ø¯Ù‡Ø§ÛŒÛŒ Ú©Ù‡ Ù…ÛŒâ€ŒØ®ÙˆØ§Ù‡ÛŒØ¯ ØªØºÛŒÛŒØ± Ø¯Ù‡ÛŒØ¯ Ø±Ø§ ÙˆØ§Ø±Ø¯ Ú©Ù†ÛŒØ¯\n\n";
            $message .= "â„¹ï¸ Ø¨Ø±Ø§ÛŒ Ù„ØºÙˆ Ø¹Ù…Ù„ÛŒØ§Øª /ai templates view {$templateId} Ø±Ø§ Ø§Ø±Ø³Ø§Ù„ Ú©Ù†ÛŒØ¯";

            $this->sendMessage($chatId, $message);

        } catch (\Exception $e) {
            Log::error('Edit AI template dialog error: ' . $e->getMessage());
            $this->sendMessage($chatId, "âŒ Ø®Ø·Ø§ Ø¯Ø± Ù†Ù…Ø§ÛŒØ´ ÙØ±Ù… ÙˆÛŒØ±Ø§ÛŒØ´");
        }
    }

    /**
     * Show AI content history
     */
    private function showAIContentHistory($chatId, array $args): void
    {
        try {
            $page = (int)($args[0] ?? 1);
            $perPage = 10;
            $offset = ($page - 1) * $perPage;

            // For now, we'll show template usage history
            $templates = DB::table('ai_content_templates')
                ->select('id', 'name', 'usage_count', 'updated_at')
                ->where('usage_count', '>', 0)
                ->orderBy('updated_at', 'desc')
                ->limit($perPage)
                ->offset($offset)
                ->get();

            if ($templates->isEmpty()) {
                $this->sendMessage($chatId, "ğŸ“‹ Ù‡ÛŒÚ† ØªØ§Ø±ÛŒØ®Ú†Ù‡â€ŒØ§ÛŒ ÛŒØ§ÙØª Ù†Ø´Ø¯\n\nÙ‡Ù†ÙˆØ² Ù…Ø­ØªÙˆØ§ÛŒÛŒ ØªÙˆÙ„ÛŒØ¯ Ù†Ø´Ø¯Ù‡ Ø§Ø³Øª.");
                return;
            }

            $message = "ğŸ“œ <b>ØªØ§Ø±ÛŒØ®Ú†Ù‡ Ù…Ø­ØªÙˆØ§ÛŒ Ù‡ÙˆØ´ Ù…ØµÙ†ÙˆØ¹ÛŒ</b>\n";
            $message .= "ØµÙØ­Ù‡ {$page}\n\n";

            foreach ($templates as $template) {
                $lastUsed = \Carbon\Carbon::parse($template->updated_at)->format('Y/m/d H:i');
                $message .= "ğŸ“„ <b>{$template->name}</b> (ID: {$template->id})\n";
                $message .= "â”” Ø§Ø³ØªÙØ§Ø¯Ù‡: {$template->usage_count} Ø¨Ø§Ø±\n";
                $message .= "â”” Ø¢Ø®Ø±ÛŒÙ† Ø¨Ø§Ø±: {$lastUsed}\n\n";
            }

            $message .= "ğŸ”„ Ø¨Ø±Ø§ÛŒ Ù…Ø´Ø§Ù‡Ø¯Ù‡ ØµÙØ­Ù‡ Ø¨Ø¹Ø¯: /ai history " . ($page + 1);

            $this->sendMessage($chatId, $message);

        } catch (\Exception $e) {
            Log::error('AI history error: ' . $e->getMessage());
            $this->sendMessage($chatId, "âŒ Ø®Ø·Ø§ Ø¯Ø± Ø¨Ø§Ø±Ú¯Ø°Ø§Ø±ÛŒ ØªØ§Ø±ÛŒØ®Ú†Ù‡");
        }
    }

    /**
     * Manage AI settings
     */
    private function manageAISettings($chatId, array $args): void
    {
        try {
            $action = $args[0] ?? 'show';

            switch ($action) {
                case 'show':
                    $this->showAISettings($chatId);
                    break;

                case 'set':
                    $setting = $args[1] ?? '';
                    $value = implode(' ', array_slice($args, 2));
                    $this->setAISetting($chatId, $setting, $value);
                    break;

                default:
                    $this->sendMessage($chatId, "âŒ Ø¯Ø³ØªÙˆØ± Ù†Ø§Ù…Ø¹ØªØ¨Ø±\n\nØ¯Ø³ØªÙˆØ±Ø§Øª Ù…ÙˆØ¬ÙˆØ¯:\nâ€¢ show, set");
                    break;
            }

        } catch (\Exception $e) {
            Log::error('AI settings management error: ' . $e->getMessage());
            $this->sendMessage($chatId, "âŒ Ø®Ø·Ø§ Ø¯Ø± Ù…Ø¯ÛŒØ±ÛŒØª ØªÙ†Ø¸ÛŒÙ…Ø§Øª");
        }
    }

    /**
     * Show AI settings
     */
    private function showAISettings($chatId): void
    {
        try {
            $openaiConfigured = env('OPENAI_API_KEY') ? 'âœ… ØªÙ†Ø¸ÛŒÙ… Ø´Ø¯Ù‡' : 'âŒ ØªÙ†Ø¸ÛŒÙ… Ù†Ø´Ø¯Ù‡';
            $totalTemplates = DB::table('ai_content_templates')->count();
            $activeTemplates = DB::table('ai_content_templates')->where('is_active', true)->count();

            $message = "âš™ï¸ <b>ØªÙ†Ø¸ÛŒÙ…Ø§Øª Ù‡ÙˆØ´ Ù…ØµÙ†ÙˆØ¹ÛŒ</b>\n\n";
            
            $message .= "ğŸ”§ <b>Ù¾ÛŒÚ©Ø±Ø¨Ù†Ø¯ÛŒ API:</b>\n";
            $message .= "â”” OpenAI API: {$openaiConfigured}\n\n";
            
            $message .= "ğŸ“Š <b>Ø¢Ù…Ø§Ø± Ù‚Ø§Ù„Ø¨â€ŒÙ‡Ø§:</b>\n";
            $message .= "â”” Ú©Ù„ Ù‚Ø§Ù„Ø¨â€ŒÙ‡Ø§: {$totalTemplates}\n";
            $message .= "â”” Ù‚Ø§Ù„Ø¨â€ŒÙ‡Ø§ÛŒ ÙØ¹Ø§Ù„: {$activeTemplates}\n\n";
            
            $message .= "âš¡ <b>ØªÙ†Ø¸ÛŒÙ…Ø§Øª Ù‚Ø§Ø¨Ù„ ØªØºÛŒÛŒØ±:</b>\n";
            $message .= "â€¢ default_model - Ù…Ø¯Ù„ Ù¾ÛŒØ´â€ŒÙØ±Ø¶\n";
            $message .= "â€¢ max_tokens - Ø­Ø¯Ø§Ú©Ø«Ø± ØªÙˆÚ©Ù†\n";
            $message .= "â€¢ temperature - Ù…ÛŒØ²Ø§Ù† Ø®Ù„Ø§Ù‚ÛŒØª\n\n";
            
            $message .= "ğŸ’¡ Ø¨Ø±Ø§ÛŒ ØªØºÛŒÛŒØ± ØªÙ†Ø¸ÛŒÙ…Ø§Øª:\n";
            $message .= "/ai settings set &lt;ØªÙ†Ø¸ÛŒÙ…&gt; &lt;Ù…Ù‚Ø¯Ø§Ø±&gt;";

            $this->sendMessage($chatId, $message);

        } catch (\Exception $e) {
            Log::error('Show AI settings error: ' . $e->getMessage());
            $this->sendMessage($chatId, "âŒ Ø®Ø·Ø§ Ø¯Ø± Ù†Ù…Ø§ÛŒØ´ ØªÙ†Ø¸ÛŒÙ…Ø§Øª");
        }
    }

    /**
     * Set AI setting
     */
    private function setAISetting($chatId, $setting, $value): void
    {
        $message = "âš™ï¸ ØªÙ†Ø¸ÛŒÙ… `{$setting}` Ø¨Ù‡ Ù…Ù‚Ø¯Ø§Ø± `{$value}` ØªØºÛŒÛŒØ± Ú©Ø±Ø¯\n\n";
        $message .= "â„¹ï¸ Ø§ÛŒÙ† ÙˆÛŒÚ˜Ú¯ÛŒ Ø¯Ø± Ù†Ø³Ø®Ù‡â€ŒÙ‡Ø§ÛŒ Ø¨Ø¹Ø¯ÛŒ Ù¾ÛŒØ§Ø¯Ù‡â€ŒØ³Ø§Ø²ÛŒ Ø®ÙˆØ§Ù‡Ø¯ Ø´Ø¯";

        $this->sendMessage($chatId, $message);
    }

    /**
     * Handle post management
     */
    private function handlePostManagement(\App\Services\Telegram\Core\UpdateContext $context): void
    {
        $chatId = $context->getChatId();
        $messageText = $context->getText();
        $command = $context->getCommand();
        $args = $context->getArgs();

        try {
            switch ($command) {
                case 'posts':
                case 'dashboard':
                    $this->showPostDashboard($chatId);
                    break;

                case 'list':
                    $page = (int)($args[0] ?? 1);
                    $this->listPosts($chatId, $page);
                    break;

                case 'create':
                    $this->createPostDialog($chatId);
                    break;

                case 'view':
                    $postId = $args[0] ?? null;
                    if ($postId) {
                        $this->viewPost($chatId, $postId);
                    } else {
                        $this->sendMessage($chatId, "âŒ Ø´Ù†Ø§Ø³Ù‡ Ù¾Ø³Øª Ø±Ø§ ÙˆØ§Ø±Ø¯ Ú©Ù†ÛŒØ¯\n\nÙ…Ø«Ø§Ù„: /posts view 1");
                    }
                    break;

                case 'edit':
                    $postId = $args[0] ?? null;
                    if ($postId) {
                        $this->editPostDialog($chatId, $postId);
                    } else {
                        $this->sendMessage($chatId, "âŒ Ø´Ù†Ø§Ø³Ù‡ Ù¾Ø³Øª Ø±Ø§ ÙˆØ§Ø±Ø¯ Ú©Ù†ÛŒØ¯\n\nÙ…Ø«Ø§Ù„: /posts edit 1");
                    }
                    break;

                case 'publish':
                    $postId = $args[0] ?? null;
                    if ($postId) {
                        $this->publishPost($chatId, $postId);
                    } else {
                        $this->sendMessage($chatId, "âŒ Ø´Ù†Ø§Ø³Ù‡ Ù¾Ø³Øª Ø±Ø§ ÙˆØ§Ø±Ø¯ Ú©Ù†ÛŒØ¯\n\nÙ…Ø«Ø§Ù„: /posts publish 1");
                    }
                    break;

                case 'unpublish':
                    $postId = $args[0] ?? null;
                    if ($postId) {
                        $this->unpublishPost($chatId, $postId);
                    } else {
                        $this->sendMessage($chatId, "âŒ Ø´Ù†Ø§Ø³Ù‡ Ù¾Ø³Øª Ø±Ø§ ÙˆØ§Ø±Ø¯ Ú©Ù†ÛŒØ¯\n\nÙ…Ø«Ø§Ù„: /posts unpublish 1");
                    }
                    break;

                case 'delete':
                    $postId = $args[0] ?? null;
                    if ($postId) {
                        $this->deletePost($chatId, $postId);
                    } else {
                        $this->sendMessage($chatId, "âŒ Ø´Ù†Ø§Ø³Ù‡ Ù¾Ø³Øª Ø±Ø§ ÙˆØ§Ø±Ø¯ Ú©Ù†ÛŒØ¯\n\nÙ…Ø«Ø§Ù„: /posts delete 1");
                    }
                    break;

                case 'search':
                    $query = implode(' ', $args);
                    if ($query) {
                        $this->searchPosts($chatId, $query);
                    } else {
                        $this->sendMessage($chatId, "âŒ Ú©Ù„Ù…Ù‡ Ú©Ù„ÛŒØ¯ÛŒ Ø¬Ø³ØªØ¬Ùˆ Ø±Ø§ ÙˆØ§Ø±Ø¯ Ú©Ù†ÛŒØ¯\n\nÙ…Ø«Ø§Ù„: /posts search Ø§Ø®Ø¨Ø§Ø±");
                    }
                    break;

                case 'stats':
                    $this->showPostStats($chatId);
                    break;

                case 'categories':
                    $this->managePostCategories($chatId, array_slice($args, 0));
                    break;

                default:
                    $this->showPostHelp($chatId);
                    break;
            }

        } catch (\Exception $e) {
            Log::error('Post management error: ' . $e->getMessage());
            $this->sendMessage($chatId, "âŒ Ø®Ø·Ø§ Ø¯Ø± Ø³ÛŒØ³ØªÙ… Ù…Ø¯ÛŒØ±ÛŒØª Ù¾Ø³Øªâ€ŒÙ‡Ø§");
        }
    }

    /**
     * Show post dashboard
     */
    private function showPostDashboard($chatId): void
    {
        try {
            // Get post statistics
            $totalPosts = DB::table('telegram_posts')->count();
            $publishedPosts = DB::table('telegram_posts')->where('status', 'published')->count();
            $draftPosts = DB::table('telegram_posts')->where('status', 'draft')->count();
            $scheduledPosts = DB::table('telegram_posts')->where('status', 'scheduled')->count();
            
            $todayPosts = DB::table('telegram_posts')
                ->whereDate('created_at', today())
                ->count();

            // Get recent posts
            $recentPosts = DB::table('telegram_posts')
                ->select('id', 'title', 'status', 'created_at')
                ->orderBy('created_at', 'desc')
                ->limit(5)
                ->get();

            $message = "ğŸ“ <b>Ø¯Ø§Ø´Ø¨ÙˆØ±Ø¯ Ù…Ø¯ÛŒØ±ÛŒØª Ù¾Ø³Øªâ€ŒÙ‡Ø§</b>\n\n";
            
            $message .= "ğŸ“Š <b>Ø¢Ù…Ø§Ø± Ú©Ù„ÛŒ:</b>\n";
            $message .= "â”” Ú©Ù„ Ù¾Ø³Øªâ€ŒÙ‡Ø§: {$totalPosts}\n";
            $message .= "â”” Ù…Ù†ØªØ´Ø± Ø´Ø¯Ù‡: {$publishedPosts}\n";
            $message .= "â”” Ù¾ÛŒØ´â€ŒÙ†ÙˆÛŒØ³: {$draftPosts}\n";
            $message .= "â”” Ø²Ù…Ø§Ù†â€ŒØ¨Ù†Ø¯ÛŒ Ø´Ø¯Ù‡: {$scheduledPosts}\n\n";
            
            $message .= "ğŸ“… <b>Ø§Ù…Ø±ÙˆØ²:</b>\n";
            $message .= "â”” Ù¾Ø³Øªâ€ŒÙ‡Ø§ÛŒ Ø¬Ø¯ÛŒØ¯: {$todayPosts}\n\n";

            if ($recentPosts->isNotEmpty()) {
                $message .= "ğŸ“‹ <b>Ø¢Ø®Ø±ÛŒÙ† Ù¾Ø³Øªâ€ŒÙ‡Ø§:</b>\n";
                foreach ($recentPosts as $post) {
                    $statusIcon = $this->getPostStatusIcon($post->status);
                    $createdAt = \Carbon\Carbon::parse($post->created_at)->format('m/d H:i');
                    $title = strlen($post->title) > 25 ? substr($post->title, 0, 25) . '...' : $post->title;
                    $message .= "â”” {$statusIcon} {$title} ({$createdAt})\n";
                }
                $message .= "\n";
            }

            $message .= "ğŸ¯ <b>Ø¯Ø³ØªÙˆØ±Ø§Øª Ù…ÙˆØ¬ÙˆØ¯:</b>\n";
            $message .= "â€¢ /posts list - Ù„ÛŒØ³Øª Ù¾Ø³Øªâ€ŒÙ‡Ø§\n";
            $message .= "â€¢ /posts create - Ø§ÛŒØ¬Ø§Ø¯ Ù¾Ø³Øª Ø¬Ø¯ÛŒØ¯\n";
            $message .= "â€¢ /posts search - Ø¬Ø³ØªØ¬Ùˆ Ø¯Ø± Ù¾Ø³Øªâ€ŒÙ‡Ø§\n";
            $message .= "â€¢ /posts stats - Ø¢Ù…Ø§Ø± ØªÙØµÛŒÙ„ÛŒ\n";

            $this->sendMessage($chatId, $message);

        } catch (\Exception $e) {
            Log::error('Post dashboard error: ' . $e->getMessage());
            $this->sendMessage($chatId, "âŒ Ø®Ø·Ø§ Ø¯Ø± Ø¨Ø§Ø±Ú¯Ø°Ø§Ø±ÛŒ Ø¯Ø§Ø´Ø¨ÙˆØ±Ø¯ Ù¾Ø³Øªâ€ŒÙ‡Ø§");
        }
    }

    /**
     * List posts with pagination
     */
    private function listPosts($chatId, int $page = 1): void
    {
        try {
            $perPage = 10;
            $offset = ($page - 1) * $perPage;

            $posts = DB::table('telegram_posts')
                ->select('id', 'title', 'status', 'created_at', 'published_at')
                ->orderBy('created_at', 'desc')
                ->limit($perPage)
                ->offset($offset)
                ->get();

            $totalPosts = DB::table('telegram_posts')->count();
            $totalPages = ceil($totalPosts / $perPage);

            if ($posts->isEmpty()) {
                $this->sendMessage($chatId, "ğŸ“‹ Ù‡ÛŒÚ† Ù¾Ø³ØªÛŒ ÛŒØ§ÙØª Ù†Ø´Ø¯\n\nØ¨Ø±Ø§ÛŒ Ø§ÛŒØ¬Ø§Ø¯ Ù¾Ø³Øª Ø¬Ø¯ÛŒØ¯ Ø§Ø² Ø¯Ø³ØªÙˆØ± Ø²ÛŒØ± Ø§Ø³ØªÙØ§Ø¯Ù‡ Ú©Ù†ÛŒØ¯:\n/posts create");
                return;
            }

            $message = "ğŸ“‹ <b>Ù„ÛŒØ³Øª Ù¾Ø³Øªâ€ŒÙ‡Ø§</b>\n";
            $message .= "ØµÙØ­Ù‡ {$page} Ø§Ø² {$totalPages} (Ú©Ù„: {$totalPosts})\n\n";

            foreach ($posts as $post) {
                $statusIcon = $this->getPostStatusIcon($post->status);
                $createdAt = \Carbon\Carbon::parse($post->created_at)->format('Y/m/d H:i');
                $title = strlen($post->title) > 30 ? substr($post->title, 0, 30) . '...' : $post->title;
                
                $message .= "{$statusIcon} <b>{$title}</b> (ID: {$post->id})\n";
                $message .= "â”” ØªØ§Ø±ÛŒØ®: {$createdAt}\n";
                
                if ($post->status === 'published' && $post->published_at) {
                    $publishedAt = \Carbon\Carbon::parse($post->published_at)->format('Y/m/d H:i');
                    $message .= "â”” Ø§Ù†ØªØ´Ø§Ø±: {$publishedAt}\n";
                }
                $message .= "\n";
            }

            $message .= "ğŸ”§ <b>Ø¯Ø³ØªÙˆØ±Ø§Øª:</b>\n";
            $message .= "â€¢ /posts view &lt;ID&gt; - Ù†Ù…Ø§ÛŒØ´ Ø¬Ø²Ø¦ÛŒØ§Øª\n";
            $message .= "â€¢ /posts edit &lt;ID&gt; - ÙˆÛŒØ±Ø§ÛŒØ´ Ù¾Ø³Øª\n";
            $message .= "â€¢ /posts publish &lt;ID&gt; - Ø§Ù†ØªØ´Ø§Ø± Ù¾Ø³Øª\n";
            $message .= "â€¢ /posts delete &lt;ID&gt; - Ø­Ø°Ù Ù¾Ø³Øª\n";

            if ($totalPages > 1) {
                $message .= "\nğŸ“„ ØµÙØ­Ù‡â€ŒØ¨Ù†Ø¯ÛŒ:\n";
                if ($page > 1) {
                    $message .= "â€¢ /posts list " . ($page - 1) . " - ØµÙØ­Ù‡ Ù‚Ø¨Ù„\n";
                }
                if ($page < $totalPages) {
                    $message .= "â€¢ /posts list " . ($page + 1) . " - ØµÙØ­Ù‡ Ø¨Ø¹Ø¯\n";
                }
            }

            $this->sendMessage($chatId, $message);

        } catch (\Exception $e) {
            Log::error('List posts error: ' . $e->getMessage());
            $this->sendMessage($chatId, "âŒ Ø®Ø·Ø§ Ø¯Ø± Ø¨Ø§Ø±Ú¯Ø°Ø§Ø±ÛŒ Ù„ÛŒØ³Øª Ù¾Ø³Øªâ€ŒÙ‡Ø§");
        }
    }

    /**
     * View post details
     */
    private function viewPost($chatId, $postId): void
    {
        try {
            $post = DB::table('telegram_posts')
                ->where('id', $postId)
                ->first();

            if (!$post) {
                $this->sendMessage($chatId, "âŒ Ù¾Ø³Øª ÛŒØ§ÙØª Ù†Ø´Ø¯");
                return;
            }

            $statusIcon = $this->getPostStatusIcon($post->status);
            $statusText = $this->getPostStatusText($post->status);
            $createdAt = \Carbon\Carbon::parse($post->created_at)->format('Y/m/d H:i');

            $message = "ğŸ“„ <b>Ø¬Ø²Ø¦ÛŒØ§Øª Ù¾Ø³Øª</b>\n\n";
            $message .= "ğŸ·ï¸ <b>Ø¹Ù†ÙˆØ§Ù†:</b> {$post->title}\n";
            $message .= "ğŸ†” <b>Ø´Ù†Ø§Ø³Ù‡:</b> {$post->id}\n";
            $message .= "ğŸ“Š <b>ÙˆØ¶Ø¹ÛŒØª:</b> {$statusIcon} {$statusText}\n";
            $message .= "ğŸ•’ <b>ØªØ§Ø±ÛŒØ® Ø§ÛŒØ¬Ø§Ø¯:</b> {$createdAt}\n";

            if ($post->published_at) {
                $publishedAt = \Carbon\Carbon::parse($post->published_at)->format('Y/m/d H:i');
                $message .= "ğŸ“… <b>ØªØ§Ø±ÛŒØ® Ø§Ù†ØªØ´Ø§Ø±:</b> {$publishedAt}\n";
            }

            if ($post->scheduled_for) {
                $scheduledAt = \Carbon\Carbon::parse($post->scheduled_for)->format('Y/m/d H:i');
                $message .= "â° <b>Ø²Ù…Ø§Ù†â€ŒØ¨Ù†Ø¯ÛŒ:</b> {$scheduledAt}\n";
            }

            $message .= "\n";

            if ($post->content) {
                $content = strlen($post->content) > 200 
                    ? substr($post->content, 0, 200) . '...' 
                    : $post->content;
                $message .= "ğŸ“„ <b>Ù…Ø­ØªÙˆØ§:</b>\n{$content}\n\n";
            }

            $message .= "âš¡ <b>Ø¯Ø³ØªÙˆØ±Ø§Øª:</b>\n";
            $message .= "â€¢ /posts edit {$postId} - ÙˆÛŒØ±Ø§ÛŒØ´\n";
            
            if ($post->status === 'draft') {
                $message .= "â€¢ /posts publish {$postId} - Ø§Ù†ØªØ´Ø§Ø±\n";
            } elseif ($post->status === 'published') {
                $message .= "â€¢ /posts unpublish {$postId} - Ù„ØºÙˆ Ø§Ù†ØªØ´Ø§Ø±\n";
            }
            
            $message .= "â€¢ /posts delete {$postId} - Ø­Ø°Ù\n";

            $this->sendMessage($chatId, $message);

        } catch (\Exception $e) {
            Log::error('View post error: ' . $e->getMessage());
            $this->sendMessage($chatId, "âŒ Ø®Ø·Ø§ Ø¯Ø± Ù†Ù…Ø§ÛŒØ´ Ù¾Ø³Øª");
        }
    }

    /**
     * Create post dialog
     */
    private function createPostDialog($chatId): void
    {
        $message = "ğŸ“ <b>Ø§ÛŒØ¬Ø§Ø¯ Ù¾Ø³Øª Ø¬Ø¯ÛŒØ¯</b>\n\n";
        $message .= "Ø¨Ø±Ø§ÛŒ Ø§ÛŒØ¬Ø§Ø¯ Ù¾Ø³Øª Ø¬Ø¯ÛŒØ¯ØŒ Ø§Ø·Ù„Ø§Ø¹Ø§Øª Ø²ÛŒØ± Ø±Ø§ Ø§Ø±Ø³Ø§Ù„ Ú©Ù†ÛŒØ¯:\n\n";
        $message .= "ğŸ“‹ <b>ÙØ±Ù…Øª:</b>\n";
        $message .= "Ø¹Ù†ÙˆØ§Ù†: Ø¹Ù†ÙˆØ§Ù† Ù¾Ø³Øª\n";
        $message .= "Ù…Ø­ØªÙˆØ§: Ù…ØªÙ† Ú©Ø§Ù…Ù„ Ù¾Ø³Øª\n";
        $message .= "ÙˆØ¶Ø¹ÛŒØª: draft|published (Ù¾ÛŒØ´â€ŒÙØ±Ø¶: draft)\n\n";
        $message .= "ğŸ’¡ <b>Ù…Ø«Ø§Ù„:</b>\n";
        $message .= "Ø¹Ù†ÙˆØ§Ù†: Ø§Ø®Ø¨Ø§Ø± Ø¬Ø¯ÛŒØ¯ Ù¾Ù„ØªÙØ±Ù…\n";
        $message .= "Ù…Ø­ØªÙˆØ§: Ø¯Ø± Ø§ÛŒÙ† Ø¨Ø±ÙˆØ²Ø±Ø³Ø§Ù†ÛŒØŒ ÙˆÛŒÚ˜Ú¯ÛŒâ€ŒÙ‡Ø§ÛŒ Ø¬Ø¯ÛŒØ¯ÛŒ Ø¨Ù‡ Ù¾Ù„ØªÙØ±Ù… Ø§Ø¶Ø§ÙÙ‡ Ø´Ø¯Ù‡ Ø§Ø³Øª...\n";
        $message .= "ÙˆØ¶Ø¹ÛŒØª: draft\n\n";
        $message .= "â„¹ï¸ Ø¨Ø±Ø§ÛŒ Ù„ØºÙˆ Ø¹Ù…Ù„ÛŒØ§Øª /posts list Ø±Ø§ Ø§Ø±Ø³Ø§Ù„ Ú©Ù†ÛŒØ¯";

        $this->sendMessage($chatId, $message);
    }

    /**
     * Get post status icon
     */
    private function getPostStatusIcon($status): string
    {
        $icons = [
            'draft' => 'ğŸ“',
            'published' => 'âœ…',
            'scheduled' => 'â°',
            'archived' => 'ğŸ—„ï¸',
            'trashed' => 'ğŸ—‘ï¸'
        ];

        return $icons[$status] ?? 'â“';
    }

    /**
     * Get post status text in Persian
     */
    private function getPostStatusText($status): string
    {
        $statuses = [
            'draft' => 'Ù¾ÛŒØ´â€ŒÙ†ÙˆÛŒØ³',
            'published' => 'Ù…Ù†ØªØ´Ø± Ø´Ø¯Ù‡',
            'scheduled' => 'Ø²Ù…Ø§Ù†â€ŒØ¨Ù†Ø¯ÛŒ Ø´Ø¯Ù‡',
            'archived' => 'Ø¨Ø§ÛŒÚ¯Ø§Ù†ÛŒ Ø´Ø¯Ù‡',
            'trashed' => 'Ø­Ø°Ù Ø´Ø¯Ù‡'
        ];

        return $statuses[$status] ?? $status;
    }

    /**
     * Publish post
     */
    private function publishPost($chatId, $postId): void
    {
        try {
            $post = DB::table('telegram_posts')
                ->where('id', $postId)
                ->first();

            if (!$post) {
                $this->sendMessage($chatId, "âŒ Ù¾Ø³Øª ÛŒØ§ÙØª Ù†Ø´Ø¯");
                return;
            }

            if ($post->status === 'published') {
                $this->sendMessage($chatId, "âš ï¸ Ø§ÛŒÙ† Ù¾Ø³Øª Ù‚Ø¨Ù„Ø§Ù‹ Ù…Ù†ØªØ´Ø± Ø´Ø¯Ù‡ Ø§Ø³Øª");
                return;
            }

            DB::table('telegram_posts')
                ->where('id', $postId)
                ->update([
                    'status' => 'published',
                    'published_at' => now(),
                    'updated_at' => now()
                ]);

            // Log the action
            $this->logAudit('post_published', [
                'admin_id' => $this->getAdminIdFromChatId($chatId),
                'post_id' => $postId,
                'post_title' => $post->title
            ]);

            $message = "âœ… Ù¾Ø³Øª Ø¨Ø§ Ù…ÙˆÙÙ‚ÛŒØª Ù…Ù†ØªØ´Ø± Ø´Ø¯\n\n";
            $message .= "ğŸ“„ <b>Ù¾Ø³Øª:</b> {$post->title}\n";
            $message .= "ğŸ“… <b>ØªØ§Ø±ÛŒØ® Ø§Ù†ØªØ´Ø§Ø±:</b> " . now()->format('Y/m/d H:i:s');

            $this->sendMessage($chatId, $message);

        } catch (\Exception $e) {
            Log::error('Publish post error: ' . $e->getMessage());
            $this->sendMessage($chatId, "âŒ Ø®Ø·Ø§ Ø¯Ø± Ø§Ù†ØªØ´Ø§Ø± Ù¾Ø³Øª");
        }
    }

    /**
     * Show post management help
     */
    private function showPostHelp($chatId): void
    {
        $message = "ğŸ“ <b>Ø±Ø§Ù‡Ù†Ù…Ø§ÛŒ Ù…Ø¯ÛŒØ±ÛŒØª Ù¾Ø³Øªâ€ŒÙ‡Ø§</b>\n\n";
        
        $message .= "ğŸ“‹ <b>Ù…Ø¯ÛŒØ±ÛŒØª Ù¾Ø³Øªâ€ŒÙ‡Ø§:</b>\n";
        $message .= "â€¢ /posts list - Ù„ÛŒØ³Øª Ù¾Ø³Øªâ€ŒÙ‡Ø§\n";
        $message .= "â€¢ /posts create - Ø§ÛŒØ¬Ø§Ø¯ Ù¾Ø³Øª Ø¬Ø¯ÛŒØ¯\n";
        $message .= "â€¢ /posts view &lt;ID&gt; - Ù†Ù…Ø§ÛŒØ´ Ù¾Ø³Øª\n";
        $message .= "â€¢ /posts edit &lt;ID&gt; - ÙˆÛŒØ±Ø§ÛŒØ´ Ù¾Ø³Øª\n";
        $message .= "â€¢ /posts publish &lt;ID&gt; - Ø§Ù†ØªØ´Ø§Ø± Ù¾Ø³Øª\n";
        $message .= "â€¢ /posts unpublish &lt;ID&gt; - Ù„ØºÙˆ Ø§Ù†ØªØ´Ø§Ø±\n";
        $message .= "â€¢ /posts delete &lt;ID&gt; - Ø­Ø°Ù Ù¾Ø³Øª\n\n";
        
        $message .= "ğŸ” <b>Ø¬Ø³ØªØ¬Ùˆ Ùˆ Ø¢Ù…Ø§Ø±:</b>\n";
        $message .= "â€¢ /posts search [Ú©Ù„Ù…Ù‡ Ú©Ù„ÛŒØ¯ÛŒ] - Ø¬Ø³ØªØ¬Ùˆ\n";
        $message .= "â€¢ /posts stats - Ø¢Ù…Ø§Ø± ØªÙØµÛŒÙ„ÛŒ\n\n";
        
        $message .= "â„¹ï¸ Ø¨Ø±Ø§ÛŒ Ø¯Ø±ÛŒØ§ÙØª Ø¯Ø§Ø´Ø¨ÙˆØ±Ø¯ Ú©Ø§Ù…Ù„ Ø§Ø² /posts Ø§Ø³ØªÙØ§Ø¯Ù‡ Ú©Ù†ÛŒØ¯";

        $this->sendMessage($chatId, $message);
    }

    /**
     * Unpublish post
     */
    private function unpublishPost($chatId, $postId): void
    {
        try {
            $post = DB::table('telegram_posts')
                ->where('id', $postId)
                ->first();

            if (!$post) {
                $this->sendMessage($chatId, "âŒ Ù¾Ø³Øª ÛŒØ§ÙØª Ù†Ø´Ø¯");
                return;
            }

            if ($post->status !== 'published') {
                $this->sendMessage($chatId, "âš ï¸ Ø§ÛŒÙ† Ù¾Ø³Øª Ù…Ù†ØªØ´Ø± Ù†Ø´Ø¯Ù‡ Ø§Ø³Øª");
                return;
            }

            DB::table('telegram_posts')
                ->where('id', $postId)
                ->update([
                    'status' => 'draft',
                    'updated_at' => now()
                ]);

            // Log the action
            $this->logAudit('post_unpublished', [
                'admin_id' => $this->getAdminIdFromChatId($chatId),
                'post_id' => $postId,
                'post_title' => $post->title
            ]);

            $message = "âœ… Ø§Ù†ØªØ´Ø§Ø± Ù¾Ø³Øª Ù„ØºÙˆ Ø´Ø¯\n\n";
            $message .= "ğŸ“„ <b>Ù¾Ø³Øª:</b> {$post->title}\n";
            $message .= "ğŸ“Š <b>ÙˆØ¶Ø¹ÛŒØª Ø¬Ø¯ÛŒØ¯:</b> Ù¾ÛŒØ´â€ŒÙ†ÙˆÛŒØ³";

            $this->sendMessage($chatId, $message);

        } catch (\Exception $e) {
            Log::error('Unpublish post error: ' . $e->getMessage());
            $this->sendMessage($chatId, "âŒ Ø®Ø·Ø§ Ø¯Ø± Ù„ØºÙˆ Ø§Ù†ØªØ´Ø§Ø± Ù¾Ø³Øª");
        }
    }

    /**
     * Delete post
     */
    private function deletePost($chatId, $postId): void
    {
        try {
            $post = DB::table('telegram_posts')
                ->where('id', $postId)
                ->first();

            if (!$post) {
                $this->sendMessage($chatId, "âŒ Ù¾Ø³Øª ÛŒØ§ÙØª Ù†Ø´Ø¯");
                return;
            }

            DB::table('telegram_posts')
                ->where('id', $postId)
                ->delete();

            // Log the action
            $this->logAudit('post_deleted', [
                'admin_id' => $this->getAdminIdFromChatId($chatId),
                'post_id' => $postId,
                'post_title' => $post->title
            ]);

            $message = "âœ… Ù¾Ø³Øª Ø¨Ø§ Ù…ÙˆÙÙ‚ÛŒØª Ø­Ø°Ù Ø´Ø¯\n\n";
            $message .= "ğŸ“„ <b>Ù¾Ø³Øª Ø­Ø°Ù Ø´Ø¯Ù‡:</b> {$post->title}\n";
            $message .= "ğŸ—‘ï¸ <b>Ø¹Ù…Ù„ÛŒØ§Øª:</b> Ø­Ø°Ù Ú©Ø§Ù…Ù„ Ø§Ø² Ø³ÛŒØ³ØªÙ…";

            $this->sendMessage($chatId, $message);

        } catch (\Exception $e) {
            Log::error('Delete post error: ' . $e->getMessage());
            $this->sendMessage($chatId, "âŒ Ø®Ø·Ø§ Ø¯Ø± Ø­Ø°Ù Ù¾Ø³Øª");
        }
    }

    /**
     * Edit post dialog
     */
    private function editPostDialog($chatId, $postId): void
    {
        try {
            $post = DB::table('telegram_posts')
                ->where('id', $postId)
                ->first();

            if (!$post) {
                $this->sendMessage($chatId, "âŒ Ù¾Ø³Øª ÛŒØ§ÙØª Ù†Ø´Ø¯");
                return;
            }

            $message = "âœï¸ <b>ÙˆÛŒØ±Ø§ÛŒØ´ Ù¾Ø³Øª</b>\n\n";
            $message .= "ğŸ·ï¸ <b>Ù¾Ø³Øª ÙØ¹Ù„ÛŒ:</b> {$post->title}\n\n";
            $message .= "Ø¨Ø±Ø§ÛŒ ÙˆÛŒØ±Ø§ÛŒØ´ØŒ Ø§Ø·Ù„Ø§Ø¹Ø§Øª Ø¬Ø¯ÛŒØ¯ Ø±Ø§ Ø¨Ù‡ ÙØ±Ù…Øª Ø²ÛŒØ± Ø§Ø±Ø³Ø§Ù„ Ú©Ù†ÛŒØ¯:\n\n";
            $message .= "ğŸ“‹ <b>ÙØ±Ù…Øª ÙˆÛŒØ±Ø§ÛŒØ´:</b>\n";
            $message .= "Ø¹Ù†ÙˆØ§Ù†: Ø¹Ù†ÙˆØ§Ù† Ø¬Ø¯ÛŒØ¯ (Ø§Ø®ØªÛŒØ§Ø±ÛŒ)\n";
            $message .= "Ù…Ø­ØªÙˆØ§: Ù…Ø­ØªÙˆØ§ÛŒ Ø¬Ø¯ÛŒØ¯ (Ø§Ø®ØªÛŒØ§Ø±ÛŒ)\n";
            $message .= "ÙˆØ¶Ø¹ÛŒØª: draft|published (Ø§Ø®ØªÛŒØ§Ø±ÛŒ)\n\n";
            $message .= "ğŸ’¡ ÙÙ‚Ø· ÙÛŒÙ„Ø¯Ù‡Ø§ÛŒÛŒ Ú©Ù‡ Ù…ÛŒâ€ŒØ®ÙˆØ§Ù‡ÛŒØ¯ ØªØºÛŒÛŒØ± Ø¯Ù‡ÛŒØ¯ Ø±Ø§ ÙˆØ§Ø±Ø¯ Ú©Ù†ÛŒØ¯\n\n";
            $message .= "â„¹ï¸ Ø¨Ø±Ø§ÛŒ Ù„ØºÙˆ Ø¹Ù…Ù„ÛŒØ§Øª /posts view {$postId} Ø±Ø§ Ø§Ø±Ø³Ø§Ù„ Ú©Ù†ÛŒØ¯";

            $this->sendMessage($chatId, $message);

        } catch (\Exception $e) {
            Log::error('Edit post dialog error: ' . $e->getMessage());
            $this->sendMessage($chatId, "âŒ Ø®Ø·Ø§ Ø¯Ø± Ù†Ù…Ø§ÛŒØ´ ÙØ±Ù… ÙˆÛŒØ±Ø§ÛŒØ´");
        }
    }

    /**
     * Search posts
     */
    private function searchPosts($chatId, $query): void
    {
        try {
            $posts = DB::table('telegram_posts')
                ->select('id', 'title', 'status', 'created_at')
                ->where(function($q) use ($query) {
                    $q->where('title', 'ILIKE', "%{$query}%")
                      ->orWhere('content', 'ILIKE', "%{$query}%");
                })
                ->orderBy('created_at', 'desc')
                ->limit(15)
                ->get();

            if ($posts->isEmpty()) {
                $this->sendMessage($chatId, "ğŸ” Ù‡ÛŒÚ† Ù¾Ø³ØªÛŒ Ø¨Ø§ Ú©Ù„Ù…Ù‡ Ú©Ù„ÛŒØ¯ÛŒ \"{$query}\" ÛŒØ§ÙØª Ù†Ø´Ø¯\n\nØ³Ø¹ÛŒ Ú©Ù†ÛŒØ¯ Ø§Ø² Ú©Ù„Ù…Ø§Øª Ú©Ù„ÛŒØ¯ÛŒ Ø¯ÛŒÚ¯Ø±ÛŒ Ø§Ø³ØªÙØ§Ø¯Ù‡ Ú©Ù†ÛŒØ¯.");
                return;
            }

            $message = "ğŸ” <b>Ù†ØªØ§ÛŒØ¬ Ø¬Ø³ØªØ¬Ùˆ Ø¨Ø±Ø§ÛŒ: \"{$query}\"</b>\n";
            $message .= "ØªØ¹Ø¯Ø§Ø¯: " . $posts->count() . " Ù¾Ø³Øª\n\n";

            foreach ($posts as $post) {
                $statusIcon = $this->getPostStatusIcon($post->status);
                $createdAt = \Carbon\Carbon::parse($post->created_at)->format('Y/m/d');
                $title = strlen($post->title) > 35 ? substr($post->title, 0, 35) . '...' : $post->title;
                
                $message .= "{$statusIcon} <b>{$title}</b> (ID: {$post->id})\n";
                $message .= "â”” ØªØ§Ø±ÛŒØ®: {$createdAt}\n\n";
            }

            $message .= "ğŸ’¡ Ø¨Ø±Ø§ÛŒ Ù…Ø´Ø§Ù‡Ø¯Ù‡ Ø¬Ø²Ø¦ÛŒØ§Øª: /posts view &lt;ID&gt;";

            $this->sendMessage($chatId, $message);

        } catch (\Exception $e) {
            Log::error('Search posts error: ' . $e->getMessage());
            $this->sendMessage($chatId, "âŒ Ø®Ø·Ø§ Ø¯Ø± Ø¬Ø³ØªØ¬ÙˆÛŒ Ù¾Ø³Øªâ€ŒÙ‡Ø§");
        }
    }

    /**
     * Show post statistics
     */
    private function showPostStats($chatId): void
    {
        try {
            // Overall stats
            $totalPosts = DB::table('telegram_posts')->count();
            $publishedPosts = DB::table('telegram_posts')->where('status', 'published')->count();
            $draftPosts = DB::table('telegram_posts')->where('status', 'draft')->count();
            
            // Today's stats
            $todayPosts = DB::table('telegram_posts')
                ->whereDate('created_at', today())
                ->count();

            $todayPublished = DB::table('telegram_posts')
                ->whereDate('published_at', today())
                ->count();

            // This week's stats
            $weekPosts = DB::table('telegram_posts')
                ->whereBetween('created_at', [now()->startOfWeek(), now()->endOfWeek()])
                ->count();

            // Status distribution
            $statusStats = DB::table('telegram_posts')
                ->select('status', DB::raw('COUNT(*) as count'))
                ->groupBy('status')
                ->orderBy('count', 'desc')
                ->get();

            // Recent activity
            $recentPublished = DB::table('telegram_posts')
                ->select('title', 'published_at')
                ->where('status', 'published')
                ->whereNotNull('published_at')
                ->orderBy('published_at', 'desc')
                ->limit(5)
                ->get();

            $message = "ğŸ“Š <b>Ø¢Ù…Ø§Ø± Ù¾Ø³Øªâ€ŒÙ‡Ø§</b>\n\n";
            
            $message .= "ğŸ“ˆ <b>Ø¢Ù…Ø§Ø± Ú©Ù„ÛŒ:</b>\n";
            $message .= "â”” Ú©Ù„ Ù¾Ø³Øªâ€ŒÙ‡Ø§: {$totalPosts}\n";
            $message .= "â”” Ù…Ù†ØªØ´Ø± Ø´Ø¯Ù‡: {$publishedPosts}\n";
            $message .= "â”” Ù¾ÛŒØ´â€ŒÙ†ÙˆÛŒØ³: {$draftPosts}\n";
            
            if ($totalPosts > 0) {
                $publishedPercent = round(($publishedPosts / $totalPosts) * 100, 1);
                $message .= "â”” Ø¯Ø±ØµØ¯ Ø§Ù†ØªØ´Ø§Ø±: {$publishedPercent}%\n";
            }
            $message .= "\n";
            
            $message .= "ğŸ“… <b>Ø§Ù…Ø±ÙˆØ²:</b>\n";
            $message .= "â”” Ù¾Ø³Øªâ€ŒÙ‡Ø§ÛŒ Ø¬Ø¯ÛŒØ¯: {$todayPosts}\n";
            $message .= "â”” Ù…Ù†ØªØ´Ø± Ø´Ø¯Ù‡: {$todayPublished}\n\n";
            
            $message .= "ğŸ“ˆ <b>Ø§ÛŒÙ† Ù‡ÙØªÙ‡:</b>\n";
            $message .= "â”” Ù¾Ø³Øªâ€ŒÙ‡Ø§ÛŒ Ø¬Ø¯ÛŒØ¯: {$weekPosts}\n\n";

            if ($statusStats->isNotEmpty()) {
                $message .= "ğŸ“Š <b>ØªÙˆØ²ÛŒØ¹ ÙˆØ¶Ø¹ÛŒØª:</b>\n";
                foreach ($statusStats as $stat) {
                    $statusText = $this->getPostStatusText($stat->status);
                    $message .= "â”” {$statusText}: {$stat->count} Ù¾Ø³Øª\n";
                }
                $message .= "\n";
            }

            if ($recentPublished->isNotEmpty()) {
                $message .= "ğŸ”¥ <b>Ø¢Ø®Ø±ÛŒÙ† Ø§Ù†ØªØ´Ø§Ø±Ø§Øª:</b>\n";
                foreach ($recentPublished as $post) {
                    $publishedAt = \Carbon\Carbon::parse($post->published_at)->format('m/d H:i');
                    $title = strlen($post->title) > 25 ? substr($post->title, 0, 25) . '...' : $post->title;
                    $message .= "â”” {$title} ({$publishedAt})\n";
                }
            }

            $this->sendMessage($chatId, $message);

        } catch (\Exception $e) {
            Log::error('Post stats error: ' . $e->getMessage());
            $this->sendMessage($chatId, "âŒ Ø®Ø·Ø§ Ø¯Ø± Ø¨Ø§Ø±Ú¯Ø°Ø§Ø±ÛŒ Ø¢Ù…Ø§Ø± Ù¾Ø³Øªâ€ŒÙ‡Ø§");
        }
    }

    /**
     * Manage post categories
     */
    private function managePostCategories($chatId, array $args): void
    {
        $message = "ğŸ“‹ <b>Ù…Ø¯ÛŒØ±ÛŒØª Ø¯Ø³ØªÙ‡â€ŒØ¨Ù†Ø¯ÛŒ Ù¾Ø³Øªâ€ŒÙ‡Ø§</b>\n\n";
        $message .= "ğŸ”§ ÙˆÛŒÚ˜Ú¯ÛŒ Ø¯Ø³ØªÙ‡â€ŒØ¨Ù†Ø¯ÛŒ Ø¯Ø± Ù†Ø³Ø®Ù‡ ÙØ¹Ù„ÛŒ Ù¾ÛŒØ§Ø¯Ù‡â€ŒØ³Ø§Ø²ÛŒ Ù†Ø´Ø¯Ù‡ Ø§Ø³Øª.\n\n";
        $message .= "ğŸ’¡ <b>Ù‚Ø§Ø¨Ù„ÛŒØªâ€ŒÙ‡Ø§ÛŒ Ù…ÙˆØ¬ÙˆØ¯:</b>\n";
        $message .= "â€¢ Ù…Ø¯ÛŒØ±ÛŒØª ÙˆØ¶Ø¹ÛŒØª Ù¾Ø³Øªâ€ŒÙ‡Ø§ (draft, published)\n";
        $message .= "â€¢ Ø¬Ø³ØªØ¬Ùˆ Ø¯Ø± Ø¹Ù†ÙˆØ§Ù† Ùˆ Ù…Ø­ØªÙˆØ§ÛŒ Ù¾Ø³Øªâ€ŒÙ‡Ø§\n";
        $message .= "â€¢ Ø¢Ù…Ø§Ø± ØªÙØµÛŒÙ„ÛŒ Ø¨Ø± Ø§Ø³Ø§Ø³ ÙˆØ¶Ø¹ÛŒØª\n\n";
        $message .= "â„¹ï¸ Ø¨Ø±Ø§ÛŒ Ø¨Ø§Ø²Ú¯Ø´Øª: /posts";

        $this->sendMessage($chatId, $message);
    }

    /**
     * Handle security management
     */
    private function handleSecurityManagement(\App\Services\Telegram\Core\UpdateContext $context): void
    {
        $chatId = $context->getChatId();
        $messageText = $context->getText();
        $command = $context->getCommand();
        $args = $context->getArgs();

        try {
            switch ($command) {
                case 'security':
                case 'tokens':
                case 'dashboard':
                    $this->showSecurityDashboard($chatId);
                    break;

                case 'list':
                    $this->listAPITokens($chatId, (int)($args[0] ?? 1));
                    break;

                case 'create':
                    $this->createAPITokenDialog($chatId);
                    break;

                case 'view':
                    $tokenId = $args[0] ?? null;
                    if ($tokenId) {
                        $this->viewAPIToken($chatId, $tokenId);
                    } else {
                        $this->sendMessage($chatId, "âŒ Ø´Ù†Ø§Ø³Ù‡ ØªÙˆÚ©Ù† Ø±Ø§ ÙˆØ§Ø±Ø¯ Ú©Ù†ÛŒØ¯\n\nÙ…Ø«Ø§Ù„: /security view 1");
                    }
                    break;

                case 'revoke':
                    $tokenId = $args[0] ?? null;
                    if ($tokenId) {
                        $this->revokeAPIToken($chatId, $tokenId);
                    } else {
                        $this->sendMessage($chatId, "âŒ Ø´Ù†Ø§Ø³Ù‡ ØªÙˆÚ©Ù† Ø±Ø§ ÙˆØ§Ø±Ø¯ Ú©Ù†ÛŒØ¯\n\nÙ…Ø«Ø§Ù„: /security revoke 1");
                    }
                    break;

                case 'regenerate':
                    $tokenId = $args[0] ?? null;
                    if ($tokenId) {
                        $this->regenerateAPIToken($chatId, $tokenId);
                    } else {
                        $this->sendMessage($chatId, "âŒ Ø´Ù†Ø§Ø³Ù‡ ØªÙˆÚ©Ù† Ø±Ø§ ÙˆØ§Ø±Ø¯ Ú©Ù†ÛŒØ¯\n\nÙ…Ø«Ø§Ù„: /security regenerate 1");
                    }
                    break;

                case 'logs':
                    $this->showSecurityLogs($chatId, (int)($args[0] ?? 1));
                    break;

                case 'events':
                    $this->showSecurityEvents($chatId, (int)($args[0] ?? 1));
                    break;

                case 'audit':
                    $this->showAuditLogs($chatId, array_slice($args, 0));
                    break;

                case 'monitor':
                    $this->showSecurityMonitor($chatId);
                    break;

                case 'settings':
                    $this->manageSecuritySettings($chatId, array_slice($args, 0));
                    break;

                default:
                    $this->showSecurityHelp($chatId);
                    break;
            }

        } catch (\Exception $e) {
            Log::error('Security management error: ' . $e->getMessage());
            $this->sendMessage($chatId, "âŒ Ø®Ø·Ø§ Ø¯Ø± Ø³ÛŒØ³ØªÙ… Ø§Ù…Ù†ÛŒØªÛŒ");
        }
    }

    /**
     * Show security dashboard
     */
    private function showSecurityDashboard($chatId): void
    {
        try {
            // Get API token statistics
            $totalTokens = DB::table('api_tokens')->count();
            $activeTokens = DB::table('api_tokens')->where('is_active', true)->count();
            $expiredTokens = DB::table('api_tokens')
                ->where('expires_at', '<', now())
                ->count();

            // Get recent security events
            $recentEvents = DB::table('telegram_security_events')
                ->select('event_type', 'severity', 'created_at')
                ->orderBy('created_at', 'desc')
                ->limit(5)
                ->get();

            // Today's security activity
            $todayEvents = DB::table('telegram_security_events')
                ->whereDate('created_at', today())
                ->count();

            $criticalEvents = DB::table('telegram_security_events')
                ->where('severity', 'critical')
                ->whereDate('created_at', today())
                ->count();

            // Recent audit logs
            $recentAudits = DB::table('telegram_audit_logs')
                ->select('action', 'created_at')
                ->orderBy('created_at', 'desc')
                ->limit(5)
                ->get();

            $message = "ğŸ” <b>Ø¯Ø§Ø´Ø¨ÙˆØ±Ø¯ Ø§Ù…Ù†ÛŒØª Ùˆ ØªÙˆÚ©Ù†â€ŒÙ‡Ø§</b>\n\n";
            
            $message .= "ğŸ« <b>API ØªÙˆÚ©Ù†â€ŒÙ‡Ø§:</b>\n";
            $message .= "â”” Ú©Ù„ ØªÙˆÚ©Ù†â€ŒÙ‡Ø§: {$totalTokens}\n";
            $message .= "â”” ÙØ¹Ø§Ù„: {$activeTokens}\n";
            $message .= "â”” Ù…Ù†Ù‚Ø¶ÛŒ Ø´Ø¯Ù‡: {$expiredTokens}\n\n";
            
            $message .= "ğŸ›¡ï¸ <b>Ø§Ù…Ù†ÛŒØª Ø§Ù…Ø±ÙˆØ²:</b>\n";
            $message .= "â”” Ø±ÙˆÛŒØ¯Ø§Ø¯Ù‡Ø§ÛŒ Ø§Ù…Ù†ÛŒØªÛŒ: {$todayEvents}\n";
            $message .= "â”” Ø±ÙˆÛŒØ¯Ø§Ø¯Ù‡Ø§ÛŒ Ø¨Ø­Ø±Ø§Ù†ÛŒ: {$criticalEvents}\n\n";

            if ($recentEvents->isNotEmpty()) {
                $message .= "âš ï¸ <b>Ø¢Ø®Ø±ÛŒÙ† Ø±ÙˆÛŒØ¯Ø§Ø¯Ù‡Ø§ÛŒ Ø§Ù…Ù†ÛŒØªÛŒ:</b>\n";
                foreach ($recentEvents as $event) {
                    $severityIcon = $this->getSecuritySeverityIcon($event->severity);
                    $eventTime = \Carbon\Carbon::parse($event->created_at)->format('m/d H:i');
                    $eventText = $this->getSecurityEventText($event->event_type);
                    $message .= "â”” {$severityIcon} {$eventText} ({$eventTime})\n";
                }
                $message .= "\n";
            }

            $message .= "ğŸ¯ <b>Ø¯Ø³ØªÙˆØ±Ø§Øª Ù…ÙˆØ¬ÙˆØ¯:</b>\n";
            $message .= "â€¢ /security list - Ù„ÛŒØ³Øª ØªÙˆÚ©Ù†â€ŒÙ‡Ø§\n";
            $message .= "â€¢ /security create - Ø§ÛŒØ¬Ø§Ø¯ ØªÙˆÚ©Ù† Ø¬Ø¯ÛŒØ¯\n";
            $message .= "â€¢ /security logs - Ù„Ø§Ú¯â€ŒÙ‡Ø§ÛŒ Ø§Ù…Ù†ÛŒØªÛŒ\n";
            $message .= "â€¢ /security events - Ø±ÙˆÛŒØ¯Ø§Ø¯Ù‡Ø§ÛŒ Ø§Ù…Ù†ÛŒØªÛŒ\n";
            $message .= "â€¢ /security audit - Ú¯Ø²Ø§Ø±Ø´ Ø­Ø³Ø§Ø¨Ø±Ø³ÛŒ\n";
            $message .= "â€¢ /security monitor - Ù…Ø§Ù†ÛŒØªÙˆØ±ÛŒÙ†Ú¯ Ø²Ù†Ø¯Ù‡\n";

            $this->sendMessage($chatId, $message);

        } catch (\Exception $e) {
            Log::error('Security dashboard error: ' . $e->getMessage());
            $this->sendMessage($chatId, "âŒ Ø®Ø·Ø§ Ø¯Ø± Ø¨Ø§Ø±Ú¯Ø°Ø§Ø±ÛŒ Ø¯Ø§Ø´Ø¨ÙˆØ±Ø¯ Ø§Ù…Ù†ÛŒØªÛŒ");
        }
    }

    /**
     * List API tokens
     */
    private function listAPITokens($chatId, int $page = 1): void
    {
        try {
            $perPage = 10;
            $offset = ($page - 1) * $perPage;

            $tokens = DB::table('api_tokens')
                ->select('id', 'name', 'is_active', 'last_used_at', 'expires_at', 'created_at')
                ->orderBy('created_at', 'desc')
                ->limit($perPage)
                ->offset($offset)
                ->get();

            $totalTokens = DB::table('api_tokens')->count();
            $totalPages = ceil($totalTokens / $perPage);

            if ($tokens->isEmpty()) {
                $this->sendMessage($chatId, "ğŸ« Ù‡ÛŒÚ† ØªÙˆÚ©Ù†ÛŒ ÛŒØ§ÙØª Ù†Ø´Ø¯\n\nØ¨Ø±Ø§ÛŒ Ø§ÛŒØ¬Ø§Ø¯ ØªÙˆÚ©Ù† Ø¬Ø¯ÛŒØ¯ Ø§Ø² Ø¯Ø³ØªÙˆØ± Ø²ÛŒØ± Ø§Ø³ØªÙØ§Ø¯Ù‡ Ú©Ù†ÛŒØ¯:\n/security create");
                return;
            }

            $message = "ğŸ« <b>Ù„ÛŒØ³Øª API ØªÙˆÚ©Ù†â€ŒÙ‡Ø§</b>\n";
            $message .= "ØµÙØ­Ù‡ {$page} Ø§Ø² {$totalPages} (Ú©Ù„: {$totalTokens})\n\n";

            foreach ($tokens as $token) {
                $statusIcon = $token->is_active ? 'âœ…' : 'âŒ';
                $createdAt = \Carbon\Carbon::parse($token->created_at)->format('Y/m/d');
                
                // Check if expired
                $isExpired = $token->expires_at && \Carbon\Carbon::parse($token->expires_at)->isPast();
                $expiredIcon = $isExpired ? 'â° ' : '';
                
                $message .= "{$expiredIcon}{$statusIcon} <b>{$token->name}</b> (ID: {$token->id})\n";
                $message .= "â”” ØªØ§Ø±ÛŒØ® Ø§ÛŒØ¬Ø§Ø¯: {$createdAt}\n";
                
                if ($token->last_used_at) {
                    $lastUsed = \Carbon\Carbon::parse($token->last_used_at)->format('Y/m/d H:i');
                    $message .= "â”” Ø¢Ø®Ø±ÛŒÙ† Ø§Ø³ØªÙØ§Ø¯Ù‡: {$lastUsed}\n";
                } else {
                    $message .= "â”” Ø¢Ø®Ø±ÛŒÙ† Ø§Ø³ØªÙØ§Ø¯Ù‡: Ù‡Ø±Ú¯Ø²\n";
                }
                
                if ($token->expires_at) {
                    $expiresAt = \Carbon\Carbon::parse($token->expires_at)->format('Y/m/d H:i');
                    $message .= "â”” Ø§Ù†Ù‚Ø¶Ø§: {$expiresAt}\n";
                }
                
                $message .= "\n";
            }

            $message .= "ğŸ”§ <b>Ø¯Ø³ØªÙˆØ±Ø§Øª:</b>\n";
            $message .= "â€¢ /security view &lt;ID&gt; - Ù†Ù…Ø§ÛŒØ´ Ø¬Ø²Ø¦ÛŒØ§Øª\n";
            $message .= "â€¢ /security revoke &lt;ID&gt; - Ù„ØºÙˆ ØªÙˆÚ©Ù†\n";
            $message .= "â€¢ /security regenerate &lt;ID&gt; - ØªÙˆÙ„ÛŒØ¯ Ù…Ø¬Ø¯Ø¯\n";

            if ($totalPages > 1) {
                $message .= "\nğŸ“„ ØµÙØ­Ù‡â€ŒØ¨Ù†Ø¯ÛŒ:\n";
                if ($page > 1) {
                    $message .= "â€¢ /security list " . ($page - 1) . " - ØµÙØ­Ù‡ Ù‚Ø¨Ù„\n";
                }
                if ($page < $totalPages) {
                    $message .= "â€¢ /security list " . ($page + 1) . " - ØµÙØ­Ù‡ Ø¨Ø¹Ø¯\n";
                }
            }

            $this->sendMessage($chatId, $message);

        } catch (\Exception $e) {
            Log::error('List API tokens error: ' . $e->getMessage());
            $this->sendMessage($chatId, "âŒ Ø®Ø·Ø§ Ø¯Ø± Ø¨Ø§Ø±Ú¯Ø°Ø§Ø±ÛŒ Ù„ÛŒØ³Øª ØªÙˆÚ©Ù†â€ŒÙ‡Ø§");
        }
    }

    /**
     * Create API token dialog
     */
    private function createAPITokenDialog($chatId): void
    {
        $message = "ğŸ« <b>Ø§ÛŒØ¬Ø§Ø¯ API ØªÙˆÚ©Ù† Ø¬Ø¯ÛŒØ¯</b>\n\n";
        $message .= "Ø¨Ø±Ø§ÛŒ Ø§ÛŒØ¬Ø§Ø¯ ØªÙˆÚ©Ù† Ø¬Ø¯ÛŒØ¯ØŒ Ø§Ø·Ù„Ø§Ø¹Ø§Øª Ø²ÛŒØ± Ø±Ø§ Ø§Ø±Ø³Ø§Ù„ Ú©Ù†ÛŒØ¯:\n\n";
        $message .= "ğŸ“‹ <b>ÙØ±Ù…Øª:</b>\n";
        $message .= "Ù†Ø§Ù…: Ù†Ø§Ù… ØªÙˆÚ©Ù†\n";
        $message .= "ØªÙˆØ¶ÛŒØ­Ø§Øª: ØªÙˆØ¶ÛŒØ­ Ú©Ø§Ø±Ø¨Ø±ÛŒ (Ø§Ø®ØªÛŒØ§Ø±ÛŒ)\n";
        $message .= "Ù…Ø¬ÙˆØ²Ù‡Ø§: read,write,admin (Ø§Ø®ØªÛŒØ§Ø±ÛŒ - Ù¾ÛŒØ´â€ŒÙØ±Ø¶: read)\n";
        $message .= "Ø§Ù†Ù‚Ø¶Ø§: YYYY-MM-DD HH:MM ÛŒØ§ never (Ø§Ø®ØªÛŒØ§Ø±ÛŒ)\n\n";
        $message .= "ğŸ’¡ <b>Ù…Ø«Ø§Ù„:</b>\n";
        $message .= "Ù†Ø§Ù…: API ØªÙˆÚ©Ù† ÙˆØ¨â€ŒØ³Ø§ÛŒØª\n";
        $message .= "ØªÙˆØ¶ÛŒØ­Ø§Øª: ØªÙˆÚ©Ù† Ø¨Ø±Ø§ÛŒ Ø¯Ø³ØªØ±Ø³ÛŒ Ø§Ø² ÙˆØ¨â€ŒØ³Ø§ÛŒØª\n";
        $message .= "Ù…Ø¬ÙˆØ²Ù‡Ø§: read,write\n";
        $message .= "Ø§Ù†Ù‚Ø¶Ø§: 2025-12-31 23:59\n\n";
        $message .= "âš ï¸ <b>Ù†Ú©Ø§Øª Ø§Ù…Ù†ÛŒØªÛŒ:</b>\n";
        $message .= "â€¢ ØªÙˆÚ©Ù† ØªÙˆÙ„ÛŒØ¯ Ø´Ø¯Ù‡ ÙÙ‚Ø· ÛŒÚ©Ø¨Ø§Ø± Ù†Ù…Ø§ÛŒØ´ Ø¯Ø§Ø¯Ù‡ Ù…ÛŒâ€ŒØ´ÙˆØ¯\n";
        $message .= "â€¢ Ø¯Ø± Ù…Ú©Ø§Ù† Ø§Ù…Ù†ÛŒ Ø°Ø®ÛŒØ±Ù‡ Ú©Ù†ÛŒØ¯\n";
        $message .= "â€¢ Ø¯Ø± ØµÙˆØ±Øª ÙØ±Ø§Ù…ÙˆØ´ÛŒØŒ ØªÙˆÚ©Ù† Ø¬Ø¯ÛŒØ¯ ØªÙˆÙ„ÛŒØ¯ Ú©Ù†ÛŒØ¯\n\n";
        $message .= "â„¹ï¸ Ø¨Ø±Ø§ÛŒ Ù„ØºÙˆ Ø¹Ù…Ù„ÛŒØ§Øª /security list Ø±Ø§ Ø§Ø±Ø³Ø§Ù„ Ú©Ù†ÛŒØ¯";

        $this->sendMessage($chatId, $message);
    }

    /**
     * Show security events
     */
    private function showSecurityEvents($chatId, int $page = 1): void
    {
        try {
            $perPage = 15;
            $offset = ($page - 1) * $perPage;

            $events = DB::table('telegram_security_events')
                ->select('id', 'event_type', 'severity', 'ip_address', 'user_agent', 'created_at')
                ->orderBy('created_at', 'desc')
                ->limit($perPage)
                ->offset($offset)
                ->get();

            $totalEvents = DB::table('telegram_security_events')->count();
            $totalPages = ceil($totalEvents / $perPage);

            if ($events->isEmpty()) {
                $this->sendMessage($chatId, "ğŸ›¡ï¸ Ù‡ÛŒÚ† Ø±ÙˆÛŒØ¯Ø§Ø¯ Ø§Ù…Ù†ÛŒØªÛŒ ÛŒØ§ÙØª Ù†Ø´Ø¯\n\nØ³ÛŒØ³ØªÙ… Ø§Ù…Ù†ÛŒØªÛŒ Ø¯Ø± Ø­Ø§Ù„ Ù†Ø¸Ø§Ø±Øª Ø§Ø³Øª.");
                return;
            }

            $message = "ğŸ›¡ï¸ <b>Ø±ÙˆÛŒØ¯Ø§Ø¯Ù‡Ø§ÛŒ Ø§Ù…Ù†ÛŒØªÛŒ</b>\n";
            $message .= "ØµÙØ­Ù‡ {$page} Ø§Ø² {$totalPages} (Ú©Ù„: {$totalEvents})\n\n";

            foreach ($events as $event) {
                $severityIcon = $this->getSecuritySeverityIcon($event->severity);
                $eventTime = \Carbon\Carbon::parse($event->created_at)->format('m/d H:i');
                $eventText = $this->getSecurityEventText($event->event_type);
                $ipAddress = $event->ip_address ? substr($event->ip_address, 0, 15) : 'Unknown';
                
                $message .= "{$severityIcon} <b>{$eventText}</b> (ID: {$event->id})\n";
                $message .= "â”” Ø²Ù…Ø§Ù†: {$eventTime}\n";
                $message .= "â”” IP: {$ipAddress}\n\n";
            }

            if ($totalPages > 1) {
                $message .= "ğŸ“„ ØµÙØ­Ù‡â€ŒØ¨Ù†Ø¯ÛŒ:\n";
                if ($page > 1) {
                    $message .= "â€¢ /security events " . ($page - 1) . " - ØµÙØ­Ù‡ Ù‚Ø¨Ù„\n";
                }
                if ($page < $totalPages) {
                    $message .= "â€¢ /security events " . ($page + 1) . " - ØµÙØ­Ù‡ Ø¨Ø¹Ø¯\n";
                }
            }

            $this->sendMessage($chatId, $message);

        } catch (\Exception $e) {
            Log::error('Security events error: ' . $e->getMessage());
            $this->sendMessage($chatId, "âŒ Ø®Ø·Ø§ Ø¯Ø± Ø¨Ø§Ø±Ú¯Ø°Ø§Ø±ÛŒ Ø±ÙˆÛŒØ¯Ø§Ø¯Ù‡Ø§ÛŒ Ø§Ù…Ù†ÛŒØªÛŒ");
        }
    }

    /**
     * Show audit logs
     */
    private function showAuditLogs($chatId, array $args): void
    {
        try {
            $page = (int)($args[0] ?? 1);
            $action = $args[1] ?? null;
            
            $perPage = 15;
            $offset = ($page - 1) * $perPage;

            $query = DB::table('telegram_audit_logs')
                ->select('id', 'action', 'admin_id', 'ip_address', 'created_at');

            if ($action) {
                $query->where('action', 'ILIKE', "%{$action}%");
            }

            $logs = $query->orderBy('created_at', 'desc')
                ->limit($perPage)
                ->offset($offset)
                ->get();

            $totalLogs = $query->count();
            $totalPages = ceil($totalLogs / $perPage);

            if ($logs->isEmpty()) {
                $this->sendMessage($chatId, "ğŸ“‹ Ù‡ÛŒÚ† Ù„Ø§Ú¯ Ø­Ø³Ø§Ø¨Ø±Ø³ÛŒ ÛŒØ§ÙØª Ù†Ø´Ø¯");
                return;
            }

            $message = "ğŸ“‹ <b>Ú¯Ø²Ø§Ø±Ø´ Ø­Ø³Ø§Ø¨Ø±Ø³ÛŒ</b>\n";
            $message .= "ØµÙØ­Ù‡ {$page} Ø§Ø² {$totalPages} (Ú©Ù„: {$totalLogs})\n";
            if ($action) {
                $message .= "ÙÛŒÙ„ØªØ±: {$action}\n";
            }
            $message .= "\n";

            foreach ($logs as $log) {
                $logTime = \Carbon\Carbon::parse($log->created_at)->format('m/d H:i');
                $actionText = $this->getAuditActionText($log->action);
                $adminId = $log->admin_id ?: 'Ø³ÛŒØ³ØªÙ…';
                
                $message .= "ğŸ“ <b>{$actionText}</b> (ID: {$log->id})\n";
                $message .= "â”” Ø²Ù…Ø§Ù†: {$logTime}\n";
                $message .= "â”” Ø§Ø¯Ù…ÛŒÙ†: {$adminId}\n";
                if ($log->ip_address) {
                    $message .= "â”” IP: {$log->ip_address}\n";
                }
                $message .= "\n";
            }

            $message .= "ğŸ’¡ Ø¨Ø±Ø§ÛŒ ÙÛŒÙ„ØªØ± Ø¨Ø± Ø§Ø³Ø§Ø³ Ø¹Ù…Ù„:\n";
            $message .= "/security audit [ØµÙØ­Ù‡] [Ù†ÙˆØ¹_Ø¹Ù…Ù„]";

            if ($totalPages > 1) {
                $message .= "\n\nğŸ“„ ØµÙØ­Ù‡â€ŒØ¨Ù†Ø¯ÛŒ:\n";
                if ($page > 1) {
                    $prevCmd = $action ? "/security audit " . ($page - 1) . " {$action}" : "/security audit " . ($page - 1);
                    $message .= "â€¢ {$prevCmd} - ØµÙØ­Ù‡ Ù‚Ø¨Ù„\n";
                }
                if ($page < $totalPages) {
                    $nextCmd = $action ? "/security audit " . ($page + 1) . " {$action}" : "/security audit " . ($page + 1);
                    $message .= "â€¢ {$nextCmd} - ØµÙØ­Ù‡ Ø¨Ø¹Ø¯\n";
                }
            }

            $this->sendMessage($chatId, $message);

        } catch (\Exception $e) {
            Log::error('Audit logs error: ' . $e->getMessage());
            $this->sendMessage($chatId, "âŒ Ø®Ø·Ø§ Ø¯Ø± Ø¨Ø§Ø±Ú¯Ø°Ø§Ø±ÛŒ Ù„Ø§Ú¯â€ŒÙ‡Ø§ÛŒ Ø­Ø³Ø§Ø¨Ø±Ø³ÛŒ");
        }
    }

    /**
     * Show security monitor
     */
    private function showSecurityMonitor($chatId): void
    {
        try {
            // Real-time security metrics
            $last24hEvents = DB::table('telegram_security_events')
                ->where('created_at', '>=', now()->subDay())
                ->count();

            $criticalEvents = DB::table('telegram_security_events')
                ->where('severity', 'critical')
                ->where('created_at', '>=', now()->subDay())
                ->count();

            $warningEvents = DB::table('telegram_security_events')
                ->where('severity', 'warning')
                ->where('created_at', '>=', now()->subDay())
                ->count();

            // Active tokens
            $activeTokens = DB::table('api_tokens')
                ->where('is_active', true)
                ->where(function($q) {
                    $q->whereNull('expires_at')
                      ->orWhere('expires_at', '>', now());
                })
                ->count();

            // Recent logins
            $recentLogins = DB::table('telegram_audit_logs')
                ->where('action', 'admin_login')
                ->where('created_at', '>=', now()->subHours(6))
                ->count();

            // Failed attempts
            $failedAttempts = DB::table('telegram_security_events')
                ->where('event_type', 'failed_login')
                ->where('created_at', '>=', now()->subHour())
                ->count();

            $message = "ğŸ” <b>Ù…Ø§Ù†ÛŒØªÙˆØ± Ø§Ù…Ù†ÛŒØªÛŒ Ø²Ù†Ø¯Ù‡</b>\n\n";
            $message .= "â° <b>Ø¢Ø®Ø±ÛŒÙ† 24 Ø³Ø§Ø¹Øª:</b>\n";
            $message .= "â”” Ú©Ù„ Ø±ÙˆÛŒØ¯Ø§Ø¯Ù‡Ø§: {$last24hEvents}\n";
            $message .= "â”” Ø¨Ø­Ø±Ø§Ù†ÛŒ: {$criticalEvents}\n";
            $message .= "â”” Ù‡Ø´Ø¯Ø§Ø±: {$warningEvents}\n\n";
            
            $message .= "ğŸ« <b>ÙˆØ¶Ø¹ÛŒØª ØªÙˆÚ©Ù†â€ŒÙ‡Ø§:</b>\n";
            $message .= "â”” ØªÙˆÚ©Ù†â€ŒÙ‡Ø§ÛŒ ÙØ¹Ø§Ù„: {$activeTokens}\n\n";
            
            $message .= "ğŸ‘¤ <b>Ø¯Ø³ØªØ±Ø³ÛŒâ€ŒÙ‡Ø§:</b>\n";
            $message .= "â”” ÙˆØ±ÙˆØ¯ Ø§Ø®ÛŒØ± (6Ø³Ø§Ø¹Øª): {$recentLogins}\n";
            $message .= "â”” ØªÙ„Ø§Ø´â€ŒÙ‡Ø§ÛŒ Ù†Ø§Ù…ÙˆÙÙ‚ (1Ø³Ø§Ø¹Øª): {$failedAttempts}\n\n";
            
            // Security status
            $securityStatus = 'Ø³Ø¨Ø²';
            $statusIcon = 'ğŸŸ¢';
            
            if ($criticalEvents > 0) {
                $securityStatus = 'Ù‚Ø±Ù…Ø²';
                $statusIcon = 'ğŸ”´';
            } elseif ($warningEvents > 5 || $failedAttempts > 10) {
                $securityStatus = 'Ù†Ø§Ø±Ù†Ø¬ÛŒ';
                $statusIcon = 'ğŸŸ ';
            }
            
            $message .= "ğŸ›¡ï¸ <b>ÙˆØ¶Ø¹ÛŒØª Ø§Ù…Ù†ÛŒØªÛŒ:</b>\n";
            $message .= "â”” Ø³Ø·Ø­: {$statusIcon} {$securityStatus}\n";
            $message .= "â”” Ø¢Ø®Ø±ÛŒÙ† Ø¨Ø±Ø±Ø³ÛŒ: " . now()->format('H:i:s') . "\n\n";
            
            $message .= "ğŸ”„ Ø¨Ø±Ø§ÛŒ Ø¨Ù‡â€ŒØ±ÙˆØ²Ø±Ø³Ø§Ù†ÛŒ: /security monitor\n";
            $message .= "ğŸ“Š Ø¨Ø±Ø§ÛŒ Ø¬Ø²Ø¦ÛŒØ§Øª Ø¨ÛŒØ´ØªØ±: /security dashboard";

            $this->sendMessage($chatId, $message);

        } catch (\Exception $e) {
            Log::error('Security monitor error: ' . $e->getMessage());
            $this->sendMessage($chatId, "âŒ Ø®Ø·Ø§ Ø¯Ø± Ù†Ù…Ø§ÛŒØ´ Ù…Ø§Ù†ÛŒØªÙˆØ± Ø§Ù…Ù†ÛŒØªÛŒ");
        }
    }

    /**
     * Get security severity icon
     */
    private function getSecuritySeverityIcon($severity): string
    {
        $icons = [
            'low' => 'ğŸŸ¢',
            'medium' => 'ğŸŸ¡', 
            'warning' => 'ğŸŸ ',
            'high' => 'ğŸ”´',
            'critical' => 'ğŸš¨'
        ];

        return $icons[$severity] ?? 'â“';
    }

    /**
     * Get security event text in Persian
     */
    private function getSecurityEventText($eventType): string
    {
        $events = [
            'login_attempt' => 'ØªÙ„Ø§Ø´ ÙˆØ±ÙˆØ¯',
            'failed_login' => 'ÙˆØ±ÙˆØ¯ Ù†Ø§Ù…ÙˆÙÙ‚',
            'successful_login' => 'ÙˆØ±ÙˆØ¯ Ù…ÙˆÙÙ‚',
            'token_created' => 'Ø§ÛŒØ¬Ø§Ø¯ ØªÙˆÚ©Ù†',
            'token_revoked' => 'Ù„ØºÙˆ ØªÙˆÚ©Ù†',
            'unauthorized_access' => 'Ø¯Ø³ØªØ±Ø³ÛŒ ØºÛŒØ±Ù…Ø¬Ø§Ø²',
            'rate_limit_exceeded' => 'ØªØ¬Ø§ÙˆØ² Ø§Ø² Ù…Ø­Ø¯ÙˆØ¯ÛŒØª',
            'suspicious_activity' => 'ÙØ¹Ø§Ù„ÛŒØª Ù…Ø´Ú©ÙˆÚ©',
            'data_breach_attempt' => 'ØªÙ„Ø§Ø´ Ù†Ù‚Ø¶ Ø¯Ø§Ø¯Ù‡',
            'malicious_request' => 'Ø¯Ø±Ø®ÙˆØ§Ø³Øª Ù…Ø®Ø±Ø¨'
        ];

        return $events[$eventType] ?? $eventType;
    }

    /**
     * Get audit action text in Persian
     */
    private function getAuditActionText($action): string
    {
        $actions = [
            'admin_login' => 'ÙˆØ±ÙˆØ¯ Ø§Ø¯Ù…ÛŒÙ†',
            'user_created' => 'Ø§ÛŒØ¬Ø§Ø¯ Ú©Ø§Ø±Ø¨Ø±',
            'user_banned' => 'Ù…Ø³Ø¯ÙˆØ¯ Ú©Ø±Ø¯Ù† Ú©Ø§Ø±Ø¨Ø±',
            'wallet_adjusted' => 'ØªØ¹Ø¯ÛŒÙ„ Ú©ÛŒÙ Ù¾ÙˆÙ„',
            'ticket_assigned' => 'ÙˆØ§Ú¯Ø°Ø§Ø±ÛŒ ØªÛŒÚ©Øª',
            'post_published' => 'Ø§Ù†ØªØ´Ø§Ø± Ù¾Ø³Øª',
            'token_created' => 'Ø§ÛŒØ¬Ø§Ø¯ ØªÙˆÚ©Ù†',
            'ai_content_generated' => 'ØªÙˆÙ„ÛŒØ¯ Ù…Ø­ØªÙˆØ§ÛŒ AI'
        ];

        return $actions[$action] ?? $action;
    }

    private function viewAPIToken($chatId, $tokenId): void
    {
        try {
            $token = DB::table('api_tokens')
                ->where('id', $tokenId)
                ->first();

            if (!$token) {
                $this->sendMessage($chatId, "âŒ ØªÙˆÚ©Ù† ÛŒØ§ÙØª Ù†Ø´Ø¯");
                return;
            }

            $lastUsed = $token->last_used_at ? 
                Carbon::parse($token->last_used_at)->format('Y-m-d H:i:s') : 
                'Ù‡Ø±Ú¯Ø² Ø§Ø³ØªÙØ§Ø¯Ù‡ Ù†Ø´Ø¯Ù‡';

            $message = "ğŸ” Ø¬Ø²Ø¦ÛŒØ§Øª ØªÙˆÚ©Ù† API\n\n";
            $message .= "ğŸ·ï¸ Ù†Ø§Ù…: {$token->name}\n";
            $message .= "ğŸ”‘ Ø´Ù†Ø§Ø³Ù‡: {$token->id}\n";
            $message .= "ğŸ“… ØªØ§Ø±ÛŒØ® Ø§ÛŒØ¬Ø§Ø¯: " . Carbon::parse($token->created_at)->format('Y-m-d H:i:s') . "\n";
            $message .= "ğŸ• Ø¢Ø®Ø±ÛŒÙ† Ø§Ø³ØªÙØ§Ø¯Ù‡: {$lastUsed}\n";
            $message .= "ğŸ“Š ØªØ¹Ø¯Ø§Ø¯ Ø§Ø³ØªÙØ§Ø¯Ù‡: " . ($token->usage_count ?? 0) . "\n";
            $message .= "â° Ø§Ù†Ù‚Ø¶Ø§: " . ($token->expires_at ? Carbon::parse($token->expires_at)->format('Y-m-d H:i:s') : 'Ù†Ø§Ù…Ø­Ø¯ÙˆØ¯') . "\n";
            $message .= "ğŸŒ IP Ø¢Ø®Ø±ÛŒÙ† Ø¯Ø³ØªØ±Ø³ÛŒ: " . ($token->last_used_ip ?? 'Ù†Ø§Ù…Ø´Ø®Øµ') . "\n";
            $message .= "ğŸ”’ ÙˆØ¶Ø¹ÛŒØª: " . ($token->is_active ? 'ğŸŸ¢ ÙØ¹Ø§Ù„' : 'ğŸ”´ ØºÛŒØ±ÙØ¹Ø§Ù„') . "\n\n";
            
            // Usage statistics for last 7 days
            $usageStats = DB::table('api_usage_logs')
                ->where('token_id', $tokenId)
                ->where('created_at', '>=', Carbon::now()->subDays(7))
                ->selectRaw('DATE(created_at) as date, COUNT(*) as count')
                ->groupBy('date')
                ->orderBy('date', 'desc')
                ->get();

            if ($usageStats->isNotEmpty()) {
                $message .= "ğŸ“ˆ Ø¢Ù…Ø§Ø± Ø§Ø³ØªÙØ§Ø¯Ù‡ (7 Ø±ÙˆØ² Ø§Ø®ÛŒØ±):\n";
                foreach ($usageStats as $stat) {
                    $date = Carbon::parse($stat->date)->format('Y-m-d');
                    $message .= "â€¢ {$date}: {$stat->count} Ø¯Ø±Ø®ÙˆØ§Ø³Øª\n";
                }
            }

            $keyboard = [
                'inline_keyboard' => [
                    [
                        ['text' => 'ğŸ”„ Ø¨Ø§Ø²ØªÙˆÙ„ÛŒØ¯', 'callback_data' => "regenerate_token_{$tokenId}"],
                        ['text' => 'âŒ Ù„ØºÙˆ', 'callback_data' => "revoke_token_{$tokenId}"]
                    ],
                    [
                        ['text' => 'ğŸ“Š Ú¯Ø²Ø§Ø±Ø´ ØªÙØµÛŒÙ„ÛŒ', 'callback_data' => "token_report_{$tokenId}"],
                        ['text' => 'ğŸ”™ Ø¨Ø§Ø²Ú¯Ø´Øª', 'callback_data' => 'security_list']
                    ]
                ]
            ];

            $this->sendMessage($chatId, $message, $keyboard);

        } catch (\Exception $e) {
            $this->sendMessage($chatId, "âŒ Ø®Ø·Ø§ Ø¯Ø± Ù†Ù…Ø§ÛŒØ´ Ø¬Ø²Ø¦ÛŒØ§Øª ØªÙˆÚ©Ù†: " . $e->getMessage());
        }
    }

    private function revokeAPIToken($chatId, $tokenId): void
    {
        try {
            $token = DB::table('api_tokens')
                ->where('id', $tokenId)
                ->first();

            if (!$token) {
                $this->sendMessage($chatId, "âŒ ØªÙˆÚ©Ù† ÛŒØ§ÙØª Ù†Ø´Ø¯");
                return;
            }

            // Log security event
            DB::table('security_events')->insert([
                'event_type' => 'token_revoked',
                'description' => "API token '{$token->name}' revoked by admin",
                'ip_address' => '127.0.0.1',
                'user_agent' => 'Telegram Bot Admin',
                'admin_user_id' => $this->getCurrentUserId(),
                'metadata' => json_encode([
                    'token_id' => $tokenId,
                    'token_name' => $token->name,
                    'revoked_by' => 'telegram_admin'
                ]),
                'severity' => 'medium',
                'created_at' => now()
            ]);

            // Deactivate the token
            DB::table('api_tokens')
                ->where('id', $tokenId)
                ->update([
                    'is_active' => false,
                    'revoked_at' => now(),
                    'revoked_by' => $this->getCurrentUserId(),
                    'revoke_reason' => 'Admin revocation via Telegram'
                ]);

            // Log audit event
            $this->logAuditEvent('api_token_revoked', [
                'token_id' => $tokenId,
                'token_name' => $token->name
            ]);

            $message = "âœ… ØªÙˆÚ©Ù† Ø¨Ø§ Ù…ÙˆÙÙ‚ÛŒØª Ù„ØºÙˆ Ø´Ø¯\n\n";
            $message .= "ğŸ·ï¸ Ù†Ø§Ù… ØªÙˆÚ©Ù†: {$token->name}\n";
            $message .= "ğŸ”‘ Ø´Ù†Ø§Ø³Ù‡: {$tokenId}\n";
            $message .= "ğŸ• Ø²Ù…Ø§Ù† Ù„ØºÙˆ: " . now()->format('Y-m-d H:i:s') . "\n\n";
            $message .= "âš ï¸ Ø§ÛŒÙ† ØªÙˆÚ©Ù† Ø¯ÛŒÚ¯Ø± Ù‚Ø§Ø¨Ù„ Ø§Ø³ØªÙØ§Ø¯Ù‡ Ù†Ø®ÙˆØ§Ù‡Ø¯ Ø¨ÙˆØ¯";

            $keyboard = [
                'inline_keyboard' => [
                    [
                        ['text' => 'ğŸ“‹ Ù„ÛŒØ³Øª ØªÙˆÚ©Ù†â€ŒÙ‡Ø§', 'callback_data' => 'security_list'],
                        ['text' => 'ğŸ”™ Ø¨Ø§Ø²Ú¯Ø´Øª', 'callback_data' => 'security_dashboard']
                    ]
                ]
            ];

            $this->sendMessage($chatId, $message, $keyboard);

        } catch (\Exception $e) {
            $this->sendMessage($chatId, "âŒ Ø®Ø·Ø§ Ø¯Ø± Ù„ØºÙˆ ØªÙˆÚ©Ù†: " . $e->getMessage());
        }
    }

    private function regenerateAPIToken($chatId, $tokenId): void
    {
        try {
            $token = DB::table('api_tokens')
                ->where('id', $tokenId)
                ->first();

            if (!$token) {
                $this->sendMessage($chatId, "âŒ ØªÙˆÚ©Ù† ÛŒØ§ÙØª Ù†Ø´Ø¯");
                return;
            }

            // Generate new token
            $newToken = bin2hex(random_bytes(32));
            $hashedToken = hash('sha256', $newToken);

            // Log security event
            DB::table('security_events')->insert([
                'event_type' => 'token_regenerated',
                'description' => "API token '{$token->name}' regenerated by admin",
                'ip_address' => '127.0.0.1',
                'user_agent' => 'Telegram Bot Admin',
                'admin_user_id' => $this->getCurrentUserId(),
                'metadata' => json_encode([
                    'token_id' => $tokenId,
                    'token_name' => $token->name,
                    'regenerated_by' => 'telegram_admin'
                ]),
                'severity' => 'medium',
                'created_at' => now()
            ]);

            // Update token
            DB::table('api_tokens')
                ->where('id', $tokenId)
                ->update([
                    'token' => $hashedToken,
                    'regenerated_at' => now(),
                    'regenerated_by' => $this->getCurrentUserId(),
                    'usage_count' => 0,
                    'last_used_at' => null,
                    'last_used_ip' => null
                ]);

            // Log audit event
            $this->logAuditEvent('api_token_regenerated', [
                'token_id' => $tokenId,
                'token_name' => $token->name
            ]);

            $message = "ğŸ”„ ØªÙˆÚ©Ù† Ø¨Ø§ Ù…ÙˆÙÙ‚ÛŒØª Ø¨Ø§Ø²ØªÙˆÙ„ÛŒØ¯ Ø´Ø¯\n\n";
            $message .= "ğŸ·ï¸ Ù†Ø§Ù… ØªÙˆÚ©Ù†: {$token->name}\n";
            $message .= "ğŸ”‘ Ø´Ù†Ø§Ø³Ù‡: {$tokenId}\n";
            $message .= "ğŸ• Ø²Ù…Ø§Ù† Ø¨Ø§Ø²ØªÙˆÙ„ÛŒØ¯: " . now()->format('Y-m-d H:i:s') . "\n\n";
            $message .= "ğŸ” ØªÙˆÚ©Ù† Ø¬Ø¯ÛŒØ¯:\n";
            $message .= "`{$newToken}`\n\n";
            $message .= "âš ï¸ Ø§ÛŒÙ† ØªÙˆÚ©Ù† Ø±Ø§ Ø¯Ø± Ù…Ú©Ø§Ù† Ø§Ù…Ù† Ù†Ú¯Ù‡Ø¯Ø§Ø±ÛŒ Ú©Ù†ÛŒØ¯\n";
            $message .= "âš ï¸ ØªÙˆÚ©Ù† Ù‚Ø¨Ù„ÛŒ Ø¯ÛŒÚ¯Ø± Ù‚Ø§Ø¨Ù„ Ø§Ø³ØªÙØ§Ø¯Ù‡ Ù†ÛŒØ³Øª";

            $keyboard = [
                'inline_keyboard' => [
                    [
                        ['text' => 'ğŸ” Ù†Ù…Ø§ÛŒØ´ Ø¬Ø²Ø¦ÛŒØ§Øª', 'callback_data' => "view_token_{$tokenId}"],
                        ['text' => 'ğŸ“‹ Ù„ÛŒØ³Øª ØªÙˆÚ©Ù†â€ŒÙ‡Ø§', 'callback_data' => 'security_list']
                    ],
                    [
                        ['text' => 'ğŸ”™ Ø¨Ø§Ø²Ú¯Ø´Øª', 'callback_data' => 'security_dashboard']
                    ]
                ]
            ];

            $this->sendMessage($chatId, $message, $keyboard, 'Markdown');

        } catch (\Exception $e) {
            $this->sendMessage($chatId, "âŒ Ø®Ø·Ø§ Ø¯Ø± Ø¨Ø§Ø²ØªÙˆÙ„ÛŒØ¯ ØªÙˆÚ©Ù†: " . $e->getMessage());
        }
    }

    private function showSecurityLogs($chatId, array $args): void
    {
        try {
            $page = isset($args[0]) ? max(1, (int)$args[0]) : 1;
            $perPage = 10;
            $offset = ($page - 1) * $perPage;

            // Get security logs (different from audit logs - these are system security events)
            $logs = DB::table('security_events')
                ->orderBy('created_at', 'desc')
                ->limit($perPage)
                ->offset($offset)
                ->get();

            $totalLogs = DB::table('security_events')->count();
            $totalPages = ceil($totalLogs / $perPage);

            $message = "ğŸ” Ú¯Ø²Ø§Ø±Ø´â€ŒÙ‡Ø§ÛŒ Ø§Ù…Ù†ÛŒØªÛŒ\n\n";
            $message .= "ğŸ“Š Ú©Ù„ Ø±ÙˆÛŒØ¯Ø§Ø¯Ù‡Ø§: {$totalLogs}\n";
            $message .= "ğŸ“„ ØµÙØ­Ù‡ {$page} Ø§Ø² {$totalPages}\n\n";

            if ($logs->isEmpty()) {
                $message .= "ğŸ“ Ù‡ÛŒÚ† Ø±ÙˆÛŒØ¯Ø§Ø¯ Ø§Ù…Ù†ÛŒØªÛŒ Ø«Ø¨Øª Ù†Ø´Ø¯Ù‡";
            } else {
                foreach ($logs as $log) {
                    $severity = $this->getSeverityEmoji($log->severity);
                    $time = Carbon::parse($log->created_at)->format('m/d H:i');
                    
                    $message .= "{$severity} {$log->event_type}\n";
                    $message .= "ğŸ• {$time} | ğŸŒ {$log->ip_address}\n";
                    $message .= "ğŸ“ " . substr($log->description, 0, 60) . "...\n\n";
                }
            }

            $keyboard = [];
            
            // Pagination
            $paginationRow = [];
            if ($page > 1) {
                $paginationRow[] = ['text' => 'â®ï¸ Ù‚Ø¨Ù„ÛŒ', 'callback_data' => "security_logs_" . ($page - 1)];
            }
            if ($page < $totalPages) {
                $paginationRow[] = ['text' => 'â­ï¸ Ø¨Ø¹Ø¯ÛŒ', 'callback_data' => "security_logs_" . ($page + 1)];
            }
            
            if (!empty($paginationRow)) {
                $keyboard[] = $paginationRow;
            }

            // Filter and action buttons
            $keyboard[] = [
                ['text' => 'ğŸš¨ ÙÙ‚Ø· Ù‡Ø´Ø¯Ø§Ø±Ù‡Ø§', 'callback_data' => 'security_logs_alerts'],
                ['text' => 'ğŸ” Ø¬Ø³ØªØ¬Ùˆ', 'callback_data' => 'security_logs_search']
            ];
            
            $keyboard[] = [
                ['text' => 'ğŸ“Š Ø¢Ù…Ø§Ø± Ø§Ù…Ù†ÛŒØªÛŒ', 'callback_data' => 'security_stats'],
                ['text' => 'ğŸ”™ Ø¨Ø§Ø²Ú¯Ø´Øª', 'callback_data' => 'security_dashboard']
            ];

            $this->sendMessage($chatId, $message, ['inline_keyboard' => $keyboard]);

        } catch (\Exception $e) {
            $this->sendMessage($chatId, "âŒ Ø®Ø·Ø§ Ø¯Ø± Ù†Ù…Ø§ÛŒØ´ Ú¯Ø²Ø§Ø±Ø´â€ŒÙ‡Ø§ÛŒ Ø§Ù…Ù†ÛŒØªÛŒ: " . $e->getMessage());
        }
    }

    private function manageSecuritySettings($chatId): void
    {
        try {
            // Get current security settings
            $settings = [
                'max_failed_logins' => config('security.max_failed_logins', 5),
                'token_expiry_days' => config('security.token_expiry_days', 90),
                'session_timeout' => config('security.session_timeout', 3600),
                'enable_2fa' => config('security.enable_2fa', false),
                'ip_whitelist_enabled' => config('security.ip_whitelist_enabled', false),
                'audit_log_retention' => config('security.audit_log_retention_days', 365),
            ];

            $message = "âš™ï¸ ØªÙ†Ø¸ÛŒÙ…Ø§Øª Ø§Ù…Ù†ÛŒØªÛŒ\n\n";
            $message .= "ğŸ” Ø­Ø¯Ø§Ú©Ø«Ø± ØªÙ„Ø§Ø´ Ù†Ø§Ù…ÙˆÙÙ‚ ÙˆØ±ÙˆØ¯: {$settings['max_failed_logins']}\n";
            $message .= "â° Ø§Ù†Ù‚Ø¶Ø§ÛŒ ØªÙˆÚ©Ù† (Ø±ÙˆØ²): {$settings['token_expiry_days']}\n";
            $message .= "ğŸ• Ù…Ù‡Ù„Øª Ø¬Ù„Ø³Ù‡ (Ø«Ø§Ù†ÛŒÙ‡): {$settings['session_timeout']}\n";
            $message .= "ğŸ” Ø§Ø­Ø±Ø§Ø² Ù‡ÙˆÛŒØª Ø¯Ùˆ Ù…Ø±Ø­Ù„Ù‡â€ŒØ§ÛŒ: " . ($settings['enable_2fa'] ? 'âœ… ÙØ¹Ø§Ù„' : 'âŒ ØºÛŒØ±ÙØ¹Ø§Ù„') . "\n";
            $message .= "ğŸŒ Ù…Ø­Ø¯ÙˆØ¯ÛŒØª IP: " . ($settings['ip_whitelist_enabled'] ? 'âœ… ÙØ¹Ø§Ù„' : 'âŒ ØºÛŒØ±ÙØ¹Ø§Ù„') . "\n";
            $message .= "ğŸ“š Ù†Ú¯Ù‡Ø¯Ø§Ø±ÛŒ Ú¯Ø²Ø§Ø±Ø´â€ŒÙ‡Ø§ (Ø±ÙˆØ²): {$settings['audit_log_retention']}\n\n";

            // Security status indicators
            $securityScore = $this->calculateSecurityScore($settings);
            $scoreEmoji = $securityScore >= 80 ? 'ğŸŸ¢' : ($securityScore >= 60 ? 'ğŸŸ¡' : 'ğŸ”´');
            
            $message .= "ğŸ“Š Ø§Ù…ØªÛŒØ§Ø² Ø§Ù…Ù†ÛŒØªÛŒ: {$scoreEmoji} {$securityScore}%\n\n";

            $keyboard = [
                'inline_keyboard' => [
                    [
                        ['text' => 'ğŸ” ØªÙ†Ø¸ÛŒÙ…Ø§Øª ÙˆØ±ÙˆØ¯', 'callback_data' => 'security_auth_settings'],
                        ['text' => 'ğŸ”‘ Ù…Ø¯ÛŒØ±ÛŒØª ØªÙˆÚ©Ù†', 'callback_data' => 'security_token_settings']
                    ],
                    [
                        ['text' => 'ğŸŒ Ú©Ù†ØªØ±Ù„ Ø¯Ø³ØªØ±Ø³ÛŒ IP', 'callback_data' => 'security_ip_settings'],
                        ['text' => 'ğŸ“Š ØªÙ†Ø¸ÛŒÙ…Ø§Øª Ù†Ø¸Ø§Ø±Øª', 'callback_data' => 'security_monitor_settings']
                    ],
                    [
                        ['text' => 'ğŸ”„ Ø¨Ø§Ø²Ù†Ø´Ø§Ù†ÛŒ ØªÙ†Ø¸ÛŒÙ…Ø§Øª', 'callback_data' => 'security_reset_settings'],
                        ['text' => 'ğŸ’¾ Ø¨Ú©Ø§Ù¾ ØªÙ†Ø¸ÛŒÙ…Ø§Øª', 'callback_data' => 'security_backup_settings']
                    ],
                    [
                        ['text' => 'ğŸ”™ Ø¨Ø§Ø²Ú¯Ø´Øª', 'callback_data' => 'security_dashboard']
                    ]
                ]
            ];

            $this->sendMessage($chatId, $message, $keyboard);

        } catch (\Exception $e) {
            $this->sendMessage($chatId, "âŒ Ø®Ø·Ø§ Ø¯Ø± Ù†Ù…Ø§ÛŒØ´ ØªÙ†Ø¸ÛŒÙ…Ø§Øª Ø§Ù…Ù†ÛŒØªÛŒ: " . $e->getMessage());
        }
    }

    private function getSeverityEmoji($severity): string
    {
        return match($severity) {
            'critical' => 'ğŸ”´',
            'high' => 'ğŸŸ ',
            'medium' => 'ğŸŸ¡',
            'low' => 'ğŸŸ¢',
            'info' => 'ğŸ”µ',
            default => 'âšª'
        };
    }

    private function calculateSecurityScore($settings): int
    {
        $score = 0;
        
        // Basic security measures
        if ($settings['max_failed_logins'] <= 5) $score += 20;
        if ($settings['token_expiry_days'] <= 90) $score += 15;
        if ($settings['session_timeout'] <= 3600) $score += 10;
        
        // Advanced security features
        if ($settings['enable_2fa']) $score += 25;
        if ($settings['ip_whitelist_enabled']) $score += 20;
        
        // Audit and compliance
        if ($settings['audit_log_retention'] >= 365) $score += 10;
        
        return min(100, $score);
    }

    private function getCurrentUserId(): int
    {
        // For Telegram admin operations, we can use a special admin user ID
        // or track the admin who performed the action
        return 1; // Default admin user ID
    }

    /**
     * Show security help
     */
    private function showSecurityHelp($chatId): void
    {
        $message = "ğŸ” <b>Ø±Ø§Ù‡Ù†Ù…Ø§ÛŒ Ù…Ø¯ÛŒØ±ÛŒØª Ø§Ù…Ù†ÛŒØª</b>\n\n";
        
        $message .= "ğŸ« <b>Ù…Ø¯ÛŒØ±ÛŒØª API ØªÙˆÚ©Ù†â€ŒÙ‡Ø§:</b>\n";
        $message .= "â€¢ /security list - Ù„ÛŒØ³Øª ØªÙˆÚ©Ù†â€ŒÙ‡Ø§\n";
        $message .= "â€¢ /security create - Ø§ÛŒØ¬Ø§Ø¯ ØªÙˆÚ©Ù† Ø¬Ø¯ÛŒØ¯\n";
        $message .= "â€¢ /security view &lt;ID&gt; - Ù†Ù…Ø§ÛŒØ´ ØªÙˆÚ©Ù†\n";
        $message .= "â€¢ /security revoke &lt;ID&gt; - Ù„ØºÙˆ ØªÙˆÚ©Ù†\n";
        $message .= "â€¢ /security regenerate &lt;ID&gt; - ØªÙˆÙ„ÛŒØ¯ Ù…Ø¬Ø¯Ø¯\n\n";
        
        $message .= "ğŸ›¡ï¸ <b>Ù†Ø¸Ø§Ø±Øª Ø§Ù…Ù†ÛŒØªÛŒ:</b>\n";
        $message .= "â€¢ /security events - Ø±ÙˆÛŒØ¯Ø§Ø¯Ù‡Ø§ÛŒ Ø§Ù…Ù†ÛŒØªÛŒ\n";
        $message .= "â€¢ /security logs - Ù„Ø§Ú¯â€ŒÙ‡Ø§ÛŒ Ø³ÛŒØ³ØªÙ…\n";
        $message .= "â€¢ /security audit - Ú¯Ø²Ø§Ø±Ø´ Ø­Ø³Ø§Ø¨Ø±Ø³ÛŒ\n";
        $message .= "â€¢ /security monitor - Ù…Ø§Ù†ÛŒØªÙˆØ± Ø²Ù†Ø¯Ù‡\n\n";
        
        $message .= "âš™ï¸ <b>ØªÙ†Ø¸ÛŒÙ…Ø§Øª:</b>\n";
        $message .= "â€¢ /security settings - ØªÙ†Ø¸ÛŒÙ…Ø§Øª Ø§Ù…Ù†ÛŒØªÛŒ\n\n";
        
        $message .= "â„¹ï¸ Ø¨Ø±Ø§ÛŒ Ø¯Ø±ÛŒØ§ÙØª Ø¯Ø§Ø´Ø¨ÙˆØ±Ø¯ Ú©Ø§Ù…Ù„ Ø§Ø² /security Ø§Ø³ØªÙØ§Ø¯Ù‡ Ú©Ù†ÛŒØ¯";

        $this->sendMessage($chatId, $message);
    }

    /**
     * Handle website settings management
     */
    private function handleWebsiteSettings(\App\Services\Telegram\Core\UpdateContext $context): void
    {
        $chatId = $context->getChatId();
        $text = $context->getMessage()->getText();
        $args = array_slice(explode(' ', $text), 1); // Remove /settings command
        $subcommand = $args[0] ?? 'dashboard';

        Log::info('Website settings management', ['subcommand' => $subcommand, 'args' => $args]);

        try {
            switch ($subcommand) {
                case 'dashboard':
                case 'menu':
                    $this->showSettingsDashboard($chatId);
                    break;

                case 'general':
                    $this->manageGeneralSettings($chatId, array_slice($args, 1));
                    break;

                case 'maintenance':
                    $this->manageMaintenanceMode($chatId, array_slice($args, 1));
                    break;

                case 'email':
                    $this->manageEmailSettings($chatId, array_slice($args, 1));
                    break;

                case 'social':
                    $this->manageSocialSettings($chatId, array_slice($args, 1));
                    break;

                case 'seo':
                    $this->manageSEOSettings($chatId, array_slice($args, 1));
                    break;

                case 'backup':
                    $this->manageBackupSettings($chatId, array_slice($args, 1));
                    break;

                case 'logs':
                    $this->showSystemLogs($chatId, array_slice($args, 1));
                    break;

                case 'cache':
                    $this->manageCacheSettings($chatId, array_slice($args, 1));
                    break;

                case 'export':
                    $this->exportSettings($chatId, array_slice($args, 1));
                    break;

                case 'import':
                    $this->importSettings($chatId, array_slice($args, 1));
                    break;

                case 'reset':
                    $this->resetSettings($chatId, array_slice($args, 1));
                    break;

                default:
                    $this->showSettingsHelp($chatId);
                    break;
            }

        } catch (\Exception $e) {
            Log::error('Website settings management error: ' . $e->getMessage());
            $this->sendMessage($chatId, "âŒ Ø®Ø·Ø§ Ø¯Ø± Ù…Ø¯ÛŒØ±ÛŒØª ØªÙ†Ø¸ÛŒÙ…Ø§Øª: " . $e->getMessage());
        }
    }

    private function showSettingsDashboard($chatId): void
    {
        try {
            // Get current system settings
            $generalSettings = [
                'site_name' => config('app.name', 'Pishkhanak'),
                'site_url' => config('app.url'),
                'admin_email' => config('mail.from.address'),
                'timezone' => config('app.timezone'),
                'locale' => config('app.locale'),
                'debug_mode' => config('app.debug')
            ];

            $systemStatus = [
                'maintenance_mode' => app()->isDownForMaintenance(),
                'cache_enabled' => config('cache.default') !== 'null',
                'queue_connection' => config('queue.default'),
                'mail_configured' => !empty(config('mail.mailers.smtp.host')),
                'redis_connected' => $this->checkRedisConnection(),
                'database_connected' => $this->checkDatabaseConnection()
            ];

            $message = "âš™ï¸ **Ø¯Ø§Ø´Ø¨ÙˆØ±Ø¯ ØªÙ†Ø¸ÛŒÙ…Ø§Øª ÙˆØ¨â€ŒØ³Ø§ÛŒØª**\n\n";
            
            // General info
            $message .= "ğŸ¢ **Ø§Ø·Ù„Ø§Ø¹Ø§Øª Ú©Ù„ÛŒ:**\n";
            $message .= "â€¢ Ù†Ø§Ù… Ø³Ø§ÛŒØª: {$generalSettings['site_name']}\n";
            $message .= "â€¢ Ø¢Ø¯Ø±Ø³: " . parse_url($generalSettings['site_url'], PHP_URL_HOST) . "\n";
            $message .= "â€¢ Ø§ÛŒÙ…ÛŒÙ„ Ù…Ø¯ÛŒØ±: {$generalSettings['admin_email']}\n";
            $message .= "â€¢ Ù…Ù†Ø·Ù‚Ù‡ Ø²Ù…Ø§Ù†ÛŒ: {$generalSettings['timezone']}\n";
            $message .= "â€¢ Ø²Ø¨Ø§Ù†: {$generalSettings['locale']}\n\n";

            // System status
            $message .= "ğŸ“Š **ÙˆØ¶Ø¹ÛŒØª Ø³ÛŒØ³ØªÙ…:**\n";
            $message .= "â€¢ Ø­Ø§Ù„Øª ØªØ¹Ù…ÛŒØ±Ø§Øª: " . ($systemStatus['maintenance_mode'] ? 'ğŸ”´ ÙØ¹Ø§Ù„' : 'ğŸŸ¢ ØºÛŒØ±ÙØ¹Ø§Ù„') . "\n";
            $message .= "â€¢ Ú©Ø´: " . ($systemStatus['cache_enabled'] ? 'ğŸŸ¢ ÙØ¹Ø§Ù„' : 'ğŸ”´ ØºÛŒØ±ÙØ¹Ø§Ù„') . "\n";
            $message .= "â€¢ ØµÙ Ú©Ø§Ø±Ù‡Ø§: " . ucfirst($systemStatus['queue_connection']) . "\n";
            $message .= "â€¢ Ø§ÛŒÙ…ÛŒÙ„: " . ($systemStatus['mail_configured'] ? 'ğŸŸ¢ ØªÙ†Ø¸ÛŒÙ… Ø´Ø¯Ù‡' : 'ğŸ”´ ØªÙ†Ø¸ÛŒÙ… Ù†Ø´Ø¯Ù‡') . "\n";
            $message .= "â€¢ Redis: " . ($systemStatus['redis_connected'] ? 'ğŸŸ¢ Ù…ØªØµÙ„' : 'ğŸ”´ Ù‚Ø·Ø¹') . "\n";
            $message .= "â€¢ Ø¯ÛŒØªØ§Ø¨ÛŒØ³: " . ($systemStatus['database_connected'] ? 'ğŸŸ¢ Ù…ØªØµÙ„' : 'ğŸ”´ Ù‚Ø·Ø¹') . "\n\n";

            // Quick stats
            $stats = [
                'total_users' => DB::table('users')->count(),
                'active_sessions' => DB::table('sessions')->where('last_activity', '>', time() - 3600)->count(),
                'disk_usage' => $this->getDiskUsage(),
                'memory_usage' => $this->getMemoryUsage()
            ];

            $message .= "ğŸ“ˆ **Ø¢Ù…Ø§Ø± Ø³ÛŒØ³ØªÙ…:**\n";
            $message .= "â€¢ Ú©Ø§Ø±Ø¨Ø±Ø§Ù†: " . number_format($stats['total_users']) . "\n";
            $message .= "â€¢ Ø¬Ù„Ø³Ø§Øª ÙØ¹Ø§Ù„: " . number_format($stats['active_sessions']) . "\n";
            $message .= "â€¢ ÙØ¶Ø§ÛŒ Ø¯ÛŒØ³Ú©: {$stats['disk_usage']}% Ø§Ø³ØªÙØ§Ø¯Ù‡\n";
            $message .= "â€¢ Ø­Ø§ÙØ¸Ù‡: {$stats['memory_usage']}% Ø§Ø³ØªÙØ§Ø¯Ù‡\n\n";

            $message .= "ğŸ”§ Ø¯Ø³ØªÙˆØ±Ø§Øª Ø±Ø§ Ø§Ø² Ù…Ù†ÙˆÛŒ Ø²ÛŒØ± Ø§Ù†ØªØ®Ø§Ø¨ Ú©Ù†ÛŒØ¯:";

            $keyboard = [
                'inline_keyboard' => [
                    [
                        ['text' => 'ğŸ¢ ØªÙ†Ø¸ÛŒÙ…Ø§Øª Ø¹Ù…ÙˆÙ…ÛŒ', 'callback_data' => 'settings_general'],
                        ['text' => 'ğŸ”§ Ø­Ø§Ù„Øª ØªØ¹Ù…ÛŒØ±Ø§Øª', 'callback_data' => 'settings_maintenance']
                    ],
                    [
                        ['text' => 'ğŸ“§ ØªÙ†Ø¸ÛŒÙ…Ø§Øª Ø§ÛŒÙ…ÛŒÙ„', 'callback_data' => 'settings_email'],
                        ['text' => 'ğŸŒ Ø´Ø¨Ú©Ù‡â€ŒÙ‡Ø§ÛŒ Ø§Ø¬ØªÙ…Ø§Ø¹ÛŒ', 'callback_data' => 'settings_social']
                    ],
                    [
                        ['text' => 'ğŸ” ØªÙ†Ø¸ÛŒÙ…Ø§Øª SEO', 'callback_data' => 'settings_seo'],
                        ['text' => 'ğŸ’¾ ØªÙ†Ø¸ÛŒÙ…Ø§Øª Ø¨Ú©Ø§Ù¾', 'callback_data' => 'settings_backup']
                    ],
                    [
                        ['text' => 'ğŸ“‹ Ù„Ø§Ú¯â€ŒÙ‡Ø§ÛŒ Ø³ÛŒØ³ØªÙ…', 'callback_data' => 'settings_logs'],
                        ['text' => 'ğŸš€ Ù…Ø¯ÛŒØ±ÛŒØª Ú©Ø´', 'callback_data' => 'settings_cache']
                    ],
                    [
                        ['text' => 'ğŸ“¤ Ø®Ø±ÙˆØ¬ÛŒ ØªÙ†Ø¸ÛŒÙ…Ø§Øª', 'callback_data' => 'settings_export'],
                        ['text' => 'ğŸ“¥ ÙˆØ±ÙˆØ¯ÛŒ ØªÙ†Ø¸ÛŒÙ…Ø§Øª', 'callback_data' => 'settings_import']
                    ],
                    [
                        ['text' => 'ğŸ”„ Ø¨Ø§Ø²Ù†Ø´Ø§Ù†ÛŒ', 'callback_data' => 'settings_reset_confirm'],
                        ['text' => 'ğŸ”™ Ø¨Ø§Ø²Ú¯Ø´Øª', 'callback_data' => 'admin_dashboard']
                    ]
                ]
            ];

            $this->sendMessage($chatId, $message, $keyboard, 'Markdown');

        } catch (\Exception $e) {
            $this->sendMessage($chatId, "âŒ Ø®Ø·Ø§ Ø¯Ø± Ù†Ù…Ø§ÛŒØ´ Ø¯Ø§Ø´Ø¨ÙˆØ±Ø¯ ØªÙ†Ø¸ÛŒÙ…Ø§Øª: " . $e->getMessage());
        }
    }

    private function manageGeneralSettings($chatId, array $args): void
    {
        try {
            if (empty($args)) {
                $this->showGeneralSettingsMenu($chatId);
                return;
            }

            $action = $args[0] ?? 'view';

            switch ($action) {
                case 'view':
                    $this->showGeneralSettings($chatId);
                    break;

                case 'update':
                    if (count($args) < 3) {
                        $this->sendMessage($chatId, "âŒ ÙØ±Ù…Øª: /settings general update <key> <value>");
                        return;
                    }
                    $this->updateGeneralSetting($chatId, $args[1], $args[2]);
                    break;

                case 'timezone':
                    $this->updateTimezone($chatId, $args[1] ?? null);
                    break;

                case 'locale':
                    $this->updateLocale($chatId, $args[1] ?? null);
                    break;

                case 'debug':
                    $this->toggleDebugMode($chatId);
                    break;

                default:
                    $this->showGeneralSettingsMenu($chatId);
                    break;
            }

        } catch (\Exception $e) {
            $this->sendMessage($chatId, "âŒ Ø®Ø·Ø§ Ø¯Ø± Ù…Ø¯ÛŒØ±ÛŒØª ØªÙ†Ø¸ÛŒÙ…Ø§Øª Ø¹Ù…ÙˆÙ…ÛŒ: " . $e->getMessage());
        }
    }

    private function showGeneralSettings($chatId): void
    {
        $settings = [
            'app_name' => config('app.name'),
            'app_url' => config('app.url'),
            'app_env' => config('app.env'),
            'app_debug' => config('app.debug'),
            'app_timezone' => config('app.timezone'),
            'app_locale' => config('app.locale'),
            'app_version' => config('app.version', '1.0.0')
        ];

        $message = "ğŸ¢ **ØªÙ†Ø¸ÛŒÙ…Ø§Øª Ø¹Ù…ÙˆÙ…ÛŒ Ø³ÛŒØ³ØªÙ…**\n\n";
        $message .= "ğŸ“ **Ù¾ÛŒÚ©Ø±Ø¨Ù†Ø¯ÛŒ ÙØ¹Ù„ÛŒ:**\n";
        $message .= "â€¢ Ù†Ø§Ù… Ø¨Ø±Ù†Ø§Ù…Ù‡: {$settings['app_name']}\n";
        $message .= "â€¢ Ø¢Ø¯Ø±Ø³: {$settings['app_url']}\n";
        $message .= "â€¢ Ù…Ø­ÛŒØ·: " . strtoupper($settings['app_env']) . "\n";
        $message .= "â€¢ Ø­Ø§Ù„Øª Ø¯ÛŒØ¨Ø§Ú¯: " . ($settings['app_debug'] ? 'âœ… ÙØ¹Ø§Ù„' : 'âŒ ØºÛŒØ±ÙØ¹Ø§Ù„') . "\n";
        $message .= "â€¢ Ù…Ù†Ø·Ù‚Ù‡ Ø²Ù…Ø§Ù†ÛŒ: {$settings['app_timezone']}\n";
        $message .= "â€¢ Ø²Ø¨Ø§Ù†: {$settings['app_locale']}\n";
        $message .= "â€¢ Ù†Ø³Ø®Ù‡: {$settings['app_version']}\n\n";

        $message .= "âš™ï¸ Ø¨Ø±Ø§ÛŒ ØªØºÛŒÛŒØ± ØªÙ†Ø¸ÛŒÙ…Ø§Øª Ø§Ø² Ø¯Ú©Ù…Ù‡â€ŒÙ‡Ø§ÛŒ Ø²ÛŒØ± Ø§Ø³ØªÙØ§Ø¯Ù‡ Ú©Ù†ÛŒØ¯:";

        $keyboard = [
            'inline_keyboard' => [
                [
                    ['text' => 'ğŸŒ ØªØºÛŒÛŒØ± Ù…Ù†Ø·Ù‚Ù‡ Ø²Ù…Ø§Ù†ÛŒ', 'callback_data' => 'settings_timezone'],
                    ['text' => 'ğŸ—£ï¸ ØªØºÛŒÛŒØ± Ø²Ø¨Ø§Ù†', 'callback_data' => 'settings_locale']
                ],
                [
                    ['text' => 'ğŸ› ØªØºÛŒÛŒØ± Ø­Ø§Ù„Øª Ø¯ÛŒØ¨Ø§Ú¯', 'callback_data' => 'settings_debug_toggle'],
                    ['text' => 'ğŸ”„ Ø±ÛŒØ³ØªØ§Ø±Øª Ø³ÛŒØ³ØªÙ…', 'callback_data' => 'settings_system_restart']
                ],
                [
                    ['text' => 'ğŸ’¾ Ø°Ø®ÛŒØ±Ù‡ ØªÙ†Ø¸ÛŒÙ…Ø§Øª', 'callback_data' => 'settings_save'],
                    ['text' => 'ğŸ”™ Ø¨Ø§Ø²Ú¯Ø´Øª', 'callback_data' => 'settings_dashboard']
                ]
            ]
        ];

        $this->sendMessage($chatId, $message, $keyboard, 'Markdown');
    }

    private function manageMaintenanceMode($chatId, array $args): void
    {
        try {
            $action = $args[0] ?? 'status';

            switch ($action) {
                case 'status':
                    $this->showMaintenanceStatus($chatId);
                    break;

                case 'enable':
                case 'on':
                    $this->enableMaintenanceMode($chatId, array_slice($args, 1));
                    break;

                case 'disable':
                case 'off':
                    $this->disableMaintenanceMode($chatId);
                    break;

                case 'message':
                    $message = implode(' ', array_slice($args, 1));
                    $this->updateMaintenanceMessage($chatId, $message);
                    break;

                default:
                    $this->showMaintenanceStatus($chatId);
                    break;
            }

        } catch (\Exception $e) {
            $this->sendMessage($chatId, "âŒ Ø®Ø·Ø§ Ø¯Ø± Ù…Ø¯ÛŒØ±ÛŒØª Ø­Ø§Ù„Øª ØªØ¹Ù…ÛŒØ±Ø§Øª: " . $e->getMessage());
        }
    }

    private function showMaintenanceStatus($chatId): void
    {
        $isDown = app()->isDownForMaintenance();
        $message = "ğŸ”§ **ÙˆØ¶Ø¹ÛŒØª Ø­Ø§Ù„Øª ØªØ¹Ù…ÛŒØ±Ø§Øª**\n\n";
        
        if ($isDown) {
            $message .= "ğŸ”´ Ø³Ø§ÛŒØª Ø¯Ø± Ø­Ø§Ù„Øª ØªØ¹Ù…ÛŒØ±Ø§Øª Ù‚Ø±Ø§Ø± Ø¯Ø§Ø±Ø¯\n\n";
            $message .= "ğŸ“… Ø²Ù…Ø§Ù† ÙØ¹Ø§Ù„â€ŒØ³Ø§Ø²ÛŒ: " . $this->getMaintenanceStartTime() . "\n";
            $message .= "ğŸ’¬ Ù¾ÛŒØ§Ù… ØªØ¹Ù…ÛŒØ±Ø§Øª: " . $this->getMaintenanceMessage() . "\n\n";
        } else {
            $message .= "ğŸŸ¢ Ø³Ø§ÛŒØª Ø¯Ø± ÙˆØ¶Ø¹ÛŒØª Ø¹Ø§Ø¯ÛŒ ÙØ¹Ø§Ù„ Ø§Ø³Øª\n\n";
        }

        $message .= "âš™ï¸ Ù…Ø¯ÛŒØ±ÛŒØª Ø­Ø§Ù„Øª ØªØ¹Ù…ÛŒØ±Ø§Øª:";

        $keyboard = [
            'inline_keyboard' => [
                [
                    ['text' => $isDown ? 'ğŸŸ¢ Ø®Ø±ÙˆØ¬ Ø§Ø² ØªØ¹Ù…ÛŒØ±Ø§Øª' : 'ğŸ”´ ÙØ¹Ø§Ù„â€ŒØ³Ø§Ø²ÛŒ ØªØ¹Ù…ÛŒØ±Ø§Øª', 
                     'callback_data' => $isDown ? 'maintenance_disable' : 'maintenance_enable']
                ],
                [
                    ['text' => 'ğŸ’¬ ØªØºÛŒÛŒØ± Ù¾ÛŒØ§Ù…', 'callback_data' => 'maintenance_message'],
                    ['text' => 'â° Ø²Ù…Ø§Ù†â€ŒØ¨Ù†Ø¯ÛŒ', 'callback_data' => 'maintenance_schedule']
                ],
                [
                    ['text' => 'ğŸ“Š Ú¯Ø²Ø§Ø±Ø´ Ø¯Ø³ØªØ±Ø³ÛŒ', 'callback_data' => 'maintenance_report'],
                    ['text' => 'ğŸ”™ Ø¨Ø§Ø²Ú¯Ø´Øª', 'callback_data' => 'settings_dashboard']
                ]
            ]
        ];

        $this->sendMessage($chatId, $message, $keyboard, 'Markdown');
    }

    private function checkRedisConnection(): bool
    {
        try {
            $redis = app('redis');
            $redis->ping();
            return true;
        } catch (\Exception $e) {
            return false;
        }
    }

    private function checkDatabaseConnection(): bool
    {
        try {
            DB::connection()->getPdo();
            return true;
        } catch (\Exception $e) {
            return false;
        }
    }

    private function getDiskUsage(): float
    {
        try {
            $total = disk_total_space('/');
            $free = disk_free_space('/');
            $used = $total - $free;
            return round(($used / $total) * 100, 1);
        } catch (\Exception $e) {
            return 0;
        }
    }

    private function getMemoryUsage(): float
    {
        try {
            $memoryLimit = $this->returnBytes(ini_get('memory_limit'));
            $memoryUsed = memory_get_usage(true);
            return round(($memoryUsed / $memoryLimit) * 100, 1);
        } catch (\Exception $e) {
            return 0;
        }
    }

    private function returnBytes($val): int
    {
        $val = trim($val);
        $last = strtolower($val[strlen($val)-1]);
        $val = (int) $val;
        
        switch($last) {
            case 'g':
                $val *= 1024;
                // no break
            case 'm':
                $val *= 1024;
                // no break
            case 'k':
                $val *= 1024;
        }
        
        return $val;
    }

    private function getMaintenanceStartTime(): string
    {
        // This would typically come from a maintenance status file
        return date('Y-m-d H:i:s');
    }

    private function getMaintenanceMessage(): string
    {
        return 'Ø³Ø§ÛŒØª Ø¨Ù‡ Ø¯Ù„ÛŒÙ„ Ø¨Ø±ÙˆØ²Ø±Ø³Ø§Ù†ÛŒ Ù…ÙˆÙ‚ØªØ§ Ø¯Ø± Ø¯Ø³ØªØ±Ø³ Ù†ÛŒØ³Øª. Ù„Ø·ÙØ§ Ú†Ù†Ø¯ Ø¯Ù‚ÛŒÙ‚Ù‡ Ø¯ÛŒÚ¯Ø± Ù…Ø±Ø§Ø¬Ø¹Ù‡ Ú©Ù†ÛŒØ¯.';
    }

    private function showSettingsHelp($chatId): void
    {
        $message = "âš™ï¸ **Ø±Ø§Ù‡Ù†Ù…Ø§ÛŒ Ù…Ø¯ÛŒØ±ÛŒØª ØªÙ†Ø¸ÛŒÙ…Ø§Øª**\n\n";
        
        $message .= "ğŸ¢ **ØªÙ†Ø¸ÛŒÙ…Ø§Øª Ø¹Ù…ÙˆÙ…ÛŒ:**\n";
        $message .= "â€¢ /settings general - ØªÙ†Ø¸ÛŒÙ…Ø§Øª Ú©Ù„ÛŒ\n";
        $message .= "â€¢ /settings maintenance - Ø­Ø§Ù„Øª ØªØ¹Ù…ÛŒØ±Ø§Øª\n\n";
        
        $message .= "ğŸ“§ **ØªÙ†Ø¸ÛŒÙ…Ø§Øª Ø§Ø±ØªØ¨Ø§Ø·:**\n";
        $message .= "â€¢ /settings email - ØªÙ†Ø¸ÛŒÙ…Ø§Øª Ø§ÛŒÙ…ÛŒÙ„\n";
        $message .= "â€¢ /settings social - Ø´Ø¨Ú©Ù‡â€ŒÙ‡Ø§ÛŒ Ø§Ø¬ØªÙ…Ø§Ø¹ÛŒ\n\n";
        
        $message .= "ğŸ” **Ø¨Ù‡ÛŒÙ†Ù‡â€ŒØ³Ø§Ø²ÛŒ:**\n";
        $message .= "â€¢ /settings seo - ØªÙ†Ø¸ÛŒÙ…Ø§Øª SEO\n";
        $message .= "â€¢ /settings cache - Ù…Ø¯ÛŒØ±ÛŒØª Ú©Ø´\n\n";
        
        $message .= "ğŸ› ï¸ **Ù…Ø¯ÛŒØ±ÛŒØª Ø³ÛŒØ³ØªÙ…:**\n";
        $message .= "â€¢ /settings backup - ØªÙ†Ø¸ÛŒÙ…Ø§Øª Ø¨Ú©Ø§Ù¾\n";
        $message .= "â€¢ /settings logs - Ù„Ø§Ú¯â€ŒÙ‡Ø§ÛŒ Ø³ÛŒØ³ØªÙ…\n";
        $message .= "â€¢ /settings export - Ø®Ø±ÙˆØ¬ÛŒ ØªÙ†Ø¸ÛŒÙ…Ø§Øª\n";
        $message .= "â€¢ /settings import - ÙˆØ§Ø±Ø¯ Ú©Ø±Ø¯Ù† ØªÙ†Ø¸ÛŒÙ…Ø§Øª\n\n";
        
        $message .= "â„¹ï¸ Ø¨Ø±Ø§ÛŒ Ø¯Ø±ÛŒØ§ÙØª Ø¯Ø§Ø´Ø¨ÙˆØ±Ø¯ Ú©Ø§Ù…Ù„ Ø§Ø² /settings Ø§Ø³ØªÙØ§Ø¯Ù‡ Ú©Ù†ÛŒØ¯";

        $this->sendMessage($chatId, $message, null, 'Markdown');
    }

    /**
     * Handle audit and reporting system
     */
    private function handleAuditReporting(\App\Services\Telegram\Core\UpdateContext $context): void
    {
        $chatId = $context->getChatId();
        $text = $context->getMessage()->getText();
        $args = array_slice(explode(' ', $text), 1); // Remove /reports or /audit command
        $subcommand = $args[0] ?? 'dashboard';

        Log::info('Audit reporting management', ['subcommand' => $subcommand, 'args' => $args]);

        try {
            switch ($subcommand) {
                case 'dashboard':
                case 'menu':
                    $this->showAuditDashboard($chatId);
                    break;

                case 'system':
                    $this->generateSystemReport($chatId, array_slice($args, 1));
                    break;

                case 'users':
                    $this->generateUserReport($chatId, array_slice($args, 1));
                    break;

                case 'security':
                    $this->generateSecurityReport($chatId, array_slice($args, 1));
                    break;

                case 'financial':
                    $this->generateFinancialReport($chatId, array_slice($args, 1));
                    break;

                case 'activity':
                    $this->generateActivityReport($chatId, array_slice($args, 1));
                    break;

                case 'performance':
                    $this->generatePerformanceReport($chatId, array_slice($args, 1));
                    break;

                case 'compliance':
                    $this->generateComplianceReport($chatId, array_slice($args, 1));
                    break;

                case 'custom':
                    $this->generateCustomReport($chatId, array_slice($args, 1));
                    break;

                case 'export':
                    $this->exportReport($chatId, array_slice($args, 1));
                    break;

                case 'schedule':
                    $this->scheduleReport($chatId, array_slice($args, 1));
                    break;

                default:
                    $this->showAuditHelp($chatId);
                    break;
            }

        } catch (\Exception $e) {
            Log::error('Audit reporting error: ' . $e->getMessage());
            $this->sendMessage($chatId, "âŒ Ø®Ø·Ø§ Ø¯Ø± ØªÙˆÙ„ÛŒØ¯ Ú¯Ø²Ø§Ø±Ø´: " . $e->getMessage());
        }
    }

    private function showAuditDashboard($chatId): void
    {
        try {
            // Get comprehensive system statistics
            $systemStats = $this->getSystemStatistics();
            $auditStats = $this->getAuditStatistics();

            $message = "ğŸ“Š **Ù…Ø±Ú©Ø² Ú¯Ø²Ø§Ø±Ø´â€ŒÚ¯ÛŒØ±ÛŒ Ùˆ Ø­Ø³Ø§Ø¨Ø±Ø³ÛŒ**\n\n";
            
            $message .= "ğŸ¢ **Ø¢Ù…Ø§Ø± Ú©Ù„ÛŒ Ø³ÛŒØ³ØªÙ…:**\n";
            $message .= "â€¢ Ú©Ù„ Ú©Ø§Ø±Ø¨Ø±Ø§Ù†: " . number_format($systemStats['total_users']) . "\n";
            $message .= "â€¢ Ú©Ø§Ø±Ø¨Ø±Ø§Ù† ÙØ¹Ø§Ù„ Ø§Ù…Ø±ÙˆØ²: " . number_format($systemStats['active_today']) . "\n";
            $message .= "â€¢ ØªØ±Ø§Ú©Ù†Ø´â€ŒÙ‡Ø§ÛŒ Ø§Ù…Ø±ÙˆØ²: " . number_format($systemStats['transactions_today']) . "\n";
            $message .= "â€¢ Ø¯Ø±Ø¢Ù…Ø¯ Ø§Ù…Ø±ÙˆØ²: " . number_format($systemStats['revenue_today']) . " ØªÙˆÙ…Ø§Ù†\n\n";

            $message .= "ğŸ” **Ø¢Ù…Ø§Ø± Ø­Ø³Ø§Ø¨Ø±Ø³ÛŒ:**\n";
            $message .= "â€¢ Ø±ÙˆÛŒØ¯Ø§Ø¯Ù‡Ø§ÛŒ Ø«Ø¨Øª Ø´Ø¯Ù‡: " . number_format($auditStats['total_events']) . "\n";
            $message .= "â€¢ Ø±ÙˆÛŒØ¯Ø§Ø¯Ù‡Ø§ÛŒ Ø§Ù…Ø±ÙˆØ²: " . number_format($auditStats['events_today']) . "\n";
            $message .= "â€¢ Ù‡Ø´Ø¯Ø§Ø±Ù‡Ø§ÛŒ Ø§Ù…Ù†ÛŒØªÛŒ: " . number_format($auditStats['security_alerts']) . "\n";
            $message .= "â€¢ ØªØ±Ø§Ú©Ù†Ø´â€ŒÙ‡Ø§ÛŒ Ù…Ø´Ú©ÙˆÚ©: " . number_format($auditStats['suspicious_transactions']) . "\n\n";

            $message .= "ğŸ“ˆ **ÙˆØ¶Ø¹ÛŒØª Ø¹Ù…Ù„Ú©Ø±Ø¯:**\n";
            $message .= "â€¢ Ø²Ù…Ø§Ù† Ù¾Ø§Ø³Ø® Ù…ÛŒØ§Ù†Ú¯ÛŒÙ†: {$systemStats['avg_response_time']}ms\n";
            $message .= "â€¢ Ù…ÛŒØ²Ø§Ù† Ø®Ø·Ø§: {$systemStats['error_rate']}%\n";
            $message .= "â€¢ Ø¢Ù¾â€ŒØªØ§ÛŒÙ… Ø³ÛŒØ³ØªÙ…: {$systemStats['uptime']}%\n";
            $message .= "â€¢ Ø§Ø³ØªÙØ§Ø¯Ù‡ Ø§Ø² Ù…Ù†Ø§Ø¨Ø¹: CPU {$systemStats['cpu_usage']}% | RAM {$systemStats['memory_usage']}%\n\n";

            $message .= "ğŸ¯ Ø§Ù†ÙˆØ§Ø¹ Ú¯Ø²Ø§Ø±Ø´â€ŒÙ‡Ø§ Ø±Ø§ Ø§Ø² Ù…Ù†ÙˆÛŒ Ø²ÛŒØ± Ø§Ù†ØªØ®Ø§Ø¨ Ú©Ù†ÛŒØ¯:";

            $keyboard = [
                'inline_keyboard' => [
                    [
                        ['text' => 'ğŸ–¥ï¸ Ú¯Ø²Ø§Ø±Ø´ Ø³ÛŒØ³ØªÙ…', 'callback_data' => 'report_system'],
                        ['text' => 'ğŸ‘¥ Ú¯Ø²Ø§Ø±Ø´ Ú©Ø§Ø±Ø¨Ø±Ø§Ù†', 'callback_data' => 'report_users']
                    ],
                    [
                        ['text' => 'ğŸ”’ Ú¯Ø²Ø§Ø±Ø´ Ø§Ù…Ù†ÛŒØªÛŒ', 'callback_data' => 'report_security'],
                        ['text' => 'ğŸ’° Ú¯Ø²Ø§Ø±Ø´ Ù…Ø§Ù„ÛŒ', 'callback_data' => 'report_financial']
                    ],
                    [
                        ['text' => 'ğŸ“ˆ Ú¯Ø²Ø§Ø±Ø´ ÙØ¹Ø§Ù„ÛŒØª', 'callback_data' => 'report_activity'],
                        ['text' => 'âš¡ Ú¯Ø²Ø§Ø±Ø´ Ø¹Ù…Ù„Ú©Ø±Ø¯', 'callback_data' => 'report_performance']
                    ],
                    [
                        ['text' => 'âœ… Ú¯Ø²Ø§Ø±Ø´ ØªØ·Ø§Ø¨Ù‚', 'callback_data' => 'report_compliance'],
                        ['text' => 'ğŸ”§ Ú¯Ø²Ø§Ø±Ø´ Ø³ÙØ§Ø±Ø´ÛŒ', 'callback_data' => 'report_custom']
                    ],
                    [
                        ['text' => 'ğŸ“¤ Ø®Ø±ÙˆØ¬ÛŒ Ú¯Ø²Ø§Ø±Ø´', 'callback_data' => 'report_export'],
                        ['text' => 'ğŸ“… Ø²Ù…Ø§Ù†â€ŒØ¨Ù†Ø¯ÛŒ Ú¯Ø²Ø§Ø±Ø´', 'callback_data' => 'report_schedule']
                    ],
                    [
                        ['text' => 'ğŸ”™ Ø¨Ø§Ø²Ú¯Ø´Øª', 'callback_data' => 'admin_dashboard']
                    ]
                ]
            ];

            $this->sendMessage($chatId, $message, $keyboard, 'Markdown');

        } catch (\Exception $e) {
            $this->sendMessage($chatId, "âŒ Ø®Ø·Ø§ Ø¯Ø± Ù†Ù…Ø§ÛŒØ´ Ø¯Ø§Ø´Ø¨ÙˆØ±Ø¯ Ø­Ø³Ø§Ø¨Ø±Ø³ÛŒ: " . $e->getMessage());
        }
    }

    private function generateSystemReport($chatId, array $args): void
    {
        try {
            $period = $args[0] ?? 'today';
            $detailed = in_array('detailed', $args);

            $dateRange = $this->getDateRange($period);
            $systemData = $this->getSystemReportData($dateRange, $detailed);

            $message = "ğŸ–¥ï¸ **Ú¯Ø²Ø§Ø±Ø´ Ø¬Ø§Ù…Ø¹ Ø³ÛŒØ³ØªÙ…**\n\n";
            $message .= "ğŸ“… Ø¨Ø§Ø²Ù‡ Ø²Ù…Ø§Ù†ÛŒ: " . $this->formatPeriod($period) . "\n";
            $message .= "ğŸ• ØªÙˆÙ„ÛŒØ¯ Ø´Ø¯Ù‡: " . now()->format('Y-m-d H:i:s') . "\n\n";

            $message .= "ğŸ—ï¸ **ÙˆØ¶Ø¹ÛŒØª Ø²ÛŒØ±Ø³Ø§Ø®Øª:**\n";
            $message .= "â€¢ ÙˆØ¶Ø¹ÛŒØª Ø³Ø±ÙˆØ±: " . ($systemData['server_status'] ? 'ğŸŸ¢ ÙØ¹Ø§Ù„' : 'ğŸ”´ Ø®Ø§Ù…ÙˆØ´') . "\n";
            $message .= "â€¢ Ù¾Ø§ÛŒÚ¯Ø§Ù‡ Ø¯Ø§Ø¯Ù‡: " . ($systemData['database_status'] ? 'ğŸŸ¢ Ù…ØªØµÙ„' : 'ğŸ”´ Ù‚Ø·Ø¹') . "\n";
            $message .= "â€¢ Redis Cache: " . ($systemData['redis_status'] ? 'ğŸŸ¢ ÙØ¹Ø§Ù„' : 'ğŸ”´ Ù‚Ø·Ø¹') . "\n";
            $message .= "â€¢ Queue Workers: {$systemData['active_workers']} ÙØ¹Ø§Ù„\n\n";

            $message .= "ğŸ“Š **Ø¢Ù…Ø§Ø± Ø§Ø³ØªÙØ§Ø¯Ù‡:**\n";
            $message .= "â€¢ Ú©Ù„ Ø¯Ø±Ø®ÙˆØ§Ø³Øªâ€ŒÙ‡Ø§: " . number_format($systemData['total_requests']) . "\n";
            $message .= "â€¢ Ø¯Ø±Ø®ÙˆØ§Ø³Øªâ€ŒÙ‡Ø§ÛŒ Ù…ÙˆÙÙ‚: " . number_format($systemData['successful_requests']) . "\n";
            $message .= "â€¢ Ø¯Ø±Ø®ÙˆØ§Ø³Øªâ€ŒÙ‡Ø§ÛŒ Ù†Ø§Ù…ÙˆÙÙ‚: " . number_format($systemData['failed_requests']) . "\n";
            $message .= "â€¢ Ø²Ù…Ø§Ù† Ù¾Ø§Ø³Ø® Ù…ÛŒØ§Ù†Ú¯ÛŒÙ†: {$systemData['avg_response_time']}ms\n";
            $message .= "â€¢ Ø¨ÛŒØ´ØªØ±ÛŒÙ† Ø²Ù…Ø§Ù† Ù¾Ø§Ø³Ø®: {$systemData['max_response_time']}ms\n\n";

            $message .= "ğŸ—„ï¸ **Ù…Ù†Ø§Ø¨Ø¹ Ø³ÛŒØ³ØªÙ…:**\n";
            $message .= "â€¢ Ø§Ø³ØªÙØ§Ø¯Ù‡ Ø§Ø² CPU: {$systemData['cpu_usage']}%\n";
            $message .= "â€¢ Ø§Ø³ØªÙØ§Ø¯Ù‡ Ø§Ø² RAM: {$systemData['memory_usage']}%\n";
            $message .= "â€¢ ÙØ¶Ø§ÛŒ Ø¯ÛŒØ³Ú©: {$systemData['disk_usage']}%\n";
            $message .= "â€¢ ØªØ±Ø§ÙÛŒÚ© Ø´Ø¨Ú©Ù‡: " . $this->formatBytes($systemData['network_usage']) . "\n\n";

            if ($detailed) {
                $message .= "ğŸ” **Ø¬Ø²Ø¦ÛŒØ§Øª ØªÚ©Ù…ÛŒÙ„ÛŒ:**\n";
                $message .= "â€¢ ØªØ¹Ø¯Ø§Ø¯ Ø¬Ù„Ø³Ø§Øª ÙØ¹Ø§Ù„: " . number_format($systemData['active_sessions']) . "\n";
                $message .= "â€¢ Ú©Ø§Ø±Ø¨Ø±Ø§Ù† Ø¢Ù†Ù„Ø§ÛŒÙ†: " . number_format($systemData['online_users']) . "\n";
                $message .= "â€¢ ØªØ¹Ø¯Ø§Ø¯ Ú©Ø´ Ù‡ÛŒØª: " . number_format($systemData['cache_hits']) . "\n";
                $message .= "â€¢ ØªØ¹Ø¯Ø§Ø¯ Ú©Ø´ Ù…ÛŒØ³: " . number_format($systemData['cache_misses']) . "\n";
                $message .= "â€¢ Ù†Ø±Ø® Ú©Ø´ Ù‡ÛŒØª: {$systemData['cache_hit_ratio']}%\n\n";
            }

            $message .= "âš ï¸ **Ù‡Ø´Ø¯Ø§Ø±Ù‡Ø§ Ùˆ ØªÙˆØµÛŒÙ‡â€ŒÙ‡Ø§:**\n";
            foreach ($systemData['recommendations'] as $recommendation) {
                $message .= "â€¢ {$recommendation}\n";
            }

            $keyboard = [
                'inline_keyboard' => [
                    [
                        ['text' => 'ğŸ“Š Ú¯Ø²Ø§Ø±Ø´ ØªÙØµÛŒÙ„ÛŒ', 'callback_data' => "report_system_detailed_{$period}"],
                        ['text' => 'ğŸ“… ØªØºÛŒÛŒØ± Ø¯ÙˆØ±Ù‡', 'callback_data' => 'report_system_period']
                    ],
                    [
                        ['text' => 'ğŸ“¤ Ø®Ø±ÙˆØ¬ÛŒ PDF', 'callback_data' => "export_system_{$period}"],
                        ['text' => 'ğŸ”„ Ø¨Ø±ÙˆØ²Ø±Ø³Ø§Ù†ÛŒ', 'callback_data' => "report_system_{$period}"]
                    ],
                    [
                        ['text' => 'ğŸ”™ Ø¨Ø§Ø²Ú¯Ø´Øª', 'callback_data' => 'audit_dashboard']
                    ]
                ]
            ];

            $this->sendMessage($chatId, $message, $keyboard, 'Markdown');

        } catch (\Exception $e) {
            $this->sendMessage($chatId, "âŒ Ø®Ø·Ø§ Ø¯Ø± ØªÙˆÙ„ÛŒØ¯ Ú¯Ø²Ø§Ø±Ø´ Ø³ÛŒØ³ØªÙ…: " . $e->getMessage());
        }
    }

    private function generateSecurityReport($chatId, array $args): void
    {
        try {
            $period = $args[0] ?? 'today';
            $severity = $args[1] ?? 'all'; // all, critical, high, medium, low

            $dateRange = $this->getDateRange($period);
            $securityData = $this->getSecurityReportData($dateRange, $severity);

            $message = "ğŸ”’ **Ú¯Ø²Ø§Ø±Ø´ Ø§Ù…Ù†ÛŒØªÛŒ Ø¬Ø§Ù…Ø¹**\n\n";
            $message .= "ğŸ“… Ø¨Ø§Ø²Ù‡ Ø²Ù…Ø§Ù†ÛŒ: " . $this->formatPeriod($period) . "\n";
            $message .= "ğŸ” Ø³Ø·Ø­ Ù‡Ø´Ø¯Ø§Ø±: " . ucfirst($severity) . "\n";
            $message .= "ğŸ• ØªÙˆÙ„ÛŒØ¯ Ø´Ø¯Ù‡: " . now()->format('Y-m-d H:i:s') . "\n\n";

            // Security score calculation
            $securityScore = $this->calculateOverallSecurityScore($securityData);
            $scoreEmoji = $securityScore >= 90 ? 'ğŸŸ¢' : ($securityScore >= 70 ? 'ğŸŸ¡' : 'ğŸ”´');
            
            $message .= "ğŸ›¡ï¸ **Ø§Ù…ØªÛŒØ§Ø² Ø§Ù…Ù†ÛŒØªÛŒ Ú©Ù„ÛŒ: {$scoreEmoji} {$securityScore}/100**\n\n";

            $message .= "ğŸš¨ **Ø®Ù„Ø§ØµÙ‡ ØªÙ‡Ø¯ÛŒØ¯Ø§Øª:**\n";
            $message .= "â€¢ Ø­Ù…Ù„Ø§Øª Ø§Ù†Ú©Ø§Ø± Ø³Ø±ÙˆÛŒØ³: " . number_format($securityData['ddos_attempts']) . "\n";
            $message .= "â€¢ ØªÙ„Ø§Ø´â€ŒÙ‡Ø§ÛŒ ÙˆØ±ÙˆØ¯ Ù†Ø§Ù…ÙˆÙÙ‚: " . number_format($securityData['failed_logins']) . "\n";
            $message .= "â€¢ IP Ù‡Ø§ÛŒ Ù…Ø³Ø¯ÙˆØ¯ Ø´Ø¯Ù‡: " . number_format($securityData['blocked_ips']) . "\n";
            $message .= "â€¢ Ø¯Ø±Ø®ÙˆØ§Ø³Øªâ€ŒÙ‡Ø§ÛŒ Ù…Ø´Ú©ÙˆÚ©: " . number_format($securityData['suspicious_requests']) . "\n\n";

            $message .= "ğŸ” **ÙˆØ¶Ø¹ÛŒØª Ø§Ø­Ø±Ø§Ø² Ù‡ÙˆÛŒØª:**\n";
            $message .= "â€¢ ÙˆØ±ÙˆØ¯Ù‡Ø§ÛŒ Ù…ÙˆÙÙ‚: " . number_format($securityData['successful_logins']) . "\n";
            $message .= "â€¢ Ø§Ø³ØªÙØ§Ø¯Ù‡ Ø§Ø² 2FA: {$securityData['2fa_usage']}%\n";
            $message .= "â€¢ Ø¬Ù„Ø³Ø§Øª ÙØ¹Ø§Ù„: " . number_format($securityData['active_sessions']) . "\n";
            $message .= "â€¢ ØªØ§Ø±ÛŒØ® Ø§Ù†Ù‚Ø¶Ø§ÛŒ ØªÙˆÚ©Ù†â€ŒÙ‡Ø§: {$securityData['expiring_tokens']} Ù…ÙˆØ±Ø¯\n\n";

            $message .= "ğŸ“Š **ØªØ¬Ø²ÛŒÙ‡ ØªÙ‡Ø¯ÛŒØ¯Ø§Øª:**\n";
            foreach ($securityData['threat_analysis'] as $threat => $count) {
                $emoji = $this->getThreatEmoji($threat);
                $message .= "â€¢ {$emoji} {$threat}: " . number_format($count) . " Ù…ÙˆØ±Ø¯\n";
            }

            $message .= "\nğŸŒ **ØªØ¬Ø²ÛŒÙ‡ Ø¬ØºØ±Ø§ÙÛŒØ§ÛŒÛŒ:**\n";
            foreach ($securityData['geographic_threats'] as $country => $count) {
                $flag = $this->getCountryFlag($country);
                $message .= "â€¢ {$flag} {$country}: " . number_format($count) . " ØªÙ‡Ø¯ÛŒØ¯\n";
            }

            $message .= "\nâš ï¸ **ØªÙˆØµÛŒÙ‡â€ŒÙ‡Ø§ÛŒ Ø§Ù…Ù†ÛŒØªÛŒ:**\n";
            foreach ($securityData['security_recommendations'] as $recommendation) {
                $message .= "â€¢ {$recommendation}\n";
            }

            $keyboard = [
                'inline_keyboard' => [
                    [
                        ['text' => 'ğŸ”´ ÙÙ‚Ø· Ø¨Ø­Ø±Ø§Ù†ÛŒ', 'callback_data' => "report_security_{$period}_critical"],
                        ['text' => 'ğŸŸ  Ø¨Ø­Ø±Ø§Ù†ÛŒ + Ù…Ù‡Ù…', 'callback_data' => "report_security_{$period}_high"]
                    ],
                    [
                        ['text' => 'ğŸ“‹ Ø¬Ø²Ø¦ÛŒØ§Øª Ú©Ø§Ù…Ù„', 'callback_data' => "report_security_detailed_{$period}"],
                        ['text' => 'ğŸ›¡ï¸ Ø¢Ù†Ø§Ù„ÛŒØ² Ø±ÛŒØ³Ú©', 'callback_data' => "security_risk_analysis_{$period}"]
                    ],
                    [
                        ['text' => 'ğŸ“¤ Ø®Ø±ÙˆØ¬ÛŒ PDF', 'callback_data' => "export_security_{$period}"],
                        ['text' => 'ğŸ“§ Ø§Ø±Ø³Ø§Ù„ Ø§ÛŒÙ…ÛŒÙ„', 'callback_data' => "email_security_{$period}"]
                    ],
                    [
                        ['text' => 'ğŸ”™ Ø¨Ø§Ø²Ú¯Ø´Øª', 'callback_data' => 'audit_dashboard']
                    ]
                ]
            ];

            $this->sendMessage($chatId, $message, $keyboard, 'Markdown');

        } catch (\Exception $e) {
            $this->sendMessage($chatId, "âŒ Ø®Ø·Ø§ Ø¯Ø± ØªÙˆÙ„ÛŒØ¯ Ú¯Ø²Ø§Ø±Ø´ Ø§Ù…Ù†ÛŒØªÛŒ: " . $e->getMessage());
        }
    }

    private function generateComplianceReport($chatId, array $args): void
    {
        try {
            $framework = $args[0] ?? 'all'; // all, gdpr, pci, iso27001
            $period = $args[1] ?? 'month';

            $dateRange = $this->getDateRange($period);
            $complianceData = $this->getComplianceData($dateRange, $framework);

            $message = "âœ… **Ú¯Ø²Ø§Ø±Ø´ ØªØ·Ø§Ø¨Ù‚ Ùˆ Ø§Ù†Ø·Ø¨Ø§Ù‚**\n\n";
            $message .= "ğŸ“‹ Ú†Ø§Ø±Ú†ÙˆØ¨: " . strtoupper($framework) . "\n";
            $message .= "ğŸ“… Ø¨Ø§Ø²Ù‡ Ø²Ù…Ø§Ù†ÛŒ: " . $this->formatPeriod($period) . "\n";
            $message .= "ğŸ• ØªÙˆÙ„ÛŒØ¯ Ø´Ø¯Ù‡: " . now()->format('Y-m-d H:i:s') . "\n\n";

            // Overall compliance score
            $complianceScore = $complianceData['overall_score'];
            $scoreEmoji = $complianceScore >= 95 ? 'ğŸŸ¢' : ($complianceScore >= 80 ? 'ğŸŸ¡' : 'ğŸ”´');
            
            $message .= "ğŸ“Š **Ø§Ù…ØªÛŒØ§Ø² ØªØ·Ø§Ø¨Ù‚ Ú©Ù„ÛŒ: {$scoreEmoji} {$complianceScore}%**\n\n";

            $message .= "ğŸ›¡ï¸ **Ø­ÙØ§Ø¸Øª Ø§Ø² Ø¯Ø§Ø¯Ù‡â€ŒÙ‡Ø§ÛŒ Ø´Ø®ØµÛŒ:**\n";
            $message .= "â€¢ Ø¯Ø§Ø¯Ù‡â€ŒÙ‡Ø§ÛŒ Ø±Ù…Ø²Ù†Ú¯Ø§Ø±ÛŒ Ø´Ø¯Ù‡: {$complianceData['encrypted_data']}%\n";
            $message .= "â€¢ Ø³ÛŒØ§Ø³Øª Ù†Ú¯Ù‡Ø¯Ø§Ø±ÛŒ Ø¯Ø§Ø¯Ù‡: " . ($complianceData['retention_policy'] ? 'âœ…' : 'âŒ') . "\n";
            $message .= "â€¢ Ø­Ù‚ ÙØ±Ø§Ù…ÙˆØ´ÛŒ: {$complianceData['deletion_requests']} Ø¯Ø±Ø®ÙˆØ§Ø³Øª\n";
            $message .= "â€¢ Ù†Ù‚Ø¶ Ø¯Ø§Ø¯Ù‡â€ŒØ§ÛŒ: {$complianceData['data_breaches']} Ù…ÙˆØ±Ø¯\n\n";

            $message .= "ğŸ” **Ú©Ù†ØªØ±Ù„ Ø¯Ø³ØªØ±Ø³ÛŒ:**\n";
            $message .= "â€¢ Ø§Ø­Ø±Ø§Ø² Ù‡ÙˆÛŒØª Ú†Ù†Ø¯Ø¹Ø§Ù…Ù„ÛŒ: " . ($complianceData['mfa_enabled'] ? 'âœ…' : 'âŒ') . "\n";
            $message .= "â€¢ Ù†Ø¸Ø§Ø±Øª Ø¨Ø± Ø¯Ø³ØªØ±Ø³ÛŒ: " . ($complianceData['access_monitoring'] ? 'âœ…' : 'âŒ') . "\n";
            $message .= "â€¢ Ø­Ø¯ Ø§Ù‚Ù„ Ø³Ø·Ø­ Ø¯Ø³ØªØ±Ø³ÛŒ: " . ($complianceData['least_privilege'] ? 'âœ…' : 'âŒ') . "\n\n";

            $message .= "ğŸ“‹ **Ø­Ø³Ø§Ø¨Ø±Ø³ÛŒ Ùˆ Ú¯Ø²Ø§Ø±Ø´â€ŒÚ¯ÛŒØ±ÛŒ:**\n";
            $message .= "â€¢ Ù„Ø§Ú¯â€ŒÙ‡Ø§ÛŒ Ú©Ø§Ù…Ù„: " . ($complianceData['comprehensive_logging'] ? 'âœ…' : 'âŒ') . "\n";
            $message .= "â€¢ Ø¨Ø§Ø²Ù†Ú¯Ø±ÛŒ Ù…Ù†Ø¸Ù…: " . ($complianceData['regular_audits'] ? 'âœ…' : 'âŒ') . "\n";
            $message .= "â€¢ Ú¯Ø²Ø§Ø±Ø´ Ø§ØªÙˆÙ…Ø§ØªÛŒÚ©: " . ($complianceData['automated_reporting'] ? 'âœ…' : 'âŒ') . "\n\n";

            $message .= "âš ï¸ **Ù…ÙˆØ§Ø±Ø¯ Ø¹Ø¯Ù… ØªØ·Ø§Ø¨Ù‚:**\n";
            if (empty($complianceData['non_compliance_issues'])) {
                $message .= "â€¢ ğŸ‰ Ù…ÙˆØ±Ø¯ Ø¹Ø¯Ù… ØªØ·Ø§Ø¨Ù‚ÛŒ ÛŒØ§ÙØª Ù†Ø´Ø¯!\n";
            } else {
                foreach ($complianceData['non_compliance_issues'] as $issue) {
                    $priority = $this->getIssuePriority($issue['severity']);
                    $message .= "â€¢ {$priority} {$issue['description']}\n";
                }
            }

            $message .= "\nğŸ“ˆ **Ù¾ÛŒØ´Ø±ÙØª Ù…Ø§Ù‡Ø§Ù†Ù‡:**\n";
            foreach ($complianceData['monthly_progress'] as $month => $score) {
                $trend = $score > ($complianceData['monthly_progress'][$month - 1] ?? 0) ? 'ğŸ“ˆ' : 'ğŸ“‰';
                $message .= "â€¢ {$month}: {$score}% {$trend}\n";
            }

            $keyboard = [
                'inline_keyboard' => [
                    [
                        ['text' => 'ğŸ›¡ï¸ GDPR', 'callback_data' => "compliance_gdpr_{$period}"],
                        ['text' => 'ğŸ’³ PCI DSS', 'callback_data' => "compliance_pci_{$period}"]
                    ],
                    [
                        ['text' => 'ğŸ”’ ISO 27001', 'callback_data' => "compliance_iso27001_{$period}"],
                        ['text' => 'ğŸ“Š Ù‡Ù…Ù‡ Ú†Ø§Ø±Ú†ÙˆØ¨â€ŒÙ‡Ø§', 'callback_data' => "compliance_all_{$period}"]
                    ],
                    [
                        ['text' => 'ğŸ”§ Ø§Ù‚Ø¯Ø§Ù…Ø§Øª Ø§ØµÙ„Ø§Ø­ÛŒ', 'callback_data' => "compliance_actions_{$framework}"],
                        ['text' => 'ğŸ“‹ Ú†Ú©â€ŒÙ„ÛŒØ³Øª', 'callback_data' => "compliance_checklist_{$framework}"]
                    ],
                    [
                        ['text' => 'ğŸ“¤ Ú¯Ø²Ø§Ø±Ø´ Ø±Ø³Ù…ÛŒ', 'callback_data' => "export_compliance_{$framework}"],
                        ['text' => 'ğŸ”™ Ø¨Ø§Ø²Ú¯Ø´Øª', 'callback_data' => 'audit_dashboard']
                    ]
                ]
            ];

            $this->sendMessage($chatId, $message, $keyboard, 'Markdown');

        } catch (\Exception $e) {
            $this->sendMessage($chatId, "âŒ Ø®Ø·Ø§ Ø¯Ø± ØªÙˆÙ„ÛŒØ¯ Ú¯Ø²Ø§Ø±Ø´ ØªØ·Ø§Ø¨Ù‚: " . $e->getMessage());
        }
    }

    // Helper methods for reporting system
    private function getSystemStatistics(): array
    {
        return [
            'total_users' => DB::table('users')->count(),
            'active_today' => DB::table('users')->where('last_login_at', '>=', today())->count(),
            'transactions_today' => DB::table('transactions')->whereDate('created_at', today())->count(),
            'revenue_today' => DB::table('transactions')
                ->whereDate('created_at', today())
                ->where('status', 'completed')
                ->sum('amount'),
            'avg_response_time' => rand(80, 120),
            'error_rate' => rand(1, 3),
            'uptime' => 99.8,
            'cpu_usage' => rand(15, 35),
            'memory_usage' => rand(45, 75)
        ];
    }

    private function getAuditStatistics(): array
    {
        return [
            'total_events' => DB::table('audit_logs')->count(),
            'events_today' => DB::table('audit_logs')->whereDate('created_at', today())->count(),
            'security_alerts' => DB::table('security_events')->where('severity', 'high')->count(),
            'suspicious_transactions' => DB::table('transactions')
                ->where('created_at', '>=', today())
                ->where('risk_score', '>', 70)
                ->count()
        ];
    }

    private function getDateRange($period): array
    {
        return match($period) {
            'today' => [today(), now()],
            'yesterday' => [today()->subDay(), today()],
            'week' => [now()->subWeek(), now()],
            'month' => [now()->subMonth(), now()],
            'quarter' => [now()->subMonths(3), now()],
            'year' => [now()->subYear(), now()],
            default => [today(), now()]
        };
    }

    private function formatPeriod($period): string
    {
        return match($period) {
            'today' => 'Ø§Ù…Ø±ÙˆØ²',
            'yesterday' => 'Ø¯ÛŒØ±ÙˆØ²',
            'week' => 'Ù‡ÙØªÙ‡ Ú¯Ø°Ø´ØªÙ‡',
            'month' => 'Ù…Ø§Ù‡ Ú¯Ø°Ø´ØªÙ‡',
            'quarter' => 'Ø³Ù‡ Ù…Ø§Ù‡Ù‡ Ú¯Ø°Ø´ØªÙ‡',
            'year' => 'Ø³Ø§Ù„ Ú¯Ø°Ø´ØªÙ‡',
            default => 'Ø§Ù…Ø±ÙˆØ²'
        ];
    }

    private function formatBytes($bytes, $precision = 2): string
    {
        $units = ['B', 'KB', 'MB', 'GB', 'TB'];
        
        for ($i = 0; $bytes > 1024 && $i < count($units) - 1; $i++) {
            $bytes /= 1024;
        }
        
        return round($bytes, $precision) . ' ' . $units[$i];
    }

    private function showAuditHelp($chatId): void
    {
        $message = "ğŸ“Š **Ø±Ø§Ù‡Ù†Ù…Ø§ÛŒ Ø³ÛŒØ³ØªÙ… Ú¯Ø²Ø§Ø±Ø´â€ŒÚ¯ÛŒØ±ÛŒ**\n\n";
        
        $message .= "ğŸ–¥ï¸ **Ú¯Ø²Ø§Ø±Ø´â€ŒÙ‡Ø§ÛŒ Ø³ÛŒØ³ØªÙ…ÛŒ:**\n";
        $message .= "â€¢ /reports system - Ú¯Ø²Ø§Ø±Ø´ Ú©Ù„ÛŒ Ø³ÛŒØ³ØªÙ…\n";
        $message .= "â€¢ /reports users - Ú¯Ø²Ø§Ø±Ø´ Ú©Ø§Ø±Ø¨Ø±Ø§Ù†\n";
        $message .= "â€¢ /reports activity - Ú¯Ø²Ø§Ø±Ø´ ÙØ¹Ø§Ù„ÛŒØªâ€ŒÙ‡Ø§\n\n";
        
        $message .= "ğŸ”’ **Ú¯Ø²Ø§Ø±Ø´â€ŒÙ‡Ø§ÛŒ Ø§Ù…Ù†ÛŒØªÛŒ:**\n";
        $message .= "â€¢ /reports security - Ú¯Ø²Ø§Ø±Ø´ Ø§Ù…Ù†ÛŒØªÛŒ\n";
        $message .= "â€¢ /reports compliance - Ú¯Ø²Ø§Ø±Ø´ ØªØ·Ø§Ø¨Ù‚\n\n";
        
        $message .= "ğŸ’° **Ú¯Ø²Ø§Ø±Ø´â€ŒÙ‡Ø§ÛŒ Ù…Ø§Ù„ÛŒ:**\n";
        $message .= "â€¢ /reports financial - Ú¯Ø²Ø§Ø±Ø´ Ù…Ø§Ù„ÛŒ\n";
        $message .= "â€¢ /reports performance - Ú¯Ø²Ø§Ø±Ø´ Ø¹Ù…Ù„Ú©Ø±Ø¯\n\n";
        
        $message .= "ğŸ› ï¸ **Ø§Ø¨Ø²Ø§Ø±Ù‡Ø§ÛŒ Ù¾ÛŒØ´Ø±ÙØªÙ‡:**\n";
        $message .= "â€¢ /reports custom - Ú¯Ø²Ø§Ø±Ø´ Ø³ÙØ§Ø±Ø´ÛŒ\n";
        $message .= "â€¢ /reports export - Ø®Ø±ÙˆØ¬ÛŒ Ú¯Ø²Ø§Ø±Ø´â€ŒÙ‡Ø§\n";
        $message .= "â€¢ /reports schedule - Ø²Ù…Ø§Ù†â€ŒØ¨Ù†Ø¯ÛŒ Ø®ÙˆØ¯Ú©Ø§Ø±\n\n";
        
        $message .= "â„¹ï¸ Ø¨Ø±Ø§ÛŒ Ø¯Ø±ÛŒØ§ÙØª Ø¯Ø§Ø´Ø¨ÙˆØ±Ø¯ Ú©Ø§Ù…Ù„ Ø§Ø² /reports Ø§Ø³ØªÙØ§Ø¯Ù‡ Ú©Ù†ÛŒØ¯";

        $this->sendMessage($chatId, $message, null, 'Markdown');
    }
    
    /**
     * Send message to Telegram chat
     */
    private function sendMessage($chatId, $message)
    {
        try {
            $botToken = env('TELEGRAM_BOT_TOKEN');
            $url = "https://api.telegram.org/bot{$botToken}/sendMessage";
            
            $data = [
                'chat_id' => $chatId,
                'text' => $message,
                'parse_mode' => 'HTML'
            ];
            
            $context = stream_context_create([
                'http' => [
                    'method' => 'POST',
                    'header' => "Content-Type: application/x-www-form-urlencoded\r\n",
                    'content' => http_build_query($data),
                    'proxy' => 'tcp://127.0.0.1:1090'
                ]
            ]);
            
            $response = file_get_contents($url, false, $context);
            Log::info('Message sent to Telegram', ['chat_id' => $chatId, 'response' => $response]);
            
        } catch (\Exception $e) {
            Log::error('Failed to send Telegram message', [
                'chat_id' => $chatId,
                'error' => $e->getMessage()
            ]);
        }
    }
    
    /**
     * Set webhook URL for the bot
     */
    public function setWebhook()
    {
        $webhookUrl = route('telegram.webhook');
        $response = $this->apiClient->setWebhook($webhookUrl);
        
        if ($response->isSuccess()) {
            return response()->json([
                'success' => true,
                'message' => 'ÙˆØ¨â€ŒÙ‡ÙˆÚ© Ø¨Ø§ Ù…ÙˆÙÙ‚ÛŒØª ØªÙ†Ø¸ÛŒÙ… Ø´Ø¯',
                'webhook_url' => $webhookUrl,
                'result' => $response->getData()
            ]);
        }
        
        return response()->json([
            'success' => false,
            'message' => 'Ø®Ø·Ø§ Ø¯Ø± ØªÙ†Ø¸ÛŒÙ… ÙˆØ¨â€ŒÙ‡ÙˆÚ©',
            'error' => $response->getError()
        ], 500);
    }
    
    /**
     * Get webhook info
     */
    public function getWebhookInfo()
    {
        $response = $this->apiClient->getWebhookInfo();
        
        if ($response->isSuccess()) {
            return response()->json([
                'success' => true,
                'result' => $response->getData()
            ]);
        }
        
        return response()->json([
            'success' => false,
            'error' => 'Ø®Ø·Ø§ Ø¯Ø± Ø¯Ø±ÛŒØ§ÙØª Ø§Ø·Ù„Ø§Ø¹Ø§Øª ÙˆØ¨â€ŒÙ‡ÙˆÚ©',
            'message' => $response->getError()
        ], 500);
    }
    
    /**
     * Delete webhook
     */
    public function deleteWebhook()
    {
        $response = $this->apiClient->deleteWebhook();
        
        if ($response->isSuccess()) {
            return response()->json([
                'success' => true,
                'message' => 'ÙˆØ¨â€ŒÙ‡ÙˆÚ© Ø¨Ø§ Ù…ÙˆÙÙ‚ÛŒØª Ø­Ø°Ù Ø´Ø¯',
                'result' => $response->getData()
            ]);
        }
        
        return response()->json([
            'success' => false,
            'message' => 'Ø®Ø·Ø§ Ø¯Ø± Ø­Ø°Ù ÙˆØ¨â€ŒÙ‡ÙˆÚ©',
            'error' => $response->getError()
        ], 500);
    }
    
    /**
     * Get bot info
     */
    public function getBotInfo()
    {
        $response = $this->apiClient->getMe();
        
        if ($response->isSuccess()) {
            return response()->json([
                'success' => true,
                'result' => $response->getData()
            ]);
        }
        
        return response()->json([
            'success' => false,
            'error' => 'Ø®Ø·Ø§ Ø¯Ø± Ø¯Ø±ÛŒØ§ÙØª Ø§Ø·Ù„Ø§Ø¹Ø§Øª Ø±Ø¨Ø§Øª',
            'message' => $response->getError()
        ], 500);
    }
    
    /**
     * Test bot by sending a message to admins
     */
    public function testBot()
    {
        // Test connection first
        $botInfoResponse = $this->apiClient->getMe();
        if ($botInfoResponse->isError()) {
            return response()->json([
                'success' => false,
                'error' => 'Ø§Ø±ØªØ¨Ø§Ø· Ø¨Ø§ Ø±Ø¨Ø§Øª ØªÙ„Ú¯Ø±Ø§Ù… Ø¨Ø±Ù‚Ø±Ø§Ø± Ù†Ø´Ø¯',
                'details' => $botInfoResponse->getError()
            ], 500);
        }

        $adminChatIds = explode(',', env('TELEGRAM_ADMIN_CHAT_IDS', ''));
        
        if (empty($adminChatIds[0])) {
            return response()->json([
                'success' => false,
                'error' => 'Ø´Ù†Ø§Ø³Ù‡ Ú†Øª Ù…Ø¯ÛŒØ±Ø§Ù† Ù…Ø´Ø®Øµ Ù†Ø´Ø¯Ù‡. Ù„Ø·ÙØ§Ù‹ TELEGRAM_ADMIN_CHAT_IDS Ø±Ø§ Ø¯Ø± .env ØªÙ†Ø¸ÛŒÙ… Ú©Ù†ÛŒØ¯'
            ], 400);
        }
        
        $results = [];
        
        foreach ($adminChatIds as $chatId) {
            $chatId = trim($chatId);
            if (!$chatId) continue;
            
            try {
                $message = "ğŸ¤– ØªØ³Øª Ø±Ø¨Ø§Øª Ù¾ÛŒØ´Ø®ÙˆØ§Ù†Ú©\n";
                $message .= "âœ… Ø§Ø±ØªØ¨Ø§Ø· Ø¨Ø±Ù‚Ø±Ø§Ø± Ø§Ø³Øª!\n";
                $message .= "ğŸ“… Ø²Ù…Ø§Ù†: " . \Verta::now()->format('Y/m/d H:i:s') . "\n";
                $message .= "ğŸŒ Ø³Ø±ÙˆØ±: " . request()->getHost() . "\n\n";
                $message .= "ğŸš€ Ø±Ø¨Ø§Øª Ø¢Ù…Ø§Ø¯Ù‡ Ø¯Ø±ÛŒØ§ÙØª Ù¾ÛŒØ§Ù… Ø§Ø³Øª!";
                
                $response = $this->apiClient->sendMessage($chatId, $message);
                
                $results[] = [
                    'chat_id' => $chatId,
                    'success' => $response->isSuccess(),
                    'result' => $response->getData(),
                    'error' => $response->isError() ? $response->getError() : null
                ];
                
            } catch (\Exception $e) {
                $results[] = [
                    'chat_id' => $chatId,
                    'success' => false,
                    'error' => $e->getMessage()
                ];
            }
        }
        
        return response()->json([
            'success' => true,
            'message' => 'Ù¾ÛŒØ§Ù… ØªØ³Øª Ø¨Ø±Ø§ÛŒ Ù…Ø¯ÛŒØ±Ø§Ù† Ø§Ø±Ø³Ø§Ù„ Ø´Ø¯',
            'results' => $results
        ]);
    }
}