# üèóÔ∏è Architecture Overview - Pishkhanak Platform

> **Multi-layered financial services platform with automated inquiry processing and AI-enhanced content generation**

## üìã Table of Contents
- [Core Architecture](#core-architecture)
- [Application Layers](#application-layers)  
- [Data Architecture](#data-architecture)
- [Service Architecture](#service-architecture)
- [Bot Ecosystem](#bot-ecosystem)
- [Security Architecture](#security-architecture)
- [Performance & Scalability](#performance--scalability)

---

## üèõÔ∏è Core Architecture

### **System Design Philosophy**
```
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ                 PRESENTATION LAYER                      ‚îÇ
‚îú‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¨‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¨‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î§
‚îÇ   Web Interface ‚îÇ   Admin Panel   ‚îÇ   Telegram Bots     ‚îÇ
‚îÇ   (Livewire)    ‚îÇ   (Filament)    ‚îÇ   (Bot API)         ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¥‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¥‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
                         ‚îÇ
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ                 APPLICATION LAYER                       ‚îÇ
‚îú‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¨‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¨‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î§
‚îÇ   Controllers   ‚îÇ   Middleware    ‚îÇ   Form Requests     ‚îÇ
‚îÇ   (Web/API)     ‚îÇ   (Security)    ‚îÇ   (Validation)      ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¥‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¥‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
                         ‚îÇ
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ                  BUSINESS LAYER                         ‚îÇ
‚îú‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¨‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¨‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î§
‚îÇ   Services      ‚îÇ   Jobs & Events ‚îÇ   Rule Engine       ‚îÇ
‚îÇ   (Logic)       ‚îÇ   (Processing)  ‚îÇ   (Validation)      ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¥‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¥‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
                         ‚îÇ
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ                   DATA LAYER                            ‚îÇ
‚îú‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¨‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¨‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î§
‚îÇ   Models        ‚îÇ   Repositories  ‚îÇ   Cache Layer       ‚îÇ
‚îÇ   (Eloquent)    ‚îÇ   (Data Access) ‚îÇ   (Redis)           ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¥‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¥‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
                         ‚îÇ
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ                INFRASTRUCTURE LAYER                     ‚îÇ
‚îú‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¨‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¨‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î§
‚îÇ   Database      ‚îÇ   Queue System  ‚îÇ   Bot Services      ‚îÇ
‚îÇ   (PostgreSQL)  ‚îÇ   (Redis)       ‚îÇ   (Node.js/Python) ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¥‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¥‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
```

### **Technology Stack Rationale**

#### **Backend Framework: Laravel 11**
- **Modern PHP** (8.1-8.4 support) with latest language features
- **Robust Ecosystem** - Extensive package support for financial services
- **Persian Support** - Built-in localization and Verta calendar integration
- **Enterprise Features** - Queue system, event broadcasting, comprehensive ORM

#### **Database: PostgreSQL + Redis**
- **PostgreSQL** - ACID compliance for financial data integrity
- **Redis** - High-performance caching and session management
- **Queue Processing** - Redis-backed job system for background tasks

#### **Frontend Architecture**
- **Livewire 3** - Reactive components without complex JavaScript
- **Blade Templates** - Server-side rendering with component reusability  
- **TailwindCSS** - Utility-first styling with Persian RTL support
- **Alpine.js** - Minimal client-side interactions

---

## üîß Application Layers

### **Controller Architecture**
```php
app/Http/Controllers/
‚îú‚îÄ‚îÄ Web/                     # Frontend controllers
‚îÇ   ‚îú‚îÄ‚îÄ PageController.php:19        # Home, about, contact
‚îÇ   ‚îú‚îÄ‚îÄ ServiceController.php        # Service display and forms
‚îÇ   ‚îî‚îÄ‚îÄ UserController.php           # User dashboard and profile
‚îú‚îÄ‚îÄ Services/                # Specialized service controllers  
‚îÇ   ‚îú‚îÄ‚îÄ LocalApiController.php:40    # Bot communication
‚îÇ   ‚îî‚îÄ‚îÄ LoanInquiryController.php    # Banking service integration
‚îú‚îÄ‚îÄ PaymentController.php:15         # Payment gateway handling
‚îú‚îÄ‚îÄ WebhookController.php           # External service webhooks
‚îî‚îÄ‚îÄ TelegramBotController.php:23    # Multi-bot management
```

#### **Key Controller Patterns**
- **Form Request Validation** - Centralized input validation and sanitization
- **Service Injection** - Business logic delegated to service layer
- **Response Formatting** - Consistent API responses across endpoints
- **Error Handling** - Graceful degradation with user-friendly messages

### **Service Layer Architecture**
```php
app/Services/
‚îú‚îÄ‚îÄ Payment/                 # Financial processing
‚îÇ   ‚îú‚îÄ‚îÄ PaymentGatewayManager.php   # Multi-gateway orchestration
‚îÇ   ‚îú‚îÄ‚îÄ JibitService.php            # Jibit gateway integration
‚îÇ   ‚îî‚îÄ‚îÄ CurrencyService.php         # Multi-currency support
‚îú‚îÄ‚îÄ AI/                     # Content generation
‚îÇ   ‚îú‚îÄ‚îÄ OpenAIService.php:25        # GPT integration
‚îÇ   ‚îú‚îÄ‚îÄ ImageGenerationService.php  # Midjourney/DALL-E
‚îÇ   ‚îî‚îÄ‚îÄ AiContentService.php        # Content pipeline management
‚îú‚îÄ‚îÄ Communication/          # External messaging
‚îÇ   ‚îú‚îÄ‚îÄ SmsService.php:89           # Finnotech SMS integration
‚îÇ   ‚îî‚îÄ‚îÄ TelegramBotService.php      # Multi-bot coordination
‚îî‚îÄ‚îÄ Integration/            # External APIs
    ‚îú‚îÄ‚îÄ FinnotechTokenMapper.php    # API token management
    ‚îî‚îÄ‚îÄ ServiceFormAnalyzer.php     # Dynamic form processing
```

#### **Service Design Principles**
- **Single Responsibility** - Each service handles one business domain
- **Interface Segregation** - Small, focused contracts for testability
- **Dependency Injection** - Loose coupling via Laravel's container
- **Error Boundary** - Service-level exception handling and logging

---

## üíæ Data Architecture

### **Model Relationships**
```php
Core Business Models:
‚îú‚îÄ‚îÄ User (46 relationships)         # Central user entity
‚îú‚îÄ‚îÄ Service (12 relationships)      # Service catalog and pricing
‚îú‚îÄ‚îÄ Transaction (8 relationships)   # Financial transaction tracking
‚îú‚îÄ‚îÄ Ticket (6 relationships)        # Support system integration
‚îî‚îÄ‚îÄ AiContent (4 relationships)     # Generated content management

Payment System:
‚îú‚îÄ‚îÄ GatewayTransaction              # Multi-gateway transaction log
‚îú‚îÄ‚îÄ PaymentGateway                  # Gateway configuration and status  
‚îú‚îÄ‚îÄ Currency                        # Multi-currency support
‚îî‚îÄ‚îÄ Wallet (Bavix integration)     # User wallet management

Support System:
‚îú‚îÄ‚îÄ Ticket ‚Üí TicketCategory         # Hierarchical ticket organization
‚îú‚îÄ‚îÄ TicketMessage ‚Üí User            # Multi-user conversation threads
‚îú‚îÄ‚îÄ TicketAttachment               # File upload support
‚îî‚îÄ‚îÄ TicketActivity                 # Audit trail and status tracking
```

#### **Database Design Patterns**
- **Soft Deletes** - Reversible data removal for audit compliance
- **UUID Primary Keys** - Distributed system compatibility  
- **Polymorphic Relations** - Flexible content and attachment systems
- **Index Strategy** - Query optimization for high-traffic endpoints

### **Data Flow Architecture**
```mermaid
sequenceDiagram
    participant U as User
    participant W as Web Interface  
    participant S as Service Layer
    participant Q as Queue System
    participant B as Bot Service
    participant E as External API
    participant D as Database

    U->>W: Submit Service Request
    W->>S: Validate & Process Request
    S->>D: Store Request Record
    S->>Q: Queue Background Job
    Q->>B: Execute Service Provider
    B->>E: API Call to External Service
    E->>B: Response Data
    B->>D: Store Service Result
    D->>W: Notify User (WebSocket/Polling)
    W->>U: Display Results
```

---

## ‚öôÔ∏è Service Architecture

### **Multi-Provider Pattern**
```php
interface ServiceProviderInterface {
    public function processInquiry(array $data): ServiceResult;
    public function isAvailable(): bool;
    public function getProviderName(): string;
}

class CreditScoreService {
    private array $providers = [
        'rade' => RadeProvider::class,
        'nics24' => Nics24Provider::class,
        'baman24' => Baman24Provider::class
    ];
    
    public function processWithFailover(array $data): ServiceResult {
        foreach ($this->providers as $name => $provider) {
            if ($provider->isAvailable()) {
                return $provider->processInquiry($data);
            }
        }
        throw new NoProvidersAvailableException();
    }
}
```

#### **Service Processing Flow**
1. **Request Validation** - Input sanitization and business rule validation
2. **Provider Selection** - Automatic failover between available providers  
3. **Background Processing** - Queue-based execution for scalability
4. **Result Caching** - Redis-based caching to prevent duplicate API calls
5. **User Notification** - Multi-channel notification (SMS, Telegram, Web)

### **Payment Gateway Architecture**
```php
abstract class PaymentGateway {
    abstract public function createTransaction(array $data): string;
    abstract public function verifyTransaction(string $transactionId): bool;
    abstract public function refundTransaction(string $transactionId): bool;
}

class PaymentGatewayManager {
    public function processPayment(PaymentRequest $request): PaymentResult {
        $gateway = $this->selectGateway($request->amount, $request->currency);
        return $gateway->createTransaction($request->toArray());
    }
    
    private function selectGateway(int $amount, string $currency): PaymentGateway {
        // Load balancing and failover logic
        // Returns: JibitGateway, SepGateway, or SamanGateway
    }
}
```

---

## ü§ñ Bot Ecosystem

### **inquiry-provider Service** (Node.js)
**Location**: `bots/inquiry-provider/`
**Purpose**: Web scraping and external API integration
**Architecture**:
```javascript
// Core Components
‚îú‚îÄ‚îÄ localApiServer.js          # Express.js API server (port 9999)
‚îú‚îÄ‚îÄ services/                  # Provider implementations
‚îÇ   ‚îú‚îÄ‚îÄ creditScoreRating/     # Credit bureau integrations  
‚îÇ   ‚îú‚îÄ‚îÄ chequeInquiry/         # Bank check verification
‚îÇ   ‚îî‚îÄ‚îÄ loanInquiry/           # Loan eligibility checking
‚îú‚îÄ‚îÄ utils/
‚îÇ   ‚îú‚îÄ‚îÄ captchaSolver.js       # Integration with Python ML service
‚îÇ   ‚îú‚îÄ‚îÄ proxyManager.js        # IP rotation for scraping
‚îÇ   ‚îî‚îÄ‚îÄ requestLocks.js        # Prevent duplicate processing
‚îî‚îÄ‚îÄ ecosystem.config.mjs       # PM2 configuration
```

**Key Features**:
- **Playwright + Puppeteer** - Dual browser automation for reliability
- **CAPTCHA Solving** - Integration with Persian digits ML model
- **Request Deduplication** - Prevents concurrent identical requests
- **Proxy Support** - IP rotation for high-volume scraping
- **Error Recovery** - Automatic retry with exponential backoff

### **persian-digits-captcha-solver Service** (Python)
**Location**: `bots/persian-digits-captcha-solver/`
**Purpose**: ML-based Persian CAPTCHA recognition
**Architecture**:
```python
‚îú‚îÄ‚îÄ captcha_api_production.py   # Flask API server
‚îú‚îÄ‚îÄ persian_digit.keras         # Trained Keras model
‚îú‚îÄ‚îÄ predict.py                  # Inference pipeline
‚îú‚îÄ‚îÄ gunicorn.conf.py           # Production WSGI configuration
‚îî‚îÄ‚îÄ requirements.txt           # Python dependencies
```

**ML Pipeline**:
1. **Image Preprocessing** - Noise reduction, normalization
2. **Digit Segmentation** - Individual character extraction
3. **Model Inference** - CNN-based digit recognition  
4. **Confidence Scoring** - Quality assessment and fallback handling

### **Bot Communication Protocol**
```mermaid
sequenceDiagram
    participant L as Laravel App
    participant N as Node.js Bot
    participant P as Python ML
    participant E as External API

    L->>N: POST /api/service-request
    N->>E: Navigate to target website
    E->>N: Return CAPTCHA challenge
    N->>P: POST /solve-captcha {image_data}  
    P->>N: Return {digits, confidence}
    N->>E: Submit form with CAPTCHA solution
    E->>N: Return service result
    N->>L: Return {status, data, metadata}
```

---

## üîí Security Architecture

### **Authentication & Authorization**
```php
Security Layers:
‚îú‚îÄ‚îÄ OTP Authentication          # SMS-based login via Finnotech
‚îú‚îÄ‚îÄ Session Management          # Redis-backed sessions with rotation
‚îú‚îÄ‚îÄ CSRF Protection            # Laravel's built-in CSRF tokens  
‚îú‚îÄ‚îÄ Rate Limiting              # Per-IP and per-user throttling
‚îú‚îÄ‚îÄ Input Validation           # Iranian-specific validation rules
‚îî‚îÄ‚îÄ API Key Management         # Secure external service integration
```

#### **Iranian-Specific Validation Rules**
```php
app/Rules/
‚îú‚îÄ‚îÄ IranianNationalCode.php    # National ID validation (10-digit)
‚îú‚îÄ‚îÄ IranianMobile.php          # Mobile number format (09xxxxxxxxx)  
‚îú‚îÄ‚îÄ IranianIban.php            # Banking IBAN validation (IR format)
‚îî‚îÄ‚îÄ IranianCardNumber.php      # Bank card number validation (16-digit)
```

### **Data Protection**
- **Field-Level Encryption** - Sensitive data encryption at rest
- **Audit Logging** - Comprehensive activity tracking for compliance
- **Soft Deletion** - Reversible data removal maintaining audit trail
- **Input Sanitization** - XSS and injection attack prevention

### **Infrastructure Security**  
- **Redis Security** - Localhost-only binding, no external access
- **Database Security** - Connection encryption and prepared statements
- **File Upload Security** - Type validation and virus scanning
- **Environment Protection** - Secure credential management

---

## üöÄ Performance & Scalability

### **Caching Strategy**
```php
Cache Layers:
‚îú‚îÄ‚îÄ Application Cache (Redis)   # Query results, computed data
‚îú‚îÄ‚îÄ Session Cache (Redis)       # User sessions and CSRF tokens
‚îú‚îÄ‚îÄ Queue Cache (Redis)         # Background job management  
‚îú‚îÄ‚îÄ HTTP Cache (Browser)        # Static assets and CDN integration
‚îî‚îÄ‚îÄ Service Cache (Memory)      # Provider response caching
```

### **Queue Processing Architecture**
```php
Background Jobs:
‚îú‚îÄ‚îÄ High Priority Queue         # Payment processing, user auth
‚îú‚îÄ‚îÄ Default Queue              # Service requests, notifications  
‚îú‚îÄ‚îÄ Low Priority Queue         # Content generation, maintenance
‚îî‚îÄ‚îÄ Failed Job Handling        # Retry logic and error reporting
```

### **Database Optimization**
- **Query Optimization** - Eager loading, index strategy
- **Connection Pooling** - Efficient database connection management
- **Read Replicas** - Planned for high-traffic scenarios
- **Partitioning Strategy** - Time-based partitioning for transaction logs

### **Monitoring & Observability**
```php
Monitoring Stack:
‚îú‚îÄ‚îÄ Application Logs           # Laravel logs with structured logging
‚îú‚îÄ‚îÄ Queue Monitoring          # Job success/failure tracking  
‚îú‚îÄ‚îÄ Performance Metrics       # Response time, memory usage
‚îú‚îÄ‚îÄ Error Tracking           # Exception aggregation and alerting
‚îî‚îÄ‚îÄ Health Checks            # Service availability monitoring
```

### **Scalability Considerations**
- **Horizontal Scaling** - Load balancer ready architecture
- **Microservice Migration** - Service layer designed for extraction
- **CDN Integration** - Static asset optimization and delivery
- **Database Scaling** - Sharding strategy for user-based partitioning

---

## üîÑ Deployment Architecture

### **Environment Configuration**
```bash
Production Stack:
‚îú‚îÄ‚îÄ Web Server: Nginx (reverse proxy, SSL termination)
‚îú‚îÄ‚îÄ Application: PHP-FPM (Laravel 11)
‚îú‚îÄ‚îÄ Database: PostgreSQL 13+ (primary)
‚îú‚îÄ‚îÄ Cache: Redis 6+ (sessions, cache, queues)
‚îú‚îÄ‚îÄ Process Manager: PM2 (Node.js bot services)
‚îú‚îÄ‚îÄ Queue Worker: Supervisor (Laravel queue processing)
‚îî‚îÄ‚îÄ SSL: Let's Encrypt (automatic renewal)
```

### **Backup & Recovery**
- **Database Backups** - Automated daily PostgreSQL dumps
- **File Backups** - Media files and configuration backup
- **Code Versioning** - Git-based deployment with rollback capability
- **Configuration Management** - Environment-specific configuration files

---

*üìÖ Last Updated: 2025-09-08 | üìñ Architecture v1.0 | üîÑ Generated via SuperClaude /sc:index*